:PROPERTIES:
:ID: 2132af63-21a0-4ad0-9773-603d00838572
:END:
#+title: Domain Type Repository CRUD Operations Facet
#+author: Marco Craveiro
#+options: <:nil c:nil todo:nil ^:nil d:nil date:nil author:nil toc:nil title:t
#+startup: inlineimages
#+export_exclude_tags: noexport

This facet provides instructions on how to create repository with CRUD operations for a domain type.

Create the repository class:

1. Header: =projects/COMPONENT/include/COMPONENT/repository/TYPE_NAME_repository.hpp=
2. Implementation: =projects/COMPONENT/src/repository/TYPE_NAME_repository.cpp=

The repository should provide:

- Constructor accepting a =context= parameter
- =sql()= method returning the table creation SQL
- Write methods (with *upsert semantics* - creates or updates):
  - =void write(const domain::TYPE_NAME& obj)=
  - =void write(const std::vector<domain::TYPE_NAME>& objs)=
- Read methods:
  - =std::vector<domain::TYPE_NAME> read_latest()=
  - =std::vector<domain::TYPE_NAME> read_latest(const KEY_TYPE& key)=
  - =std::vector<domain::TYPE_NAME> read_latest_since(std::chrono::system_clock::time_point modified_since)=
  - =std::vector<domain::TYPE_NAME> read_all()=
  - =std::vector<domain::TYPE_NAME> read_all(const KEY_TYPE& key)=
  - =std::vector<domain::TYPE_NAME> read_at_timepoint(const std::string& timestamp)=
  - =std::vector<domain::TYPE_NAME> read_at_timepoint(const std::string& timestamp, const KEY_TYPE& key)=

Implementation details:

- Use sqlgen for database operations
- Use the mapper to convert between domain and entity types
- Include proper error handling with =ensure_success()=
- Include logging using =BOOST_LOG_SEV=
- Follow the pattern in
  =projects/ores.accounts/src/repository/account_repository.cpp=

** Implementing read_latest_since for incremental loading

The =read_latest_since= method supports incremental cache loading by returning
only items modified after a given timestamp. This method requires a PostgreSQL
function.

*** PostgreSQL function

Add to the table's schema file (=projects/ores.sql/schema/TABLE_NAME_create.sql=):

#+begin_src sql
-- Returns latest items modified since a given timestamp.
-- Used for incremental cache loading.
create or replace function ores.TABLE_NAME_read_since_fn(
    p_modified_since timestamptz
)
returns table (
    -- List all columns matching the table schema
    column1 type1,
    column2 type2,
    -- ...
    valid_from timestamptz,
    valid_to timestamptz
) as $$
begin
    return query
    select
        t.column1,
        t.column2,
        -- ...
        t.valid_from,
        t.valid_to
    from ores.TABLE_NAME_tbl t
    where t.valid_to = ores.utility_infinity_timestamp_fn()
    and t.valid_from >= p_modified_since
    order by t.valid_from desc;
end;
$$ language plpgsql stable;
#+end_src

*** Repository implementation

#+begin_src cpp
std::vector<domain::TYPE_NAME>
TYPE_NAME_repository::read_latest_since(context ctx,
    std::chrono::system_clock::time_point modified_since) {

    // Format timestamp for SQL function call (thread-safe)
    const auto timestamp_str =
        platform::time::datetime::format_time_point_utc(modified_since);

    BOOST_LOG_SEV(lg(), debug) << "Reading latest items modified since: "
                               << timestamp_str;

    // Call PostgreSQL function
    std::ostringstream sql;
    sql << "SELECT * FROM ores.TABLE_NAME_read_since_fn('"
        << timestamp_str << "'::timestamptz)";

    auto rows = execute_raw_multi_column_query(ctx, sql.str(), lg(),
        "Reading latest items since timestamp");

    // Convert raw results to domain objects using entity and mapper
    std::vector<domain::TYPE_NAME> results;
    results.reserve(rows.size());

    for (const auto& row : rows) {
        TYPE_NAME_entity entity;
        // Map row columns to entity fields...
        results.push_back(TYPE_NAME_mapper::map(entity));
    }

    BOOST_LOG_SEV(lg(), debug) << "Found " << results.size()
                               << " items modified since timestamp";
    return results;
}
#+end_src

*** Required header include

Add the platform datetime utility for thread-safe timestamp formatting:

#+begin_src cpp
#include "ores.platform/time/datetime.hpp"
#+end_src

See =projects/ores.assets/src/repository/image_repository.cpp= for a reference
implementation.
