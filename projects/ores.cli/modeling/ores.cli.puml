' -*- mode: plantuml; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-
'
' Copyright (C) 2025 Marco Craveiro <marco.craveiro@gmail.com>
'
' This program is free software; you can redistribute it and/or modify it under
' the terms of the GNU General Public License as published by the Free Software
' Foundation; either version 3 of the License, or (at your option) any later
' version.
'
' This program is distributed in the hope that it will be useful, but WITHOUT
'  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
' FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
'
' You should have received a copy of the GNU General Public License along with
' GNU Emacs; see the file COPYING. If not, write to the Free Software
' Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
@startuml
!pragma layout smetana

title ores.cli Component

set namespaceSeparator ::

namespace ores #F2F2F2 {
    note "Console tool for ORE Studio." as ores_cli_note
    cli --- ores_cli_note
    namespace cli #F2F2F2 {
        note "Configuration related classes and structures." as ores_cli_config_note
        config --- ores_cli_config_note
        namespace config #F2F2F2 {
            '
            ' Layout groupings
            '

            ' Group: Enums
            together {
                enum entity
                enum format
            }

            ' Group: Options structs
            together {
                class import_options
                class export_options
                class delete_options
                class add_options
                class options
            }

            ' Group: Parsers
            together {
                class parser
                class parser_helpers
                class parser_exception
            }

            ' Stack vertically
            entity -[hidden]down- format
            import_options -[hidden]down- export_options
            export_options -[hidden]down- delete_options
            delete_options -[hidden]down- add_options
            add_options -[hidden]down- options
            parser -[hidden]down- parser_helpers
            parser_helpers -[hidden]down- parser_exception

            '
            ' Class definitions
            '

            enum entity #F7E5FF {
                currencies
                accounts
                feature_flags
            }

            note top of entity
            List of available entities to target.
            end note

            enum format #F7E5FF {
                json
                xml
                csv
            }

            note top of format
            List of available formats.
            end note

            class import_options #F7E5FF {
                +{field} target_entity entity
                +{field} targets std::vector<std::filesystem::path>
            }

            note top of import_options
            Configuration related to importing data into the system.

            Fields:

            - target_entity: Which entity to target.
            - targets: Target files containing import data. Format is inferred from extension.
            end note

            import_options o-- ores::cli::config::entity

            class export_options #F7E5FF {
                +{field} target_entity entity
                +{field} as_of std::string
                +{field} key std::string
                +{field} all_versions bool
                +{field} target_format format
            }

            note top of export_options
            Configuration related to exporting data into a supported export format.

            Fields:

            - target_entity: Which entity to export.
            - as_of: Timepoint to use for the reading. If empty, use latest.
            - key: Key to filter by, if any.
            - all_versions: If true, output all versions of this entity.
            - target_format: Format to use for the export.
            end note

            export_options o-- ores::cli::config::entity
            export_options o-- ores::cli::config::format

            class delete_options #F7E5FF {
                +{field} target_entity entity
                +{field} key std::string
            }

            note top of delete_options
            Configuration related to deleting entities.

            Fields:

            - target_entity: Which entity to delete.
            - key: Key to identify the entity.
            end note

            delete_options o-- ores::cli::config::entity

            class add_options #F7E5FF {
                +{field} target_entity entity
                +{field} modified_by std::string
                +{field} iso_code std::optional<std::string>
                +{field} name std::optional<std::string>
                +{field} username std::optional<std::string>
                +{field} email std::optional<std::string>
                +{field} password std::optional<std::string>
                +{field} is_admin std::optional<bool>
                +{field} flag_name std::optional<std::string>
                +{field} description std::optional<std::string>
                +{field} enabled std::optional<bool>
            }

            note top of add_options
            Configuration related to adding new entities.

            Fields:

            - target_entity: Which entity to add.
            - modified_by: Username of the modifier.
            - Entity-specific fields are optional based on target_entity.
            end note

            add_options o-- ores::cli::config::entity

            class options #F7E5FF {
                +{field} logging std::optional<ores::utility::log::logging_options>
                +{field} importing std::optional<import_options>
                +{field} exporting std::optional<export_options>
                +{field} deleting std::optional<delete_options>
                +{field} adding std::optional<add_options>
                +{field} database ores::utility::database::database_options
            }

            note top of options
            All of the configuration options required by the command line application.

            Fields:

            - logging: Configuration options related to logging, if any.
            - importing: Configuration related to importing of data, if any.
            - exporting: Configuration related to exporting of data, if any.
            - deleting: Configuration related to deleting entities, if any.
            - adding: Configuration related to adding entities, if any.
            - database: Database connection configuration.
            end note

            options o-- ores::cli::config::import_options
            options o-- ores::cli::config::export_options
            options o-- ores::cli::config::delete_options
            options o-- ores::cli::config::add_options

            class parser #ECECEC {
                +parse(arguments: const std::vector<std::string>&, info: std::ostream&, error: std::ostream&) const: std::optional<options>
            }

            note top of parser
            Command-line parser coordinator that delegates to entity-specific parsers.

            Note on logging: we are NOT logging any of the exceptions to the log in this
            class. This is by design. The logger is only initialised after the options
            have been parsed; were we to log prior to this, we would dump all the
            messages into the cli. The output is very confusing users that are accustomed
            to normal cli applications.
            end note

            parser ..> ores::cli::config::options : returns
            parser ..> ores::cli::config::entity_parsers::currencies_parser : delegates
            parser ..> ores::cli::config::entity_parsers::accounts_parser : delegates
            parser ..> ores::cli::config::entity_parsers::feature_flags_parser : delegates

            note "Entity-specific parser implementations." as entity_parsers_note
            entity_parsers --- entity_parsers_note
            namespace entity_parsers #F2F2F2 {
                class currencies_parser #ECECEC {
                    +{static} handle_currencies_command(has_help: bool, po: const parsed_options&, info: std::ostream&, vm: variables_map&): std::optional<options>
                }

                note top of currencies_parser
                Handles parsing of currencies entity commands (import, export, list, delete, add).
                end note

                currencies_parser ..> ores::cli::config::options : returns

                class accounts_parser #ECECEC {
                    +{static} handle_accounts_command(has_help: bool, po: const parsed_options&, info: std::ostream&, vm: variables_map&): std::optional<options>
                }

                note top of accounts_parser
                Handles parsing of accounts entity commands (list, delete, add).
                end note

                accounts_parser ..> ores::cli::config::options : returns

                class feature_flags_parser #ECECEC {
                    +{static} handle_feature_flags_command(has_help: bool, po: const parsed_options&, info: std::ostream&, vm: variables_map&): std::optional<options>
                }

                note top of feature_flags_parser
                Handles parsing of feature_flags entity commands (list, delete, add).
                end note

                feature_flags_parser ..> ores::cli::config::options : returns
            }

            note "Shared parser utility functions." as parser_helpers_note
            parser_helpers --- parser_helpers_note
            class parser_helpers #ECECEC {
                +{static} print_help_header(s: std::ostream&): void
                +{static} print_help_command(command_name: const std::string&, od: const options_description&, info: std::ostream&): void
                +{static} add_common_options(base: options_description): options_description
                +{static} validate_operation(entity_name: const std::string&, operation: const std::string&, allowed_operations: const std::vector<std::string>&): void
                +{static} print_entity_help(entity_name: const std::string&, description: const std::string&, operations: const std::vector<std::pair<std::string, std::string>>&, info: std::ostream&): void
                +{static} make_export_options_description(): options_description
                +{static} make_delete_options_description(): options_description
                +{static} read_format(vm: const variables_map&): format
                +{static} read_export_options(vm: const variables_map&, e: entity): export_options
                +{static} read_delete_options(vm: const variables_map&, e: entity): delete_options
            }

            note top of parser_helpers
            Shared utility functions used by all entity parsers.

            Includes common option descriptions and read functions
            for export and delete operations to reduce code duplication.
            end note

            parser_helpers ..> ores::cli::config::export_options : creates
            parser_helpers ..> ores::cli::config::delete_options : creates
            parser_helpers ..> ores::cli::config::format : uses
            parser_helpers ..> ores::cli::config::entity : uses

            currencies_parser ..> parser_helpers : uses
            accounts_parser ..> parser_helpers : uses
            feature_flags_parser ..> parser_helpers : uses

            class parser_exception <<exception>> #D6B19F {
                +parser_exception(message: std::string_view)
                +what() const noexcept: const char*
                -{field} message_ std::string
            }

            note top of parser_exception
            A fatal error has occurred during option parsing.
            end note
        }

        note "Application hosting and execution classes." as ores_cli_app_note
        app --- ores_cli_app_note
        namespace app #F2F2F2 {
            '
            ' Layout groupings
            '

            together {
                class application
                class host
                class application_exception
            }

            application -[hidden]down- host
            host -[hidden]down- application_exception

            '
            ' Class definitions
            '

            class application #ECECEC {
                +application(output_stream: std::ostream&, db_opts: const std::optional<utility::database::database_options>&)
                +run(cfg: const config::options&) const: void
                -{static} lg(): auto&
                -{static} make_context(db_opts: const std::optional<utility::database::database_options>&): utility::repository::context
                -import_currencies(files: const std::vector<std::filesystem::path>) const: void
                -import_data(ocfg: const std::optional<config::import_options>&) const: void
                -export_currencies(cfg: const config::export_options&) const: void
                -export_data(ocfg: const std::optional<config::export_options>&) const: void
                -{field} context_ utility::repository::context
                -{field} output_stream_ std::ostream&
            }

            note top of application
            Entry point for the ores command line application.
            end note

            application ..> ores::cli::config::options : uses

            class host #ECECEC {
                +{static} execute(args: const std::vector<std::string>&, std_output: std::ostream&, error_output: std::ostream&): int
                -{static} lg(): auto&
            }

            note top of host
            Provides hosting services to the application.
            end note

            host ..> ores::cli::app::application : creates

            class application_exception <<exception>> #D6B19F {
                +application_exception(message: std::string_view)
                +what() const noexcept: const char*
                -{field} message_ std::string
            }

            note top of application_exception
            A fatal error has occurred whilst the application was running.
            end note
        }

        namespace tests #F2F2F2 {
            '
            ' Layout groupings
            '

            together {
                class app_application_import_tests
                class parser_tests
            }

            app_application_import_tests -[hidden]down- parser_tests

            '
            ' Class definitions
            '

            class app_application_import_tests <<test suite>> #C5E1A5 {
                +import_currencies_from_test_file() void
                +import_currencies_from_multiple_files() void
                +import_and_query_specific_currency() void
                +import_currencies_with_empty_database() void
                +import_currencies_verify_all_fields() void
                +import_currencies_from_api_test_file() void
            }

            note top of app_application_import_tests
            Test suite for application import functionality.

            Tests cover importing currencies from XML files,
            handling multiple files, verifying field accuracy,
            and querying imported data.
            end note

            app_application_import_tests ..> ores::cli::app::application : tests

            class parser_tests <<test suite>> #C5E1A5 {
                +test_help_option() void
                +test_version_option() void
                +test_import_help() void
                +test_export_help() void
                +test_logging_options() void
                +test_import_basic() void
                +test_import_multiple_targets() void
                +test_export_basic() void
                +test_export_full_options() void
                +test_invalid_command() void
                +test_missing_required_import_args() void
                +test_missing_required_export_args() void
                +test_import_with_logging() void
                +test_export_with_logging() void
            }

            note top of parser_tests
            Test suite for command-line parser.

            Tests cover help/version flags, import/export commands,
            logging options, error handling, and argument validation.
            end note

            parser_tests ..> ores::cli::config::parser : tests
            parser_tests ..> ores::cli::config::options : tests
        }
    }
}

' Local Variables:
' compile-command: "java -Djava.awt.headless=true -DPLANTUML_SECURITY_PROFILE=UNSECURE -DPLANTUML_LIMIT_SIZE=65535 -jar /usr/share/plantuml/plantuml.jar ores.cli.puml"
' End:
@enduml
