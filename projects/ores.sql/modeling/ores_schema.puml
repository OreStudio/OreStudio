' -*- mode: plantuml; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-
'
' Copyright (C) 2025 Marco Craveiro <marco.craveiro@gmail.com>
'
' This program is free software; you can redistribute it and/or modify it under
' the terms of the GNU General Public License as published by the Free Software
' Foundation; either version 3 of the License, or (at your option) any later
' version.
'
' This program is distributed in the hope that it will be useful, but WITHOUT
'  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
' FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
'
' You should have received a copy of the GNU General Public License along with
' GNU Emacs; see the file COPYING. If not, write to the Free Software
' Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
@startuml

title ORES Database Schema
hide circle
skinparam linetype ortho

note as SchemaNote
ORES Database Schema

All tables use temporal support with valid_from/valid_to
for bitemporal data management. Junction tables enable
soft deletes via validity period closure.

Change tracking: Most entities include change_reason_code
and change_commentary for audit trail support.

Table naming: <component>_<entity>_tbl
end note

'
' ==================== iam (Identity & Access Management) ====================
'
package "iam" #E8F4FD {
    entity iam_accounts_tbl <<temporal>> #C6F0D8 {
        * id : uuid <<PK>>
        --
        * version : integer
        * username : text <<unique>>
        * password_hash : text
        * password_salt : text
        * totp_secret : text
        * email : text <<unique>>
        * modified_by : text
        * change_reason_code : text <<FK>>
        * change_commentary : text
        * valid_from : timestamptz
        * valid_to : timestamptz
    }

    note right of iam_accounts_tbl
    User accounts with authentication credentials.
    Supports optimistic locking via version field.
    Username and email unique for current records.
    end note

    entity iam_login_info_tbl #F7E5FF {
        * account_id : uuid <<PK, FK>>
        --
        * last_ip : inet
        * last_attempt_ip : inet
        * failed_logins : integer
        * locked : integer
        * last_login : timestamptz
        * online : integer
        * password_reset_required : integer
    }

    note right of iam_login_info_tbl
    Security tracking for login attempts.
    Current-state table (no temporal versioning).
    Tracks failed attempts and lock status.
    end note

    entity iam_sessions_tbl <<temporal>> #C6F0D8 {
        * id : uuid <<PK>>
        * start_time : timestamptz <<PK>>
        --
        * account_id : uuid <<FK>>
        * end_time : text
        * client_ip : text
        * client_identifier : text
        * client_version_major : smallint
        * client_version_minor : smallint
        * bytes_sent : bigint
        * bytes_received : bigint
        * country_code : text
    }

    note right of iam_sessions_tbl
    User session tracking with country-level geolocation.
    Designed for TimescaleDB hypertable.
    Partitioned by start_time.
    end note

    entity iam_roles_tbl <<temporal>> #C6F0D8 {
        * id : uuid <<PK>>
        --
        * version : integer
        * name : text <<unique>>
        * description : text
        * modified_by : text
        * change_reason_code : text <<FK>>
        * change_commentary : text
        * valid_from : timestamptz
        * valid_to : timestamptz
    }

    note right of iam_roles_tbl
    Named roles for grouping permissions.
    Examples: admin, viewer, editor.
    end note

    entity iam_permissions_tbl <<temporal>> #C6F0D8 {
        * id : uuid <<PK>>
        --
        * code : text <<unique>>
        * description : text
        * valid_from : timestamptz
        * valid_to : timestamptz
    }

    note right of iam_permissions_tbl
    Fine-grained permission codes.
    System-defined constants from bootstrap data.
    No change tracking (not user-editable).
    end note

    entity iam_account_roles_tbl <<junction>> #ECECEC {
        * account_id : uuid <<PK, FK>>
        * role_id : uuid <<PK, FK>>
        * valid_from : timestamptz <<PK>>
        --
        * assigned_by : text
        * assigned_at : timestamptz
        * change_reason_code : text <<FK>>
        * change_commentary : text
        * valid_to : timestamptz
    }

    note bottom of iam_account_roles_tbl
    Many-to-many: accounts to roles.
    Tracks who assigned the role.
    end note

    entity iam_role_permissions_tbl <<junction>> #ECECEC {
        * role_id : uuid <<PK, FK>>
        * permission_id : uuid <<PK, FK>>
        * valid_from : timestamptz <<PK>>
        --
        * valid_to : timestamptz
    }

    note bottom of iam_role_permissions_tbl
    Many-to-many: roles to permissions.
    end note
}

'
' ==================== assets ====================
'
package "assets" #F3E5F5 {
    entity assets_images_tbl <<temporal>> #C6F0D8 {
        * image_id : uuid <<PK>>
        --
        * version : integer
        * key : text <<unique>>
        * description : text
        * svg_data : text
        * modified_by : text
        * change_reason_code : text <<FK>>
        * change_commentary : text
        * valid_from : timestamptz
        * valid_to : timestamptz
    }

    note right of assets_images_tbl
    SVG image storage.
    Key provides human-readable lookup.
    end note

    entity assets_tags_tbl <<temporal>> #C6F0D8 {
        * tag_id : uuid <<PK>>
        --
        * version : integer
        * name : text <<unique>>
        * description : text
        * modified_by : text
        * change_reason_code : text <<FK>>
        * change_commentary : text
        * valid_from : timestamptz
        * valid_to : timestamptz
    }

    note right of assets_tags_tbl
    Categories for images.
    Examples: flag, currency, commodity.
    end note

    entity assets_image_tags_tbl <<junction>> #ECECEC {
        * image_id : uuid <<PK, FK>>
        * tag_id : uuid <<PK, FK>>
        * valid_from : timestamptz <<PK>>
        --
        * assigned_by : text
        * assigned_at : timestamptz
        * valid_to : timestamptz
    }

    note bottom of assets_image_tags_tbl
    Many-to-many: images to tags.
    end note
}

'
' ==================== refdata (Reference Data) ====================
'
package "refdata" #FFF3E0 {
    entity refdata_currencies_tbl <<temporal>> #C6F0D8 {
        * iso_code : text <<PK>>
        --
        * version : integer
        * name : text
        * numeric_code : text
        * symbol : text
        * fraction_symbol : text
        * fractions_per_unit : integer
        * rounding_type : text
        * rounding_precision : integer
        * format : text
        * currency_type : text
        coding_scheme_code : text <<FK>>
        image_id : uuid <<FK>>
        * modified_by : text
        * change_reason_code : text <<FK>>
        * change_commentary : text
        * valid_from : timestamptz
        * valid_to : timestamptz
    }

    note right of refdata_currencies_tbl
    ISO 4217 currency definitions.
    Includes formatting rules and
    optional flag image reference.
    coding_scheme_code tracks data provenance.
    end note

    entity refdata_countries_tbl <<temporal>> #C6F0D8 {
        * alpha2_code : text <<PK>>
        * valid_from : timestamptz <<PK>>
        * valid_to : timestamptz <<PK>>
        --
        * version : integer
        * alpha3_code : text
        * numeric_code : text
        * name : text
        * official_name : text
        coding_scheme_code : text <<FK>>
        image_id : uuid <<FK>>
        * modified_by : text
        * change_reason_code : text <<FK>>
        * change_commentary : text
    }

    note right of refdata_countries_tbl
    ISO 3166-1 country definitions.
    Includes alpha-2, alpha-3, and numeric codes.
    Optional flag image reference.
    coding_scheme_code tracks data provenance.
    end note
}

'
' ==================== variability (Feature Flags) ====================
'
package "variability" #E8F5E9 {
    entity variability_feature_flags_tbl <<temporal>> #C6F0D8 {
        * name : text <<PK>>
        --
        * version : integer
        * enabled : integer
        * description : text
        * modified_by : text
        * change_reason_code : text <<FK>>
        * change_commentary : text
        * valid_from : timestamptz
        * valid_to : timestamptz
    }

    note right of variability_feature_flags_tbl
    Feature toggles for runtime configuration.
    Uses name as natural key.
    end note
}

'
' ==================== dq (Data Quality) ====================
'
package "dq" #E1F5FE {
    entity dq_change_reason_categories_tbl <<temporal>> #C6F0D8 {
        * code : text <<PK>>
        * valid_from : timestamptz <<PK>>
        * valid_to : timestamptz <<PK>>
        --
        * version : integer
        * description : text
        * modified_by : text
        * change_commentary : text
    }

    note right of dq_change_reason_categories_tbl
    Groups change reasons into logical categories.
    Examples: static_data, trade, market_data.
    Determines which reasons apply to which entity types.
    end note

    entity dq_change_reasons_tbl <<temporal>> #C6F0D8 {
        * code : text <<PK>>
        * valid_from : timestamptz <<PK>>
        * valid_to : timestamptz <<PK>>
        --
        * version : integer
        * description : text
        * category_code : text <<FK>>
        * applies_to_amend : boolean
        * applies_to_delete : boolean
        * requires_commentary : boolean
        * display_order : integer
        * modified_by : text
        * change_commentary : text
    }

    note right of dq_change_reasons_tbl
    Defines reasons for record changes.
    Namespaced format: "category.reason_name"
    Examples: system.new, static_data.front_office_error.
    end note

    entity dq_catalog_tbl <<temporal>> #C6F0D8 {
        * name : text <<PK>>
        * valid_from : timestamptz <<PK>>
        * valid_to : timestamptz <<PK>>
        --
        * version : integer
        * description : text
        owner : text
        * modified_by : text
        * change_reason_code : text <<FK>>
        * change_commentary : text
    }

    note right of dq_catalog_tbl
    Named collection of related datasets.
    Examples: ISO Standards, Cryptocurrency.
    end note

    entity dq_data_domain_tbl <<temporal>> #C6F0D8 {
        * name : text <<PK>>
        * valid_from : timestamptz <<PK>>
        * valid_to : timestamptz <<PK>>
        --
        * version : integer
        * description : text
        * modified_by : text
        * change_reason_code : text <<FK>>
        * change_commentary : text
    }

    note right of dq_data_domain_tbl
    High-level data classification.
    Examples: reference_data, market_data, trade_data.
    end note

    entity dq_subject_area_tbl <<temporal>> #C6F0D8 {
        * name : text <<PK>>
        * domain_name : text <<PK, FK>>
        * valid_from : timestamptz <<PK>>
        * valid_to : timestamptz <<PK>>
        --
        * version : integer
        * description : text
        * modified_by : text
        * change_reason_code : text <<FK>>
        * change_commentary : text
    }

    note right of dq_subject_area_tbl
    Sub-classification within a data domain.
    Examples: currencies, countries, images.
    end note

    entity dq_coding_scheme_authority_type_tbl <<temporal>> #C6F0D8 {
        * code : text <<PK>>
        * valid_from : timestamptz <<PK>>
        * valid_to : timestamptz <<PK>>
        --
        * version : integer
        * name : text
        * description : text
        * modified_by : text
        * change_reason_code : text <<FK>>
        * change_commentary : text
    }

    note right of dq_coding_scheme_authority_type_tbl
    Classifies coding schemes by authority level.
    Values: official, industry, internal.
    end note

    entity dq_coding_scheme_tbl <<temporal>> #C6F0D8 {
        * code : text <<PK>>
        * valid_from : timestamptz <<PK>>
        * valid_to : timestamptz <<PK>>
        --
        * version : integer
        * name : text
        * authority_type : text <<FK>>
        * subject_area_name : text <<FK>>
        * domain_name : text <<FK>>
        uri : text
        * description : text
        * modified_by : text
        * change_reason_code : text <<FK>>
        * change_commentary : text
    }

    note right of dq_coding_scheme_tbl
    FPML coding schemes for entity identification.
    Examples: LEI, BIC, ISO 4217, ISO 3166.
    end note

    entity dq_nature_dimension_tbl <<temporal>> #C6F0D8 {
        * code : text <<PK>>
        * valid_from : timestamptz <<PK>>
        * valid_to : timestamptz <<PK>>
        --
        * version : integer
        * name : text
        * description : text
        * modified_by : text
        * change_reason_code : text <<FK>>
        * change_commentary : text
    }

    note right of dq_nature_dimension_tbl
    Describes the nature of data.
    Examples: raw, cleansed, derived.
    end note

    entity dq_origin_dimension_tbl <<temporal>> #C6F0D8 {
        * code : text <<PK>>
        * valid_from : timestamptz <<PK>>
        * valid_to : timestamptz <<PK>>
        --
        * version : integer
        * name : text
        * description : text
        * modified_by : text
        * change_reason_code : text <<FK>>
        * change_commentary : text
    }

    note right of dq_origin_dimension_tbl
    Describes the origin of data.
    Examples: vendor, internal, regulatory.
    end note

    entity dq_treatment_dimension_tbl <<temporal>> #C6F0D8 {
        * code : text <<PK>>
        * valid_from : timestamptz <<PK>>
        * valid_to : timestamptz <<PK>>
        --
        * version : integer
        * name : text
        * description : text
        * modified_by : text
        * change_reason_code : text <<FK>>
        * change_commentary : text
    }

    note right of dq_treatment_dimension_tbl
    Describes how data should be treated.
    Examples: golden, provisional, deprecated.
    end note

    entity dq_methodology_tbl <<temporal>> #C6F0D8 {
        * id : uuid <<PK>>
        * valid_from : timestamptz <<PK>>
        * valid_to : timestamptz <<PK>>
        --
        * version : integer
        * name : text <<unique>>
        * description : text
        logic_reference : text
        implementation_details : text
        * modified_by : text
        * change_reason_code : text <<FK>>
        * change_commentary : text
    }

    note right of dq_methodology_tbl
    Describes transformation/derivation logic.
    Links to documentation and implementation.
    end note

    entity dq_dataset_tbl <<temporal>> #C6F0D8 {
        * id : uuid <<PK>>
        * valid_from : timestamptz <<PK>>
        * valid_to : timestamptz <<PK>>
        --
        * version : integer
        catalog_name : text <<FK>>
        * subject_area_name : text <<FK>>
        * domain_name : text <<FK>>
        coding_scheme_code : text <<FK>>
        * origin_code : text <<FK>>
        * nature_code : text <<FK>>
        * treatment_code : text <<FK>>
        methodology_id : uuid <<FK>>
        * name : text
        * description : text
        * source_system_id : text
        * business_context : text
        upstream_derivation_id : uuid <<FK>>
        * lineage_depth : integer
        * as_of_date : date
        * ingestion_timestamp : timestamptz
        license_info : text
        * modified_by : text
        * change_reason_code : text <<FK>>
        * change_commentary : text
    }

    note right of dq_dataset_tbl
    Central dataset registry with full lineage.
    Tracks provenance via upstream_derivation_id.
    lineage_depth auto-calculated from hierarchy.
    end note

    entity dq_currencies_artefact_tbl #F7E5FF {
        * dataset_id : uuid <<FK>>
        * iso_code : text
        --
        * version : integer
        * name : text
        * numeric_code : text
        * symbol : text
        * fraction_symbol : text
        * fractions_per_unit : integer
        * rounding_type : text
        * rounding_precision : integer
        * format : text
        * currency_type : text
        image_id : uuid
    }

    note bottom of dq_currencies_artefact_tbl
    Snapshot of currency data for a dataset.
    Non-temporal - immutable once ingested.
    end note

    entity dq_countries_artefact_tbl #F7E5FF {
        * dataset_id : uuid <<FK>>
        * alpha2_code : text
        --
        * version : integer
        * alpha3_code : text
        * numeric_code : text
        * name : text
        * official_name : text
        image_id : uuid
    }

    note bottom of dq_countries_artefact_tbl
    Snapshot of country data for a dataset.
    Non-temporal - immutable once ingested.
    end note

    entity dq_images_artefact_tbl #F7E5FF {
        * dataset_id : uuid <<FK>>
        * image_id : uuid
        --
        * version : integer
        * key : text
        * description : text
        * svg_data : text
    }

    note bottom of dq_images_artefact_tbl
    Snapshot of image data for a dataset.
    Non-temporal - immutable once ingested.
    end note

    entity dq_tags_artefact_tbl #F7E5FF {
        * dataset_id : uuid <<FK>>
        * tag_id : uuid
        --
        * version : integer
        * name : text
        * description : text
    }

    note bottom of dq_tags_artefact_tbl
    Snapshot of tag data for a dataset.
    Non-temporal - immutable once ingested.
    end note

    entity dq_image_tags_artefact_tbl <<junction>> #ECECEC {
        * dataset_id : uuid <<FK>>
        * image_id : uuid
        * tag_id : uuid
    }

    note bottom of dq_image_tags_artefact_tbl
    Snapshot of image-tag relationships.
    Non-temporal - immutable once ingested.
    end note
}

'
' ==================== telemetry ====================
'
package "telemetry" #FCE4EC {
    entity telemetry_logs_tbl #F7E5FF {
        * id : uuid <<PK>>
        * timestamp : timestamptz <<PK>>
        --
        * source : text
        * source_name : text
        session_id : uuid <<FK>>
        account_id : uuid <<FK>>
        * level : text
        component : text
        * message : text
        tag : text
        * recorded_at : timestamptz
    }

    note right of telemetry_logs_tbl
    Application log entries.
    Designed for TimescaleDB hypertable.
    Partitioned by timestamp.
    end note
}

'
' ==================== geo (Geolocation) ====================
'
package "geo" #FFF9C4 {
    entity geo_ip2country_tbl #F7E5FF {
        * ip_range : int8range <<PK>>
        --
        * country_code : text
    }

    note right of geo_ip2country_tbl
    IP range to country code mapping.
    Uses GiST index for fast lookups.
    end note
}

'
' ==================== Relationships ====================
'

' dq change management relationships
dq_change_reason_categories_tbl ||--o{ dq_change_reasons_tbl : "contains"

' iam relationships
iam_accounts_tbl ||--o| iam_login_info_tbl : "has"
iam_accounts_tbl ||--o{ iam_sessions_tbl : "creates"
iam_accounts_tbl ||--o{ iam_account_roles_tbl : "assigned"
iam_roles_tbl ||--o{ iam_account_roles_tbl : "granted to"
iam_roles_tbl ||--o{ iam_role_permissions_tbl : "has"
iam_permissions_tbl ||--o{ iam_role_permissions_tbl : "included in"

' assets relationships
assets_images_tbl ||--o{ assets_image_tags_tbl : "tagged with"
assets_tags_tbl ||--o{ assets_image_tags_tbl : "applied to"

' refdata to assets relationships
refdata_currencies_tbl }o--o| assets_images_tbl : "displayed as"
refdata_countries_tbl }o--o| assets_images_tbl : "displayed as"

' refdata to dq coding scheme relationships
dq_coding_scheme_tbl ||--o{ refdata_currencies_tbl : "identifies"
dq_coding_scheme_tbl ||--o{ refdata_countries_tbl : "identifies"

' dq hierarchy relationships
dq_catalog_tbl ||--o{ dq_dataset_tbl : "groups"
dq_data_domain_tbl ||--o{ dq_subject_area_tbl : "contains"
dq_subject_area_tbl ||--o{ dq_dataset_tbl : "classifies"
dq_subject_area_tbl ||--o{ dq_coding_scheme_tbl : "defines"
dq_coding_scheme_authority_type_tbl ||--o{ dq_coding_scheme_tbl : "classifies"
dq_coding_scheme_tbl ||--o{ dq_dataset_tbl : "identifies"

' dq dimension relationships
dq_origin_dimension_tbl ||--o{ dq_dataset_tbl : "describes origin"
dq_nature_dimension_tbl ||--o{ dq_dataset_tbl : "describes nature"
dq_treatment_dimension_tbl ||--o{ dq_dataset_tbl : "describes treatment"
dq_methodology_tbl ||--o{ dq_dataset_tbl : "applied to"
dq_dataset_tbl ||--o{ dq_dataset_tbl : "derives from"

' dq artefact relationships
dq_dataset_tbl ||--o{ dq_currencies_artefact_tbl : "contains"
dq_dataset_tbl ||--o{ dq_countries_artefact_tbl : "contains"
dq_dataset_tbl ||--o{ dq_images_artefact_tbl : "contains"
dq_dataset_tbl ||--o{ dq_tags_artefact_tbl : "contains"
dq_dataset_tbl ||--o{ dq_image_tags_artefact_tbl : "contains"

' Change tracking relationships (logical - not enforced FKs in all cases)
dq_change_reasons_tbl ||--o{ iam_accounts_tbl : "reason for"
dq_change_reasons_tbl ||--o{ iam_roles_tbl : "reason for"
dq_change_reasons_tbl ||--o{ iam_account_roles_tbl : "reason for"
dq_change_reasons_tbl ||--o{ assets_images_tbl : "reason for"
dq_change_reasons_tbl ||--o{ assets_tags_tbl : "reason for"
dq_change_reasons_tbl ||--o{ refdata_currencies_tbl : "reason for"
dq_change_reasons_tbl ||--o{ refdata_countries_tbl : "reason for"
dq_change_reasons_tbl ||--o{ variability_feature_flags_tbl : "reason for"
dq_change_reasons_tbl ||--o{ dq_catalog_tbl : "reason for"
dq_change_reasons_tbl ||--o{ dq_data_domain_tbl : "reason for"
dq_change_reasons_tbl ||--o{ dq_subject_area_tbl : "reason for"
dq_change_reasons_tbl ||--o{ dq_coding_scheme_authority_type_tbl : "reason for"
dq_change_reasons_tbl ||--o{ dq_coding_scheme_tbl : "reason for"
dq_change_reasons_tbl ||--o{ dq_nature_dimension_tbl : "reason for"
dq_change_reasons_tbl ||--o{ dq_origin_dimension_tbl : "reason for"
dq_change_reasons_tbl ||--o{ dq_treatment_dimension_tbl : "reason for"
dq_change_reasons_tbl ||--o{ dq_methodology_tbl : "reason for"
dq_change_reasons_tbl ||--o{ dq_dataset_tbl : "reason for"

' telemetry relationships
iam_accounts_tbl ||--o{ telemetry_logs_tbl : "generates"
iam_sessions_tbl ||--o{ telemetry_logs_tbl : "generates"

' Local Variables:
' compile-command: "java -Djava.awt.headless=true -DPLANTUML_SECURITY_PROFILE=UNSECURE -DPLANTUML_LIMIT_SIZE=65535 -jar /usr/share/plantuml/plantuml.jar ores_schema.puml"
' End:
@enduml
