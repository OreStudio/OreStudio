' -*- mode: plantuml; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-
'
' Copyright (C) 2025 Marco Craveiro <marco.craveiro@gmail.com>
'
' This program is free software; you can redistribute it and/or modify it under
' the terms of the GNU General Public License as published by the Free Software
' Foundation; either version 3 of the License, or (at your option) any later
' version.
'
' This program is distributed in the hope that it will be useful, but WITHOUT
'  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
' FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
'
' You should have received a copy of the GNU General Public License along with
' GNU Emacs; see the file COPYING. If not, write to the Free Software
' Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
@startuml
!pragma layout smetana

title ores.qt Component

set namespaceSeparator ::

namespace ores #F2F2F2 {
    note "Qt based Graphical User Interface for ORE Studio." as ores_qt_note
    qt --- ores_qt_note

    namespace qt #F2F2F2 {
        '
        ' Layout groupings
        '

        ' Group: Core infrastructure
        together {
            class ClientManager
            class MainWindow
        }

        ' Group: MDI infrastructure
        together {
            class MdiAreaWithBackground
            class DetachableMdiSubWindow
        }

        ' Group: Entity Controller Pattern
        together {
            class EntityController
            class CurrencyController
        }

        ' Group: Currency Windows
        together {
            class CurrencyMdiWindow
            class ClientCurrencyModel
            class CurrencyDetailDialog
            class CurrencyHistoryDialog
        }

        ' Group: Dialogs
        together {
            class LoginDialog
            class AboutDialog
            class SplashScreen
            class MyAccountDialog
            class ChangePasswordDialog
        }

        ' Group: Helpers
        together {
            class CurrencyItemDelegate
            class MessageBoxHelper
            class IconUtils
            class MdiUtils
            class LogoLabel
        }

        ' Stack vertically within groups
        ClientManager -[hidden]down- MainWindow
        MdiAreaWithBackground -[hidden]down- DetachableMdiSubWindow
        EntityController -[hidden]down- CurrencyController
        CurrencyMdiWindow -[hidden]down- ClientCurrencyModel
        ClientCurrencyModel -[hidden]down- CurrencyDetailDialog
        CurrencyDetailDialog -[hidden]down- CurrencyHistoryDialog
        LoginDialog -[hidden]down- AboutDialog
        AboutDialog -[hidden]down- SplashScreen
        SplashScreen -[hidden]down- MyAccountDialog
        MyAccountDialog -[hidden]down- ChangePasswordDialog
        CurrencyItemDelegate -[hidden]down- MessageBoxHelper
        MessageBoxHelper -[hidden]down- IconUtils
        IconUtils -[hidden]down- MdiUtils
        MdiUtils -[hidden]down- LogoLabel

        ' Create row structure between groups
        MainWindow -[hidden]down- MdiAreaWithBackground
        DetachableMdiSubWindow -[hidden]down- EntityController
        CurrencyController -[hidden]down- CurrencyMdiWindow
        CurrencyHistoryDialog -[hidden]down- LoginDialog
        ChangePasswordDialog -[hidden]down- CurrencyItemDelegate

        '
        ' Class definitions
        '

        ' Client Manager
        class ClientManager #ECECEC {
            +ClientManager(std::shared_ptr<eventing::service::event_bus>, QObject* parent)
            +~ClientManager()
            +connectAndLogin(const std::string& host, std::uint16_t port, const std::string& username, const std::string& password) LoginResult
            +disconnect() void
            +logout() bool
            +isConnected() bool
            +isAdmin() bool
            +currentUsername() const std::string&
            +currentEmail() const std::string&
            +setCurrentEmail(const std::string& email) void
            +sendRequest(comms::messaging::frame request) std::expected<comms::messaging::frame, comms::messaging::error_code>
            +getClient() std::shared_ptr<comms::net::client>
            +getExecutor() boost::asio::any_io_executor
            +subscribeToEvent(const std::string& eventType) void
            +unsubscribeFromEvent(const std::string& eventType) void
            +setSupportedCompression(std::uint8_t compression) void
            -setupIO() void
            -cleanupIO() void
            -{field} io_context_ std::unique_ptr<boost::asio::io_context>
            -{field} work_guard_ std::unique_ptr<boost::asio::executor_work_guard>
            -{field} io_thread_ std::unique_ptr<std::thread>
            -{field} client_ std::shared_ptr<comms::net::client>
            -{field} logged_in_account_id_ std::optional<boost::uuids::uuid>
            -{field} logged_in_username_ std::string
            -{field} logged_in_email_ std::string
        }
        note top of ClientManager
        Manages the lifecycle of the network client and IO context.

        Maintains a persistent IO context/thread while allowing the client
        connection to be established and torn down repeatedly. Signals changes
        in connection state to allow UI components to update accordingly
        without closing.

        Key features:
        - Session tracking (account_id, username, email)
        - Event subscriptions for server push notifications
        - Compression negotiation

        Signals: connected(), disconnected(), reconnecting(), reconnected(),
                 connectionError(QString), notificationReceived(QString, QDateTime)
        end note

        ' Main Window
        class MainWindow #ECECEC {
            +MainWindow(QWidget* parent)
            +~MainWindow()
            +getClientManager() ClientManager*
            #closeEvent(QCloseEvent* event) void
            -onLoginTriggered() void
            -onDisconnectTriggered() void
            -onAboutTriggered() void
            -onDetachAllTriggered() void
            -onWindowMenuAboutToShow() void
            -updateMenuState() void
            -createControllers() void
            -performDisconnectCleanup() void
            -{field} ui_ Ui::MainWindow*
            -{field} mdiArea_ MdiAreaWithBackground*
            -{field} connectionStatusIconLabel_ QLabel*
            -{field} allDetachableWindows_ QList<DetachableMdiSubWindow*>
            -{field} connectedIcon_ QIcon
            -{field} disconnectedIcon_ QIcon
            -{field} currencyController_ std::unique_ptr<CurrencyController>
            -{field} clientManager_ ClientManager*
            -{field} username_ std::string
        }
        note top of MainWindow
        Main application window providing the MDI interface and entity management.

        - ui_: Auto-generated UI elements
        - mdiArea_: MDI area with custom background
        - connectionStatusIconLabel_: Status bar connection icon
        - allDetachableWindows_: List of all detachable windows
        - connectedIcon_: Connected state icon
        - disconnectedIcon_: Disconnected state icon
        - currencyController_: Currency operations controller
        - clientManager_: Manages client lifecycle
        - username_: Logged-in username
        end note

        ' MDI Infrastructure
        class MdiAreaWithBackground #ECECEC {
            +MdiAreaWithBackground(QWidget* parent)
            +setBackgroundLogo(const QString& imagePath) void
            #paintEvent(QPaintEvent* event) void
            -{field} backgroundLogo_ QPixmap
        }
        note top of MdiAreaWithBackground
        Custom QMdiArea that displays a background logo when no windows are open.

        - backgroundLogo_: Background logo image
        end note

        class DetachableMdiSubWindow #ECECEC {
            +DetachableMdiSubWindow(QWidget* parent)
            +~DetachableMdiSubWindow()
            +isDetached() bool
            +detach() void
            +reattach() void
            #contextMenuEvent(QContextMenuEvent* event) void
            #closeEvent(QCloseEvent* event) void
            -{field} isDetached_ bool
            -{field} savedMdiArea_ QPointer<QMdiArea>
            -{field} savedMdiPosition_ QPoint
            -{field} savedMdiSize_ QSize
        }
        note top of DetachableMdiSubWindow
        QMdiSubWindow that can be detached to become a floating window.

        - isDetached_: Detachment state flag
        - savedMdiArea_: Saved MDI area reference
        - savedMdiPosition_: Saved MDI position
        - savedMdiSize_: Saved MDI size
        end note

        ' Entity Controller Pattern
        class EntityController #ECECEC {
            +EntityController(QMainWindow* mainWindow, QMdiArea* mdiArea, ClientManager* clientManager, const QString& username, QObject* parent)
            +~EntityController()
            +{abstract} showListWindow() void
            +setClientManager(ClientManager* clientManager, const QString& username) void
            +{abstract} closeAllWindows() void
            #statusMessage(const QString& message)
            #errorMessage(const QString& message)
            #{field} mainWindow_ QMainWindow*
            #{field} mdiArea_ QMdiArea*
            #{field} clientManager_ ClientManager*
            #{field} username_ QString
        }
        note top of EntityController
        Base class for entity-specific controllers.

        - mainWindow_: Parent main window
        - mdiArea_: MDI area for windows
        - clientManager_: Client manager for network operations
        - username_: Logged-in username
        end note

        class CurrencyController #ECECEC {
            +CurrencyController(QMainWindow* mainWindow, QMdiArea* mdiArea, ClientManager* clientManager, const QString& username, QList<DetachableMdiSubWindow*>& allDetachableWindows, QObject* parent)
            +~CurrencyController()
            +showListWindow() void
            +closeAllWindows() void
            -onAddNewRequested() void
            -onShowCurrencyDetails(const risk::domain::currency& currency) void
            -onShowCurrencyHistory(const QString& isoCode) void
            -{field} allDetachableWindows_ QList<DetachableMdiSubWindow*>&
            -{field} currencyListWindow_ QPointer<DetachableMdiSubWindow>
        }
        note top of CurrencyController
        Controller managing all currency-related windows and operations.

        - allDetachableWindows_: Reference to MainWindow's window list
        - currencyListWindow_: Weak pointer to currency list window
        end note

        ' Currency Windows
        class CurrencyMdiWindow #ECECEC {
            +CurrencyMdiWindow(ClientManager* clientManager, QWidget* parent)
            +~CurrencyMdiWindow()
            +currencyModel() ClientCurrencyModel*
            +sizeHint() QSize
            +reload() void
            +addNew() void
            +editSelected() void
            +deleteSelected() void
            +viewHistorySelected() void
            +exportToCSV() void
            +exportToXML() void
            -onDataLoaded() void
            -onLoadError(const QString& error_message) void
            -onRowDoubleClicked(const QModelIndex& index) void
            -onSelectionChanged() void
            -updateActionStates() void
            -{field} verticalLayout_ QVBoxLayout*
            -{field} currencyTableView_ QTableView*
            -{field} toolBar_ QToolBar*
            -{field} addAction_ QAction*
            -{field} editAction_ QAction*
            -{field} deleteAction_ QAction*
            -{field} historyAction_ QAction*
            -{field} currencyModel_ std::unique_ptr<ClientCurrencyModel>
            -{field} clientManager_ ClientManager*
        }
        note top of CurrencyMdiWindow
        MDI window for displaying currencies.

        - verticalLayout_: Layout for window
        - currencyTableView_: Table view for currencies
        - toolBar_: Toolbar with actions
        - addAction_: Add currency action
        - editAction_: Edit currency action
        - deleteAction_: Delete currency action
        - historyAction_: View history action
        - currencyModel_: Currency data model
        - clientManager_: Client manager
        end note

        class ClientCurrencyModel #ECECEC {
            +ClientCurrencyModel(ClientManager* clientManager, QObject* parent)
            +~ClientCurrencyModel()
            +rowCount(const QModelIndex& parent) int
            +columnCount(const QModelIndex& parent) int
            +data(const QModelIndex& index, int role) QVariant
            +headerData(int section, Qt::Orientation orientation, int role) QVariant
            +refresh() void
            +getCurrency(int row) const risk::domain::currency*
            +getCurrencies() std::vector<risk::domain::currency>
            -onCurrenciesLoaded() void
            -{field} clientManager_ ClientManager*
            -{field} currencies_ std::vector<risk::domain::currency>
            -{field} watcher_ QFutureWatcher<FutureWatcherResult>*
        }
        note top of ClientCurrencyModel
        Model for displaying currencies fetched from the server via client.

        - clientManager_: Client manager
        - currencies_: Currency data
        - watcher_: Future watcher for async loading
        end note

        class CurrencyDetailDialog #ECECEC {
            +CurrencyDetailDialog(QWidget* parent)
            +~CurrencyDetailDialog()
            +setClientManager(ClientManager* clientManager) void
            +setUsername(const std::string& username) void
            +setCurrency(const risk::domain::currency& currency) void
            +getCurrency() risk::domain::currency
            +clearDialog() void
            +save() void
            -onSaveClicked() void
            -onResetClicked() void
            -onDeleteClicked() void
            -onFieldChanged() void
            -updateSaveResetButtonState() void
            -{field} ui_ std::unique_ptr<Ui::CurrencyDetailDialog>
            -{field} isDirty_ bool
            -{field} isAddMode_ bool
            -{field} username_ std::string
            -{field} toolBar_ QToolBar*
            -{field} saveAction_ QAction*
            -{field} deleteAction_ QAction*
            -{field} clientManager_ ClientManager*
            -{field} currentCurrency_ risk::domain::currency
        }
        note top of CurrencyDetailDialog
        Widget for creating/editing currency details.

        - ui_: Auto-generated UI elements
        - isDirty_: Dirty flag
        - isAddMode_: Add mode flag
        - username_: Logged-in username
        - toolBar_: Toolbar with actions
        - saveAction_: Save action
        - deleteAction_: Delete action
        - clientManager_: Client manager
        - currentCurrency_: Current currency being edited
        end note

        class CurrencyHistoryDialog #ECECEC {
            +CurrencyHistoryDialog(QString iso_code, ClientManager* clientManager, QWidget* parent)
            +~CurrencyHistoryDialog()
            +loadHistory() void
            +sizeHint() QSize
            -onVersionSelected(int index) void
            -onHistoryLoaded() void
            -onHistoryLoadError(const QString& error) void
            -displayChangesTab(int version_index) void
            -displayFullDetailsTab(int version_index) void
            -calculateDiff(const risk::domain::currency_version& current, const risk::domain::currency_version& previous) DiffResult
            -{field} ui_ std::unique_ptr<Ui::CurrencyHistoryDialog>
            -{field} clientManager_ ClientManager*
            -{field} isoCode_ QString
            -{field} history_ risk::domain::currency_version_history
        }
        note top of CurrencyHistoryDialog
        Widget for displaying currency version history.

        - ui_: Auto-generated UI elements
        - clientManager_: Client manager
        - isoCode_: ISO code of currency
        - history_: Version history data
        end note

        ' Dialogs
        class LoginDialog #ECECEC {
            +LoginDialog(ClientManager* clientManager, QWidget* parent)
            +~LoginDialog()
            +getUsername() std::string
            -onLoginClicked() void
            -onConnectionResult(bool success, const QString& error_message) void
            -onLoginResult(bool success, const QString& error_message) void
            -setupUI() void
            -enableForm(bool enabled) void
            -performLogin(const std::string& username, const std::string& password) void
            -{field} username_edit_ QLineEdit*
            -{field} password_edit_ QLineEdit*
            -{field} host_edit_ QLineEdit*
            -{field} port_spinbox_ QSpinBox*
            -{field} login_button_ QPushButton*
            -{field} cancel_button_ QPushButton*
            -{field} status_label_ QLabel*
            -{field} clientManager_ ClientManager*
        }
        note top of LoginDialog
        Dialog for user authentication and server connection.

        - username_edit_: Username input field
        - password_edit_: Password input field
        - host_edit_: Server host field
        - port_spinbox_: Server port field
        - login_button_: Login button
        - cancel_button_: Cancel button
        - status_label_: Status message label
        - clientManager_: Client manager
        end note

        class AboutDialog #ECECEC {
            +AboutDialog(QWidget* parent)
            +~AboutDialog()
            #showEvent(QShowEvent* e) void
            -updateVersionLabels() void
            -{field} ui_ Ui::AboutDialog
            -{field} logoLabel_ LogoLabel*
        }
        note top of AboutDialog
        Modal dialog displaying application version and build metadata.

        - ui_: Auto-generated UI elements
        - logoLabel_: Logo label with overlay
        end note

        class SplashScreen #ECECEC {
            +SplashScreen(const QPixmap& pixmap)
            +paintEvent(QPaintEvent* e) void
            +ensureFirstPaint() void
            +setProgressDuration(int milliseconds) void
            +setMessage(const QString& message) void
            -updateProgress() void
            -{field} painted_ bool
            -{field} progress_ int
            -{field} progressTimer_ QTimer*
            -{field} totalDuration_ int
            -{field} elapsedTime_ int
            -{field} updateInterval_ int
            -{field} messageText_ QString
        }
        note top of SplashScreen
        Splash screen with progress indicator.

        - painted_: Paint state flag
        - progress_: Current progress value
        - progressTimer_: Timer for progress updates
        - totalDuration_: Total duration for progress
        - elapsedTime_: Elapsed time
        - updateInterval_: Update interval
        - messageText_: Status message text
        end note

        class MyAccountDialog #ECECEC {
            +MyAccountDialog(ClientManager* clientManager, QWidget* parent)
            +~MyAccountDialog()
            -setupUI() void
            -onChangePasswordClicked() void
            -onSaveEmailClicked() void
            -onSaveEmailResult(bool success, const QString& error_message) void
            -{field} clientManager_ ClientManager*
            -{field} username_label_ QLabel*
            -{field} email_edit_ QLineEdit*
            -{field} save_email_button_ QPushButton*
            -{field} email_status_label_ QLabel*
            -{field} change_password_button_ QPushButton*
        }
        note top of MyAccountDialog
        Dialog for user self-service account management.

        Allows users to:
        - View their username (read-only)
        - Update their email address
        - Change their password

        - clientManager_: Client manager for network operations
        - username_label_: Display current username
        - email_edit_: Email input field
        - save_email_button_: Save email button
        - email_status_label_: Status message label
        - change_password_button_: Opens ChangePasswordDialog
        end note

        class ChangePasswordDialog #ECECEC {
            +ChangePasswordDialog(ClientManager* clientManager, QWidget* parent)
            +~ChangePasswordDialog()
            -setupUI() void
            -onChangePasswordClicked() void
            -onChangePasswordResult(bool success, const QString& error_message) void
            -validatePasswords() bool
            -{field} clientManager_ ClientManager*
            -{field} new_password_edit_ QLineEdit*
            -{field} confirm_password_edit_ QLineEdit*
            -{field} change_button_ QPushButton*
            -{field} status_label_ QLabel*
        }
        note top of ChangePasswordDialog
        Dialog for changing user password.

        Validates password requirements and confirms password match
        before sending change request to server.

        - clientManager_: Client manager for network operations
        - new_password_edit_: New password input
        - confirm_password_edit_: Confirm password input
        - change_button_: Change password button
        - status_label_: Status message label
        end note

        ' Helpers
        class CurrencyItemDelegate #ECECEC {
            +CurrencyItemDelegate(QObject* parent)
            +paint(QPainter* painter, const QStyleOptionViewItem& option, const QModelIndex& index) void
            -{field} monospaceFont_ QFont
        }
        note top of CurrencyItemDelegate
        Custom item delegate for currency display.

        - monospaceFont_: Monospace font for rendering
        end note

        class MessageBoxHelper #ECECEC {
            +{static} question(QWidget* parent, const QString& title, const QString& text, QMessageBox::StandardButtons buttons) QMessageBox::StandardButton
            +{static} warning(QWidget* parent, const QString& title, const QString& text) void
            +{static} critical(QWidget* parent, const QString& title, const QString& text) void
            +{static} information(QWidget* parent, const QString& title, const QString& text) void
            -{static} createColoredIcon(const QString& svgPath, const QColor& color) QIcon
        }
        note top of MessageBoxHelper
        Utility class for creating message boxes with Fluent icons.
        end note

        class IconUtils #ECECEC {
            +{static} createRecoloredIcon(const QString& svgPath, const QColor& color) QIcon
        }
        note top of IconUtils
        Utility class for icon manipulation operations.
        end note

        class MdiUtils #ECECEC {
            +{static} markParentWindowAsStale(QWidget* widget) bool
            +{static} clearParentWindowStaleMarker(QWidget* widget) bool
            -{static}{field} stale_marker const char*
        }
        note top of MdiUtils
        Utility class for MDI window operations.

        - stale_marker: " (Data Changed)" suffix for stale windows
        end note

        class LogoLabel #ECECEC {
            +LogoLabel(QWidget* parent)
            +setTextOverlay(const QString& text) void
            #paintEvent(QPaintEvent* event) void
            -{field} overlayText_ QString
        }
        note top of LogoLabel
        Custom QLabel with text overlay capability.

        - overlayText_: Text to overlay on label
        end note

        ' Relationships - Main Window Structure
        ores::qt::MainWindow *-- ores::qt::MdiAreaWithBackground
        ores::qt::MainWindow o-- ores::qt::DetachableMdiSubWindow
        ores::qt::MainWindow *-- ores::qt::CurrencyController
        ores::qt::MainWindow *-- ores::qt::ClientManager

        ' Relationships - Entity Controller Pattern
        ores::qt::CurrencyController -up-|> ores::qt::EntityController
        ores::qt::CurrencyController o-- ores::qt::DetachableMdiSubWindow
        ores::qt::EntityController o-- ores::qt::ClientManager

        ' Relationships - Currency Components
        ores::qt::CurrencyMdiWindow *-- ores::qt::ClientCurrencyModel
        ores::qt::CurrencyMdiWindow ..> ores::qt::CurrencyItemDelegate : uses
        ores::qt::CurrencyMdiWindow o-- ores::qt::ClientManager
        ores::qt::ClientCurrencyModel o-- ores::qt::ClientManager
        ores::qt::CurrencyDetailDialog o-- ores::qt::ClientManager
        ores::qt::CurrencyHistoryDialog o-- ores::qt::ClientManager

        ' Relationships - Dialogs
        ores::qt::AboutDialog *-- ores::qt::LogoLabel
        ores::qt::LoginDialog o-- ores::qt::ClientManager
        ores::qt::MyAccountDialog o-- ores::qt::ClientManager
        ores::qt::ChangePasswordDialog o-- ores::qt::ClientManager
        ores::qt::MyAccountDialog ..> ores::qt::ChangePasswordDialog : creates

        ' Relationships - MainWindow uses
        ores::qt::MainWindow ..> ores::qt::LoginDialog : uses
        ores::qt::MainWindow ..> ores::qt::AboutDialog : uses
        ores::qt::MainWindow ..> ores::qt::MyAccountDialog : uses
        ores::qt::MainWindow ..> ores::qt::MessageBoxHelper : uses
        ores::qt::MainWindow ..> ores::qt::IconUtils : uses

        ' Relationships - CurrencyController creates windows
        ores::qt::CurrencyController ..> ores::qt::CurrencyMdiWindow : creates
        ores::qt::CurrencyController ..> ores::qt::CurrencyDetailDialog : creates
        ores::qt::CurrencyController ..> ores::qt::CurrencyHistoryDialog : creates

        ' Relationships - MdiUtils usage for stale window marking
        ores::qt::CurrencyDetailDialog ..> ores::qt::MdiUtils : uses
    }
}

' Local Variables:
' compile-command: "java -Djava.awt.headless=true -DPLANTUML_SECURITY_PROFILE=UNSECURE -DPLANTUML_LIMIT_SIZE=65535 -jar /usr/share/plantuml/plantuml.jar ores.qt.puml"
' End:
@enduml
