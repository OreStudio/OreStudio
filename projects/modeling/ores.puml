' -*- mode: plantuml; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-
'
' Copyright (C) 2025 Marco Craveiro <marco.craveiro@gmail.com>
'
' This program is free software; you can redistribute it and/or modify it under
' the terms of the GNU General Public License as published by the Free Software
' Foundation; either version 3 of the License, or (at your option) any later
' version.
'
' This program is distributed in the hope that it will be useful, but WITHOUT
'  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
' FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
'
' You should have received a copy of the GNU General Public License along with
' GNU Emacs; see the file COPYING. If not, write to the Free Software
' Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
@startuml
!pragma layout smetana

title ORE Studio System Architecture

note as SystemNote
C++20 application providing persistent storage, graphical interface,
and orchestration tools for Open Source Risk Engine (ORE).
end note

' Foundation Layer
package "Foundation Layer" #F2F2F2 {
    component [ores.database] as database #F7E5FF

    note right of database
    Database connectivity and health monitoring infrastructure:
    - Connection: PostgreSQL connection management with libpq via sqlgen
    - Pooling: Connection pool with configurable size and retry attempts
    - Context: Database context abstraction for repository operations
    - Health Monitor: Continuous database availability checking with callbacks
    - Repository Helpers: Bitemporal operations, timestamp conversion, SQL generation
    - Configuration: CLI options parsing for database credentials
    No dependencies on other ORE Studio components (base of the dependency tree).
    Organized into: database (core), repository (helpers) namespaces.
    end note

    component [ores.utility] as utility #F7E5FF

    note right of utility
    Foundation utilities with minimal dependencies:
    - Logging: Boost.Log integration with per-module and per-test-case support
    - Filesystem: File I/O, directory operations, recursive search
    - UUID: UUID v7 generation for time-ordered unique identifiers
    - String: Type conversion and string manipulation
    - Environment: Variable access with type conversion
    - Program Options: Environment mapper factory for CLI configuration
    Organized into: log, filesystem, uuid, string, environment namespaces.
    end note

    component [ores.variability] as variability #F7E5FF

    note right of variability
    System variability and configuration management infrastructure:
    - Feature Flags: Runtime toggles for controlling system features and behavior
    - Temporal Versioning: Bitemporal tracking of configuration changes
    - Audit Support: Tracking who changed what and when
    - Repository Pattern: ORM-based persistence with database integration
    - Configuration Management: Centralized storage of system settings
    Provides clean separation between system configuration concerns and business logic.
    Organized into: domain (core entities) and repository (ORM and persistence) namespaces.
    end note
}

' Infrastructure Layer
package "Infrastructure Layer" #F2F2F2 {
    component [ores.eventing] as eventing #F7E5FF

    note right of eventing
    Event-driven architecture infrastructure for decoupled component communication:
    - Event Bus: In-process publish/subscribe with type-safe callbacks
    - Event Traits: Type-to-name mapping for protocol integration
    - PostgreSQL Events: LISTEN/NOTIFY bridge for database change notifications
    - Entity Change Events: Domain-agnostic change notification with timestamps
    - Subscriptions: RAII-based subscription management with auto-unsubscribe
    - Thread Safety: All event bus operations are thread-safe
    Provides decoupled communication between components without direct dependencies.
    Organized into: domain (event types, traits), service (event_bus, postgres_listener) namespaces.
    end note

    component [ores.comms] as comms #F7E5FF

    note right of comms
    Custom binary protocol over SSL/TLS for secure client-server communication:
    - Security: All connections secured with OpenSSL
    - Protocol: Frame-based messages with headers and payloads
    - Server: Async multi-client server with session management
    - Client: Thread-safe client with both sync and async APIs
    - Handshake: Connection establishment with server/client identification
    - Dispatching: Pluggable message handlers by subsystem range
    - Pooling: Maximum connection limits and active connection tracking
    - Errors: Comprehensive error codes with std::expected-based APIs
    - Connection Events: Publishes connected/disconnected/reconnecting events to event bus
    end note

    component [ores.testing] as testing #F7E5FF

    note right of testing
    Comprehensive testing infrastructure for all ORE Studio components:
    - Framework: Catch2 with custom listeners
    - Database Isolation: Each test process gets unique database for parallel execution
    - Listeners: logging_listener and database_lifecycle_listener for auto-setup
    - Logging: Boost.Log configured per-test-case with suite-based organization
    - Database Helpers: Table truncation and context management
    - Template Databases: Tests clone from oresdb_template with full schema
    - Configuration: Environment-driven via TEST_ORES_DB_* variables
    end note
}

' Domain Layer
package "Domain Layer" #F2F2F2 {
    component [ores.risk] as risk #F7E5FF

    note right of risk
    Core domain model for Open Risk Engine (ORE) types following ORE specifications:
    - Domain: Currency entities with temporal versioning (valid_from/valid_to)
    - ORE XML: Import/export to native ORE format using pugixml
    - CSV Export: Structured CSV output for currencies
    - JSON I/O: Serialization using reflection (rfl library)
    - Table I/O: Formatted table output using fort library
    - Persistence: ORM entities, mappers, and repositories with temporal support
    - Message API: Request/response handlers for currency operations (0x3000-0x3FFF)
    - Test Data: Synthetic data generation using faker-cxx
    Organized into: domain, repository, orexml, csv, messaging, generators namespaces.
    end note

    component [ores.iam] as iam #F7E5FF

    note right of iam
    Identity and access management (IAM) with secure authentication:
    - Account Lifecycle: Creation, listing, and deletion of user accounts
    - Authentication: Secure password hashing using scrypt, login tracking
    - Security: Account locking after failed login attempts, unlock capability
    - Bootstrap Mode: System initialization state management using feature flags
    - Message API: Async request/response handlers (0x2000-0x2FFF)
    - Temporal Support: Version tracking with valid_from/valid_to fields
    - Test Data: Synthetic account generation for development
    Organized into: domain, repository, service, messaging, security, generators namespaces.
    end note
}

' Application Layer
package "Application Layer" #F2F2F2 {
    component [ores.shell] as shell #F7E5FF

    note right of shell
    Interactive REPL (Read-Eval-Print Loop) shell for connecting to ORE Studio server:
    - Interface: Interactive command-line with command completion
    - Connection Management: Connect/disconnect to ORE Studio server
    - Currency Operations: List and retrieve currency data
    - Account Operations: Create accounts, login, list accounts, unlock accounts
    - Auto-Connect: Automatic connection and login from configuration file
    - Configuration: Boost program_options for CLI argument parsing
    - Command Handlers: Modular command classes for connection, currencies, and accounts
    Organized into: config (configuration parsing), app (REPL, client manager, commands) namespaces.
    end note

    component [ores.cli] as cli #F7E5FF

    note right of cli
    Command-line interface for importing and exporting ORE data:
    - Import: Load currencies from JSON, XML, or CSV files into database
    - Export: Extract currencies to JSON, XML, or CSV format
    - Temporal Queries: Export data as-of specific timepoints or all versions
    - Filtering: Export specific entities by key
    - Configuration: Boost program_options parser for CLI arguments
    - Database Integration: Direct repository access for data operations
    Organized into: config (option parsing), app (application hosting) namespaces.
    end note

    component [ores.qt] as qt #F7E5FF

    note right of qt
    Modern desktop application built with Qt 6 for visual ORE data management:
    - MDI Interface: Multiple Document Interface with detachable windows
    - Currency Management: List, create, edit, delete currencies with history tracking
    - Authentication: Login dialog with secure password handling
    - Real-time Updates: Asynchronous data loading and server synchronization
    - Entity Controllers: Modular controller pattern for managing entity windows
    - Custom Widgets: Specialized delegates, dialogs, and UI components
    - Background Logo: Customizable MDI area background
    - Connection Status: Visual indication of server connectivity
    MainWindow delegates to entity controllers (e.g., CurrencyController) which manage
    their own MDI windows, dialogs, and data models.
    end note

    component [ores.service] as service #F7E5FF

    note right of service
    Main server application hosting all ORE Studio backend services:
    - Server Hosting: Runs the ORE Studio comms server with SSL/TLS
    - Subsystem Integration: Registers message handlers for accounts, risk, and other subsystems
    - Database Access: Provides database context to all subsystems
    - Configuration: Boost program_options parser for server, database, and logging
    - Concurrent Connections: Supports multiple simultaneous client connections
    - Asynchronous I/O: Built on Boost.Asio coroutines for scalable async operations
    Organized into: config (option parsing and configuration), app (application hosting) namespaces.
    end note
}

' Dependencies - Foundation Layer (ores.database is the base)
variability --> utility
variability --> database

' Dependencies - Infrastructure to Foundation
eventing --> utility
eventing --> database
comms --> utility
comms --> database
comms --> eventing
testing --> utility
testing --> database

' Dependencies - Domain to Foundation/Infrastructure
risk --> utility
risk --> database
iam --> variability
iam --> comms
iam --> utility
iam --> database

' Dependencies - Shell to Foundation/Domain/Infrastructure
shell --> utility
shell --> variability
shell --> iam
shell --> comms

' Dependencies - Applications to all layers
cli --> utility
cli --> variability
cli --> iam
cli --> risk

qt --> utility
qt --> iam
qt --> risk
qt --> comms
qt --> eventing

service --> utility
service --> database
service --> iam
service --> risk
service --> comms
service --> eventing

' Local Variables:
' compile-command: "java -Djava.awt.headless=true -DPLANTUML_SECURITY_PROFILE=UNSECURE -DPLANTUML_LIMIT_SIZE=65535 -jar /usr/share/plantuml/plantuml.jar ores.puml"
' End:
@enduml
