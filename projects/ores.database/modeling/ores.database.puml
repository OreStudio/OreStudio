' -*- mode: plantuml; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*'
'
' Copyright (C) 2025 Marco Craveiro <marco.craveiro@gmail.com>
'
' This program is free software; you can redistribute it and/or modify it under
' the terms of the GNU General Public License as published by the Free Software
' Foundation; either version 3 of the License, or (at your option) any later
' version.
'
' This program is distributed in the hope that it will be useful, but WITHOUT
'  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
' FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
'
' You should have received a copy of the GNU General Public License along with
' GNU Emacs; see the file COPYING. If not, write to the Free Software
' Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
@startuml

title ores.database Component

set namespaceSeparator ::

namespace ores #F2F2F2 {
    note "Database connectivity and health monitoring.\nProvides connection pooling, context management,\nrepository helpers, and database health monitoring services." as ores_database_note
    database --- ores_database_note
    namespace database #F2F2F2 {

        namespace domain #F2F2F2 {
            class context #ECECEC {
                +connection_pool() connection_pool_type
                +credentials() sqlgen::postgres::Credentials
            }

            note top of context
            Context for the operations on a postgres database.

            Holds connection pool and credentials for database operations.
            end note

            struct database_options #F7E5FF {
                +{field} user std::string
                +{field} password rfl::Skip<std::string>
                +{field} host std::string
                +{field} database std::string
                +{field} port int
            }

            note top of database_options
            Configuration for database connection.

            Fields:

            - user: Database user name.
            - password: Password for the user.
            - host: Host to connect to.
            - database: Database to connect to.
            - port: Port the database is listening on.
            end note
        }

        namespace service #F2F2F2 {
            class context_factory #ECECEC {
                +{static} make_context(const configuration&) context
            }

            note top of context_factory
            Generates a new database context.

            Methods:

            - make_context: Creates a database context from configuration.
            end note

            struct configuration #F7E5FF {
                +{field} database_options database::database_options
                +{field} pool_size std::size_t
                +{field} num_attempts std::size_t
                +{field} wait_time_in_seconds std::size_t
            }

            note top of configuration
            Configuration for creating database context.

            Fields:

            - database_options: Database connection options.
            - pool_size: Number of connections in the pool.
            - num_attempts: Number of retry attempts when acquiring a connection.
            - wait_time_in_seconds: Wait time between retry attempts.
            end note

            class health_monitor #ECECEC {
                +health_monitor(database_options, std::chrono::seconds)
                +set_status_change_callback(status_change_callback) void
                +is_available() bool
                +last_error() std::string
                +run(boost::asio::io_context&) boost::asio::awaitable<void>
                +stop() void
                +check_health() bool
            }

            note top of health_monitor
            Monitors database connectivity and provides health status.

            This class periodically checks database connectivity and maintains the
            current health status. It can notify listeners when the status changes,
            allowing the server to inform clients of database availability issues.
            end note

            context_factory +-- configuration
        }

        namespace config #F2F2F2 {
            class database_configuration #ECECEC {
                +{static} make_options_description() boost::program_options::options_description
                +{static} read_options(const boost::program_options::variables_map&) database_options
            }

            note top of database_configuration
            Centralized manager for database configuration parsing.

            Provides utilities for creating command-line option descriptions,
            reading configuration from parsed options, and mapping environment
            variables.
            end note
        }

        namespace repository #F2F2F2 {
            class repository_exception <<exception>> #D6B19F {
            }

            note top of repository_exception
            A fatal error has occurred whilst reading or writing to the
            repository.
            end note

            class version_conflict_exception <<exception>> #D6B19F {
                +version_conflict_exception(entity_type, entity_id, expected_version, actual_version)
                +what() const char*
                +entity_type() std::optional<std::string>
                +entity_id() std::optional<std::string>
                +expected_version() std::optional<int>
                +actual_version() std::optional<int>
            }

            note top of version_conflict_exception
            Exception thrown when an optimistic locking version conflict occurs.

            This exception indicates that an entity update failed because the version
            provided by the client does not match the current version in the database.
            end note
        }

        namespace tests #F2F2F2 {
            class database_options_tests <<test suite>> #C5E1A5 {
                +database_options_to_credentials() void
            }

            note top of database_options_tests
            Test suite for database_options domain model.

            Tests cover conversion to sqlgen credentials.
            end note

            database_options_tests ..> ores::database::domain::database_options : tests
        }

        ' Relationships
        ores::database::service::context_factory ..> ores::database::domain::context : creates
        ores::database::service::context_factory ..> ores::database::domain::database_options : uses
        ores::database::service::health_monitor ..> ores::database::domain::database_options : uses
        ores::database::config::database_configuration ..> ores::database::domain::database_options : creates
    }
}

' Local Variables:
' compile-command: "java -Djava.awt.headless=true -DPLANTUML_SECURITY_PROFILE=UNSECURE -DPLANTUML_LIMIT_SIZE=65535 -jar /usr/share/plantuml/plantuml.jar ores.database.puml"
' End:
@enduml
