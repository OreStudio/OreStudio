:PROPERTIES:
:ID: 9A4009E7-0E6C-11F1-852D-40B0768014EB
:END:
#+title: Sprint Backlog 13
#+options: <:nil c:nil ^:nil d:nil date:nil author:nil toc:nil html-postamble:nil
#+todo: STARTED | COMPLETED CANCELLED POSTPONED BLOCKED
#+tags: { code(c) infra(i) analysis(n) agile(a) }
#+startup: inlineimages

* Sprint Mission

- Add trade support and FSM.

* Stories

** Active

#+begin: clocktable :maxlevel 3 :scope subtree :tags t :indent nil :emphasize nil :scope file :narrow 75 :formula % :block today
#+TBLNAME: today_summary
#+CAPTION: Clock summary at [2026-02-20 Fri 16:14], for Friday, February 20, 2026.
|       | <75>                                  |        |      |      |       |
| Tags  | Headline                              | Time   |      |      |     % |
|-------+---------------------------------------+--------+------+------+-------|
|       | *Total time*                          | *1:02* |      |      | 100.0 |
|-------+---------------------------------------+--------+------+------+-------|
|       | Stories                               | 1:02   |      |      | 100.0 |
|       | Active                                |        | 1:02 |      | 100.0 |
| agile | Sprint and product backlog refinement |        |      | 1:02 | 100.0 |
#+end:

#+begin: clocktable :maxlevel 3 :scope subtree :tags t :indent nil :emphasize nil :scope file :narrow 75 :formula %
#+TBLNAME: sprint_summary
#+CAPTION: Clock summary at [2026-02-20 Fri 15:18]
|       | <75>                                  |        |      |      |       |
| Tags  | Headline                              | Time   |      |      |     % |
|-------+---------------------------------------+--------+------+------+-------|
|       | *Total time*                          | *0:08* |      |      | 100.0 |
|-------+---------------------------------------+--------+------+------+-------|
|       | Stories                               | 0:08   |      |      | 100.0 |
|       | Active                                |        | 0:08 |      | 100.0 |
| agile | Sprint and product backlog refinement |        |      | 0:08 | 100.0 |
#+end:

*** STARTED Sprint and product backlog refinement                     :agile:
    :LOGBOOK:
    CLOCK: [2026-02-20 Fri 16:14]--[2026-02-20 Fri 16:21] =>  0:07
    CLOCK: [2026-02-20 Fri 15:19]--[2026-02-20 Fri 16:13] =>  0:54
    CLOCK: [2026-02-20 Fri 15:10]--[2026-02-20 Fri 15:18] =>  0:08
    :END:

 Updates to sprint and product backlog.

#+begin_src emacs-lisp :exports none
;; agenda
(org-agenda-file-to-front)
#+end_src

#+name: pie-stories-chart
#+begin_src R :var sprint_summary=sprint_summary :colnames yes :results file graphics :exports results :file sprint_backlog_13_stories_pie_sorted.png :width 1920 :height 1080
library(conflicted)
library(ggplot2)
library(tidyverse)
library(tibble)

# Filter to only rows with actual story data (non-empty Tags column)
clean_sprint_summary <- sprint_summary %>% dplyr::filter(!is.na(Tags) & nzchar(Tags))
stories <- unlist(clean_sprint_summary[2])
percent_values <- as.numeric(unlist(clean_sprint_summary[6]))

# Create a data frame and explicitly sort the stories by defining factor levels
df <- data.frame(
  stories = stories,
  percent = percent_values
) %>%
  # 1. Sort the data frame by percentage in descending order
  arrange(desc(percent)) %>%
  # 2. Convert 'stories' to a factor, setting the levels based on the sorted order.
  # This makes the order of the slices explicit for ggplot.
  mutate(
    stories = factor(stories, levels = stories),
    lab.pos = cumsum(percent) - 0.5 * percent
  )

# Manually selected colors to resemble the screenshot
custom_palette <- c(
  "#21518f", "#f37735", "#ffc425", "#81b214", "#d7385e",
  "#662e91", "#00a9ae", "#5c5c5c", "#a0c6e0", "#f8b195",
  "#ffe385", "#bde0fe", "#c5e0d4", "#e0b8a0", "#a56f8f",
  "#7a448a", "#4a9a9b", "#9b9b9b", "#6fa8dc", "#f7a072",
  "#ffd166", "#99d98c", "#ef5d60", "#9d529f", "#3a86ff",
  "#c1d6e1", "#f9e0ac", "#c2d6a4", "#e69a8d", "#a07d9f"
)

# Ensure the palette has enough colors for all stories.
if (length(custom_palette) < length(df$stories)) {
  warning("Not enough custom colors for all stories. Colors will repeat.")
  custom_palette <- rep(custom_palette, length.out = length(df$stories))
}


p <- ggplot(df, aes(x = "", y = percent, fill = stories)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start = 0) +
  scale_fill_manual(values = custom_palette) +
  ggtitle("Sprint 13: Resourcing per Story")  +
  labs(x = NULL, y = NULL, fill = "Stories") +
  theme_minimal() +
  theme(
    axis.text.x = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 18),
    legend.position = "right",
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  )

print(p)
#+end_src

#+RESULTS: pie-stories-chart
[[file:sprint_backlog_13_stories_pie_sorted.png]]

#+name: stories-chart
#+begin_src R :var sprint_summary=sprint_summary :colnames yes :results file graphics :exports results :file sprint_backlog_13_stories.png :width 1200 :height 650
library(conflicted)
library(grid)
library(tidyverse)
library(tibble)

# Filter to only rows with actual story data (non-empty Tags column)
clean_sprint_summary <- sprint_summary %>% dplyr::filter(Tags != "")
names <- unlist(clean_sprint_summary[2])
values <- as.numeric(unlist(clean_sprint_summary[6]))

# Create a data frame.
df <- data.frame(
  cost = values,
  stories = factor(names, levels = names[order(values, decreasing = FALSE)]),
  y = seq(length(names)) * 0.9
)

# Setup the colors
blue <- "#076fa2"

p <- ggplot(df) +
  aes(x = cost, y = stories) +
  geom_col(fill = blue, width = 0.6) +
  ggtitle("Sprint 13: Resourcing per Story") +
  xlab("Resourcing (%)") + ylab("Stories") +
  theme(text = element_text(size = 15))

print(p)
#+end_src

#+RESULTS: stories-chart
[[file:sprint_backlog_13_stories.png]]

#+name: tags-chart
#+begin_src R :var sprint_summary=sprint_summary :colnames yes :results file graphics :exports results :file sprint_backlog_13_tags.png :width 600 :height 400
library(conflicted)
library(grid)
library(tidyverse)
library(tibble)

clean_sprint_summary <- sprint_summary %>% dplyr::filter(Tags != "")
names <- unlist(clean_sprint_summary[1])
values <- as.numeric(unlist(clean_sprint_summary[6]))

df <- data.frame(
  cost = values,
  tags = names,
  y = seq(length(names)) * 0.9
)

df2 <- setNames(aggregate(df$cost, by = list(df$tags), FUN = sum), c("cost", "tags"))

blue <- "#076fa2"

p <- ggplot(df2) +
  aes(x = cost, y = tags) +
  geom_col(fill = blue, width = 0.6) +
  ggtitle("Sprint 13: Resourcing per Tag") +
  xlab("Resourcing (%)") + ylab("Story types") +
  theme(text = element_text(size = 15))

print(p)
#+end_src

#+RESULTS: tags-chart
[[file:sprint_backlog_13_tags.png]]

*** Add high-watermark support                                         :code:

Whenever we request entities, we should also return the watermark for that
entity. This is the highest timestamp of all entities within a set (across all
pages). This is so we can redo the exact same query with an "as of" and get
exactly the same result set. Do some analysis with Claude on how best to do
this. Maybe we should always query as of so that we know what the watermark is
up front.

Notes:

- once we have watermark, we need to add a staleness indicator to all dialogs.
  This will require thresholds. If the data is older than X the staleness
  indicator goes yellow, older than Y it goes red.

*** Redesign Qt ImageCache invalidation strategy                       :code:

Note: this story should only be looked at after we move towards workspaces.

The current ImageCache invalidation approach is brittle and error-prone. When
datasets are published, the cache reload is triggered by pattern-matching
dataset codes (e.g., checking for "flag", "icon", "currenc", "countr" in the
code string). This is fragile because:

- New dataset types require updating the pattern matching logic
- The relationship between datasets and cached data is implicit
- Cache invalidation relies on string matching rather than proper metadata

Proposed improvements:

- Use artefact_type metadata instead of code string matching to determine if
  cache invalidation is needed
- Consider a more general cache invalidation framework that can be extended to
  other caches (ChangeReasonCache, etc.)
- Investigate using server-side notifications to trigger cache invalidation
  (similar to the notification system already in place)
- Document the caching strategy and invalidation rules

Acceptance criteria:

- Cache invalidation is based on structured metadata, not string patterns
- Adding new image-related datasets doesn't require code changes
- Cache invalidation logic is documented and maintainable


*** Replace parent combo boxes with server-side type-ahead search      :code:

The entity detail dialogs (party, counterparty) load all entities into a combo
box for parent selection using a single request with =offset=0, limit=1000=.
If the system has more than 1,000 entities, the dropdown silently truncates
results, meaning users cannot select the correct parent and the hierarchy tree
is incomplete. The same pattern exists for country image maps and lookup
fetchers.

The fix is to replace the plain =QComboBox= with a searchable type-ahead widget
backed by =QCompleter= that issues server-side search requests as the user
types. This is the scalable solution and avoids loading the full dataset into
memory.

Affected locations:

- =CounterpartyDetailOperations.cpp:117= - =load_all_entities()=
- =PartyDetailOperations.cpp:118= - =load_all_entities()=
- =EntityDetailDialog.cpp:346= - =loadCountryImageMap()=
- =LookupFetcher.cpp:80,145= - lookup reference data loading

Note: the =MdiWindow= list views already have proper server-side pagination
via =ClientCounterpartyModel= / =ClientPartyModel=; this issue only affects
detail dialog combo boxes and related data loading.

- Introduce a reusable =SearchableEntityComboBox= widget with =QCompleter=
- Add server-side search endpoints for parties and counterparties
- Replace =load_all_entities()= calls with on-demand search
- Consider the same approach for country and lookup fetcher if volumes warrant it

*** Filter counterparty dataset size for evaluation tenants            :code:

Evaluation tenants currently import too many counterparties from GLEIF data. Add
options to limit the dataset to a configurable percentage or count, providing
enough data to evaluate the system without overwhelming the tenant.

*** Improve tenant deletion safety and cascading                       :code:

Tenant deletion needs proper safeguards and cascading behaviour.

- Deleting any tenant should show an impact summary before proceeding.
- Deleting a tenant should trigger cascading deletion of associated parties.
- Deleting the root tenant should return an error (prevent accidental deletion).

*** Allow super admin to reset tenant admin accounts                   :code:

The super admin currently cannot reset a tenant admin account's password or
credentials. Add this capability to the account management UI.

*** Add tenant type management dialog                                  :code:

There is currently no UI to view or manage tenant types. Add a dialog accessible
from the administration menu to list, view, and edit tenant type reference data.

*** Add shell commands for parties and counterparties                  :code:

The shell currently has no commands for party or counterparty CRUD. Add list,
add, history, and delete commands following the existing shell entity pattern.

Related story: "Add sub-menus to shell".

*** Suppress staging dataset publication warnings                      :code:

Staging datasets (e.g. =gleif.lei_entities.small=, =gleif.lei_relationships.small=)
show confusing "No populate_function for artefact_type" warnings during bundle
publication. These datasets are dependencies that load into staging tables and
don't publish to production directly — this is working as designed. Suppress or
reclassify these log messages to avoid confusion.

*** Add account permissions visibility and tabbed dialog               :code:

Users have no way to see what permissions an account has. The accounts dialog
also needs a tabbed layout to display all available information.

- Add a permissions tab showing effective permissions for the account.
- Use tabbed dialog layout (General, Permissions, Sessions, etc.).
- Clicking on a user should show profile details: admin sees full details, others
  see only key fields (email, etc.).

*** Allow creating new connections from login dialog                   :code:

The login dialog should have a button or link to create a new server connection,
so users don't have to navigate to the connections dialog separately.

*** Polish business centre UI and data quality                         :code:

Several data quality and UI issues with business centres.

- WRLD should have UN flag and source = Internal.
- Hard-code NY* centres (NYFD, NYSE, USNY) to US country.
- Add a city name field parsed from descriptions (regex for parenthesised text).
- Do not display description column by default.
- Country should be a combo box.
- Fix missing country flags.
- Do not display coding scheme column by default.
- Move country column next to code.
- Reduce recorded_at column width.

*** Add validation and ISO compliance flags for reference data         :code:

Several validation gaps and missing metadata in reference data entities.

- It is possible to create a country without a name; likely a currency too. Add
  required field validation.
- Fictional countries should have X prefixes (following ISO 3166 conventions).
- Add an "is ISO compliant" flag (or similar) for currencies and countries that
  are part of the ISO standard vs. custom/internal entries.

*** Standardise Qt window behaviour and UI consistency                 :code:

Several inconsistencies in window behaviour across the application.

- Remove maximise button from MDI child windows.
- Standardise window type: main entity windows should behave the same as
  history/detail dialogs (consistent minimise/maximise button behaviour).
- Generate button should only appear in "new" mode, not "edit".
- Add save button to currency list (needed for generation workflow).
- Add configuration option to disable quit confirmation dialog.
- Allow password visibility toggle in password input fields.

*** Improve session management and server-side housekeeping            :code:

Session tracking and lifecycle management needs improvement.

- Session should record whether telemetry is enabled or not.
- Send and receive byte counters are empty in sessions display.
- Server should periodically housekeep sessions: mark disconnected sessions as
  orphan, mark sessions as finished when connection drops.

*** Reduce duplicated Qt code and clean up technical debt              :code:

Several areas of duplicated code and legacy artefacts that should be cleaned up.

- Qt network error message processing is duplicated across dialogs; extract into
  shared utility.
- Merge common functionality between entities in =ores.qt=.
- Raw SQL in image repository should be replaced with a database function.
- Remove legacy password salt field from accounts.
- Add =ores.analyser= to system model documentation.
- Bootstrap mode flag change does not generate a new version; fix versioning.

*** Expand repository test coverage and infrastructure                 :code:

Test coverage gaps and infrastructure improvements needed.

- No repository tests for change reason entity. Audit all entities for coverage.
- No generators for roles and permissions; add them.
- Test suites should log version at startup. Info script needs to grep log for
  version across all suites.

*** Add version comparison and revert improvements                     :code:

Improvements to entity version history and comparison features.

- In the history diff dialog, add a "from version" combo box that lets users
  compare against any previous version (not just the immediately preceding one).
- Revert-to-version should be a server-side operation taking current version and
  target version parameters.

*** Raise events for account profile updates                           :code:

Updating email from "My Account" does not raise an event. Account profile
changes should emit events through the event bus for consistency with other
entity modifications.

*** Add batch editing with staging workflow                        :analysis:

Investigate a workflow where users can "locally modify" multiple entities and
then save the batch in a single operation. Similar to git's staging concept. Need
to determine appropriate terminology and iconography for this feature. Consider:
what do we call the staged state? What icon represents "stage for save"?

*** Evaluate change reasons for role permission tables             :analysis:

Should role and permission junction tables have change reason support? Analyse
whether the audit trail benefit justifies the additional complexity for these
administrative tables.

*** Add HBAC support for books and portfolios                          :code:

Gemini:

#+begin_quote
In a professional trading system, you are describing Hierarchical Role-Based
Access Control (HRBAC). To make this idiomatic and scalable, you need to
decouple the "Who" (Users/Groups) from the "What" (Portfolios/Books) using an
Access Control List (ACL) that supports Inheritance.

Here is how to structure this to avoid the nightmare of manual user management.

1. The Domain Model: Groups and Roles

Instead of assigning a user directly to a book, you introduce a User Group
(e.g., "North America FX Traders").

- User Group: A collection of Users.
- Role: A collection of Permissions (e.g., View, Trade, Close_Book).
- Access Grant: The link that says Group A has Role X on Portfolio Y.

2. Permission Inheritance (The "Cascading" Rule)

This is the most critical part of your requirement: "Permissioned to a portfolio
= permissioned to all children."

*The Logic*

When a user attempts to access a Book, the system should check for a permission
record at:

- The Book itself.
- If not found, its parent Portfolio.
- If not found, its parent Business Unit, and so on up to the Party.

*The "Effective Permission" Calculation*

In your Qt UI or API, you calculate the Effective Permission.

If I am in the "Senior Managers" group and that group is assigned View access at
the Global Equities Portfolio level, I automatically see every book under it.

- Override Rule: Usually, an explicit "Deny" at a lower level beats an "Allow"
  from a higher level (though most trading systems stick to additive permissions
  for simplicity).

3. Idiomatic Table Structure

To support this in your Postgres schema (with your Staging/Master setup), you
need a permission table that points to your entity hierarchy.

| Column         | Description                                       |
|----------------+---------------------------------------------------|
| Subject_ID     | The ID of the User Group (e.g., "FX_Desk_Group"). |
| Object_Type    | PARTY, PORTFOLIO, or BOOK.                        |
| Object_ID      | The UUID of the specific entity.                  |
| Role_ID        | The Role (e.g., READ_ONLY, FULL_TRADER).          |
| Is_Inheritable | Boolean (usually defaults to True).               |

4. UI Implementation: The "Access" Tab

In your Organization Manager Qt screen, when you select a Portfolio or Book in
the tree, the detail pane should have an "Access Control" tab.

- Inherited Permissions List: A read-only list showing groups that have access
  because of a parent node (e.g., "Group: Risk_Admin (Inherited from: The
  House)").
- Explicit Permissions List: Where you add/remove groups specifically for this
  node.

5. Security and "The House" Context

Since your system runs in the context of "The House" (the Tenant), you need a
"God Role" (System Admin) that is implicitly permissioned at the Party (Root)
level. This ensures you never get locked out of a branch of the tree.

*The "Four-Eyes" for Permissions*

Because permissions are sensitive, changes to this table should also go through
your staging schema.

- Maker: Proposes adding "Group B" to "Portfolio C".
- Checker: Approves the grant.
- Audit: The temporal table tracks exactly when a user gained access to a
  specific book—crucial for regulatory "Who saw what" inquiries.
#+end_quote

*** Understanding Settlements and SSI                              :analysis:

This is a very complicated topic. We should try to summarise it and see what is
the smallest subset that we need in order to see full trade lifecycle.

Links:

- [[https://www.cslucas.com/user-guide/how-to-set-up-counterparty-ssi/][How to Set Up Counterparty SSI]]
- [[https://docs.oracle.com/cd/E99951_01/html/Settlements/Settlements_Manual_Intro_002.htm][Settlements Service]]

*** Add ISO 20022 Support                                              :code:

As per Gemini:

#+begin_quote
Summary Mapping for your C++ Logic

| Internal Event  | ISO 20022 Message | Action                                          |
|-----------------+-------------------+-------------------------------------------------|
| TradeExecuted   | fxtr.014          | Confirm terms with counterparty.                |
| Send Funds      | pacs.009          | Instruct the  bank to move cash.                |
| Check Progress  | pacs.002          | Update UI "Settlement Status" to 'In Progress'. |
| Funds Confirmed | camt.054          | Update UI to 'Settled'.                         |
| EOD Reconcile   | camt.053          | Verify internal ledger vs bank balance.         |
|                 |                   |                                                 |

Pro-Tip for your Implementation: Since you're using C++, don't try to build
every message at once:

- Start with pacs.009 (Sending money).
- Follow with pacs.002 (Handling the response).
- Add camt.053 (Reconciling at night).

*ISO 20022 Asset Class Mapping*

If you move beyond FX, you switch "prefixes." Here is how the ISO 20022 world is
carved up:

| Message Prefix | Asset Class / Domain  | Example Use Case                                     |
|----------------+-----------------------+------------------------------------------------------|
| fxtr           | Foreign Exchange      | "Spot, Forwards, NDFs, FX Swaps."                    |
| sese           | Securities Settlement | "Settlement of Equities, Bonds, ETNs."               |
| semt           | Securities Management | "Custody statements, holding reports."               |
| setr           | Securities Trade      | Trade capture/subscription for Mutual Funds.         |
| auth           | Regulatory Reporting  | "OTC Derivatives (IRS, CDS), Transaction reporting." |
| pacs           | Payments              | The cash resulting from any of the above.            |

*FPML vs ISO 20022*

For Swaps and other Derivatives, the messaging is split between Trade Reporting
and Lifecycle/Confirmation.

- auth (Authorities): In the modern MX world, Interest Rate Swaps are largely
  reported using the auth series (specifically under EMIR or MiFIR regulations).
  - auth.030: Derived from the "Trade Reporting" business area, used for
    Reporting of OTC derivatives.
- FpML (The "De Facto" standard): As we discussed earlier, while ISO 20022 has
  auth messages for regulation, FpML remains the industry standard for the
  actual bilateral confirmation of IRS trades. Most modern systems use FpML for
  the "contract" and then use pacs for the resulting cash flows.

| Feature         | FpML (Financial products Markup Language)                                   | ISO 20022 (MX)                                                          |
|-----------------+-----------------------------------------------------------------------------+-------------------------------------------------------------------------|
| Primary Domain  | "Derivatives & OTC Trades (Swaps, Options, Forwards)."                      | Payments & Securities Settlement.                                       |
| Focus           | "The economics of the trade (strike price, tenors, floating rate indexes)." | "The movement of value (sender, receiver, amount, intermediary banks)." |
| Lifecycle Stage | "Front-to-Middle Office: Execution, Affirmation, and Confirmation."         | "Back Office: Payment clearing, settlement, and reporting."             |
| Complexity      | Extremely deep. Can describe a 30-year complex interest rate swap.          | Broad. Designed to move money across any border or system.              |
#+end_quote

*** Extend login flow with party selection                             :code:

After authentication, look up the user's associated parties from
=account_parties=. If one party, auto-select. If multiple, return the party list
to the client for selection. The client displays a party picker widget. After
selection, compute the visible party set and bind to the session.

**** Acceptance Criteria

- Login response includes available parties.
- Party picker displayed when user has multiple parties.
- Selected party stored in session and displayed in application window.
- Party context immutable for session lifetime.


*** Add party role scheme entity                                       :code:

The following is the analysis for adding support to party schemes.

Contains a code representing a related party role. This can be extended to
provide custom roles.

- Obtained on 2025-11-10.
- Version 4-1.
- URL: http://www.fpml.org/coding-scheme/party-role-4-1.xml

Code
Description

- Code: Accountant
- Description: Organization responsible for preparing the accounting for the
  trade.

- Code: Allocation
- Description: Agent The organization responsible for supplying the allocations
  for a trade to be allocated to multiple accounts/organizations.

- Code: Arranging
- Description: Broker The organization that arranged the trade, i.e. brought
  together the counterparties. Synonyms/Alternatives: Inter-dealer broker,
  agent.

- Code: Beneficiary
- Description: Organization that suffers the economic benefit of the trade. The
  beneficiary may be distinct from the principal/counterparty - an example
  occurs when a hedge fund trades via a prime broker; in this case the principal
  is the prime broker, but the beneficiary is the hedge fund. This can be
  represented as a payer/receiver account in the name of the hedge fund, but it
  is also possible to add the party role of "Beneficiary" at the
  partyTradeInformation level.

- Code: Booking
- Description: Party The entity for which the organization supporting the
  trade's processing has booked/recorded the trade. This is used in
  non-reporting workflows situations in which the trade doesn't need to be
  reported but a firm still wants to specify their own side.

- Code: Buyer
- Description: Acquirer of the legal title to the financial instrument. In the
  case of an option, the buyer is the holder of the option. In the case of a
  swap or forward, the buyer will be determined by industry best practice. This
  does not refer to an investor or investment manager or other organization on
  what is typically called the "Buy side"; for that, see the "Client" role.
  Corresponds to "Buyer" as defined in certain regulations such as ESMA MiFID
  II/MIFIR RTS 22 field 9.

- Code: Buyer
- Description: DecisionMaker The party or person who, having legal authority to
  act on behalf of the trade counterparty acting as Buyer as defined in this
  coding scheme, made the decision to acquire the financial instrument.
  Corresponds to "buyer decision maker" as defined in ESMA's MIFIR RTS 23
  report. This does not refer to the decision maker for what is traditionally
  called the "Buy side"; for that, see the "Client Decision Maker" role.

- Code: Clearing
- Description: Client An organization that clears trades through a clearing
  house, via a clearing broker (member of the clearing house) who acts as an
  agent on its behalf. The term "client" refers to the organization's role in
  the clearing process in relation to its clearing broker, and not whether it is
  a price maker or taker in the execution process.

- Code: Clearing
- Description: ExceptionParty A party to the trade that claims a clearing
  exception, such as an end-user exception under Dodd-Frank Act provisions.

- Code: Clearing
- Description: Firm Organization that submits the trade to a clearing house on
  behalf of the principal. Synonyms/alternates: Futures Commission Merchant
  (FCM), Clearing Broker, Clearing Member Firm. Some implementations use
  "Clearing Broker" as synonym.

- Code: Clearing
- Description: Organization The organization that acts as a central counterparty
  to clear a derivatives contract. This is used to represent the role of Central
  Counterparties (CCPs) or Derivative Clearing Organizations (DCOs). Sometimes
  called "ClearingService". Some implementations also use the term "Clearer".

- Code: Client
- Description: Client as defined under ESMA MIFIR. This is generally the
  investor or other client of an investment firm, and is synonymous with the
  Beneficiary in many circumstances.

- Code: Client
- Description: DecisionMaker The party or person who, having legal authority to
  act on behalf of a trade counterparty, made the decision to acquire or sell
  the financial instrument.

- Code: Confirmation
- Description: Platform Organization serving as a financial intermediary for the
  purposes of electronic confirmation or providing services for post-processing
  of transactional data.

- Code: Contractual
- Description: Party A party to a contractual document. If the intended usage
  relates to the context of the trade lifecycle, more specific annotations have
  been defined which might be more appropriate.

- Code: Counterparty
- Description: An economic counterparty to the trade. Synonym: principal.

- Code: Counter
- Description: PartyAffiliate Organization offiially attached to the
  counterparty. e.g. partner, branch, subsidiary.

- Code: Counter
- Description: PartyUltimateParent The topmost entity or organization, within
  the corporate hierarchy, responsible for the reporting party.

- Code: Credit
- Description: SupportProvider Organization that enhances the credit of another
  organization (similar to guarantor, but may not fully guarantee the
  obligation).

- Code: Custodian
- Description: Organization that maintains custody of the asset represented by
  the trade on behalf of the owner/principal.

- Code: Data
- Description: Submitter Entity submitting the transaction report to the
  competent authority.

- Code: Disputing
- Description: Party Organization that is disputing the trade or transaction.

- Code: Document
- Description: Repository A marketplace organization which purpose is to
  maintain document records. If the intended usage relates to the context of the
  trade lifecycle, more specific annotations have been defined which might be
  more appropriate.

- Code: Executing
- Description: Broker The (generally sell-side) organization that executed the
  trade; the price-making party.

- Code: Executing
- Description: Entity Entity executing the transaction. If the transaction is
  executed directly by the reporting party, it will be the reporting party. If
  it is executed by an execution agent or an affiliated party on behalf of the
  reporting party, it will be that affiliate or agent.

- Code: Execution
- Description: Agent The (generally buy-side) organization that acts to execute
  trades on behalf of an investor. Typically this is an investment manager or
  asset manager, and also makes the investment decisions for the investor. If
  required, a separate InvestmentDecision role can be specified to distinguish
  that the party making the investment decision is different.

- Code: Execution
- Description: Facility The facility, exchange, or market where the trade was
  executed. Synonym: Swap Execution Facility, Designated Contract Market,
  Execution Venue.

- Code: Guarantor
- Description: Organization that backs (guarantees) the credit risk of the
  trade.

- Code: Margin
- Description: Affiliate Margin affiliate as defined by U.S. margin and capital
  rules §23.151.

- Code: Order
- Description: Transmitter The entity transmitting the order to the reporting
  firm. Synonym: Transmitting Firm.

- Code: Prime
- Description: Broker The organization that takes on or took on the credit risk
  for this trade by stepping in between the two economic parties (without a
  central counterparty clearing mechanism).

- Code: Prior
- Description: TradeRepository The trade repository at which the trade was
  reported previous to the current trade repository.

- Code: PTRR
- Description: CompressionProvider A party providing a post trade risk reduction
  service in the form of compression.

- Code: PTRR
- Description: RebalancingProvider A party providing a post trade risk reduction
  service in the form of portfolio rebalancing.

- Code: Publication
- Description: Venue The reporting service (whether trade repository, market
  data service, or exchange/facility/venue data distribution service) that
  published the report of this trade.

- Code: Reporting
- Description: Party The party with the regulatory responsibility to report this
  trade.

- Code: Reporting
- Description: PartyAffiliate Organization offiially attached to the reporting
  party e.g. partner, branch, subsidiary.

- Code: Reporting
- Description: PartyUltimateParent The topmost entity or organization, within
  the corporate hierarchy, responsible for the reporting party.

- Code: Seller
- Description: A counterparty in a trade, which performs in one of the following
  capacities: 1) it transfers or agrees to transfer in the future an instrument
  or title to that instrument in exchange for payment, 2) it writes a
  derivatives instrument such as an option or a swap in which it provides risk
  protection to the buyer. This does not refer to the broker/dealer or other
  organization on what is typically called the "Sell side"; for that, see the
  "Executing Broker" role. Corresponds to "Seller" as defined in certain
  regulations such as ESMA MiFID II/MIFIR RTS 22 field 16.

- Code: Seller
- Description: DecisionMaker The party or person who, having legal authority to
  act on behalf of the trade counterparty acting as Seller as defined in this
  coding scheme, made the decision to sell the financial instrument. Corresponds
  to "seller decision maker" as defined in ESMA's MIFIR RTS 23 report. This does
  not refer to the decision maker for what is traditionally called the "Sell
  side"; for that, see the "Trader" person role.

- Code: Settlement
- Description: Agent The organization that makes or receives payments on behalf
  of the given principal party.

- Code: Trade
- Description: Repository An organization that maintains records of the trade
  for regulatory reporting purposes.

- Code: Trade
- Description: Source The organization that originally supplied the record of
  the trade. In the context of regulatory reporting, it is the submitter of the
  trade record to a regulator or TR.

- Code: Trading
- Description: Manager The entity responsible for managing the
  assets/investments of this party. Synonnym: Asset Manager, Investment Manager,
  Trading Advisory.

- Code: Trading
- Description: Partner An entity with which this party trades from time to time,
  ie. with which it acts as a counterparty on some transactions. This role is
  used for static reference data, not individual transactions.


*** Accounts need to have a human or robot field                       :code:

Look for correct terminology (actor type?).


*** Add sub-menus to shell                                             :code:

There are a lot of entries in the shell main menu, we need to group them. These
could be based on the component.

Notes:

- shell has no parties or counterparties commands.
- It should be possible to set the "output type" or format in the shell, from
  json to table. Find the correct terminology for this.

*** System provisioner needs an icon                                   :code:

Dialog is using default ORE icon.

*** Add a organisation type scheme entity                              :code:

Indicates a type of organization.

- Obtained on 2016-06-13
- Version 2-0
- URL: http://www.fpml.org/coding-scheme/organization-type-2-0.xml

- Code: MSP
- Name: Major Swap Participant
- Description: A significant participant in the swaps market, for example as
  defined by the Dodd-Frank Act.

- Code: NaturalPerson
- Name: Natural Person
- Description: A human being.

- Code: non-SD/MSP
- Name: Non Swap Dealer or Major Swap Participant
- Description: A firm that is neither a swap dealer nor a major swaps participant under the Dodd-Frank Act.

- Code: SD
- Name: Swap Dealer
- Description: Registered swap dealer.

*** Add currency and country party-visibility junctions                :code:

Add junction tables (=party_currencies=, =party_countries=) that control which
currencies and countries a given party can see and use. The underlying reference
data definitions remain shared at the tenant level; only visibility is
per-party.

**** Acceptance Criteria

- Junction tables created with proper constraints.
- Party-scoped queries for currencies and countries filter through junctions.
- Default: all currencies/countries visible to all parties (opt-in restriction).

*** Update currency details to use tabs                                :code:

We need a main tab with the currency related properties, then a "system" tab
with temporal data which is read-only even on edit and a "image" tab with the
image used to represent the currency. It could also contain some description or
notes.

*** Currencies: Currency Taxonomy Enrichment                           :code:

- Goal: Enhance the ores_refdata_currencies_tbl to support logical grouping,
  reporting, and basic behavior defaults.
- Requirements:
  - Field 1: asset_class (Enum/Varchar)
    Purpose: Defines the nature of the instrument.
    Allowed Values: fiat, commodity (for XAU/XAG), synthetic, supranational.
  - Field 2: market_tier (Enum/Varchar)
    Purpose: Drives UI priority, liquidity expectations, and risk limits.
    Allowed Values: majors (g10), emerging, exotic, frontier, historical.
- Example Entries:
  : USD | fiat | g10
  :  BRL | fiat | emerging

*** Currencies: Party-Specific Settlement Rules                        :code:

- Goal: Define the "Where." This models what a specific "House" entity (or
  child) is capable of doing.
- Table: =ores_refdata_settlement_capabilities=.
- Logic: Does "London Desk" have a local Vostro account for "BRL"?

| Field Name              | Type       | Description                                                                        |
|-------------------------+------------+------------------------------------------------------------------------------------|
| capability_id           | UUID       | PK                                                                                 |
| party_id                | INT/FK     | Reference to internal parties. This can be "The House" or a specific child entity. |
| currency_code           | CHAR(3)/FK | Reference to =ores_refdata_currencies_tbl=.                                        |
| can_settle_physically   | Boolean    | If true we can settle in this currency.                                            |
| can_cash_settle         | Boolean    | If true, we can settle in cash on another currency.                                |
| default_settlement_mode | ENUM       | physical (Deliverable) or cash_settled (Non-Deliverable/NDF).                      |
| is_active               | BOOL       | To disable capabilities if an account is frozen or closed.                         |

Then, to determine which account to use to settle we need something like
=ores_refdata_party_nostro_accounts=:

| Field          | Description                                             |
|----------------+---------------------------------------------------------|
| party_id       | Which branch of yours owns this account?                |
| currency_code  | The currency of the account.                            |
| agent_bank_id  | The external bank (e.g., HSBC, Citi).                   |
| account_number | The actual IBAN/Account string.                         |
| is_primary     | Boolean to tell the system which one to use by default. |
| purpose        | "ENUM: General, CLS, Intercompany, Custody."            |

This tells us what account to use when settlement comes. We cannot have a
capability without at least one account.

Then, for each currency which can be cash settled, we need to know into which
currencies they can be cash settled. For that we have
=ores_refdata_settlement_cash_options=. This is a Junction Table that defines
the valid "Settlement Pairs." This table answers: "If we are cash-settling
Currency X, what are the allowed 'Destination' currencies for this House
Entity?"

| Schema              | FieldType | Description                                                       |
|---------------------+-----------+-------------------------------------------------------------------|
| capability_id       | FK        | Links to =ores_refdata_settlement_capabilities=.                  |
| settlement_currency | CHAR(3)   | The "Destination" currency (e.g., USD, EUR).                      |
| is_primary          | BOOLEAN   | The default currency the desk prefers to use for NDFs.            |
| fixing_source_id    | FK        | Which index provides the rate to convert X to the Settlement CCY? |

If cash settled is true, we must have a corresponding entry in this table.

**** The "Relative" Logic Requirement:

The system must perform a Hierarchical Lookup: Check for a rule specific to the
Child Party + Currency. If not found, check for a rule for The House +
Currency. If still not found, default to physical for g10 and cash_settled for
exotic.

*** Currencies: Contractual Settlement (The "Agreements" Table)        :code:

- Goal: Define the "How." This is the bridge you mentioned for specific
  counterparties.
- Table: =ores_refdata_settlement_agreements.=
- Logic: "Even though London can settle NDFs, for this specific Hedge Fund, we
  always settle in USD."

Fields:

| Schema                 | Description             |
|------------------------+-------------------------|
| party_id               | Our side.               |
| counterparty_id        | Their side.             |
| currency_code          | The currency.           |
| agreed_settlement_type | NDF, Physical, Net_USD. |
| agreement_ref          | e.g., "ISDA-2023-GS".   |



* Footer

| Previous: [[id:1B387E8C-8EC1-4C2A-A321-1593C35A9A77][Sprint Backlog 12]] |
