Data Sourcing and Generation Steps:

1. SOURCE DATA DOWNLOAD
   Option A - Automatic download via script:
     Script: projects/ores.codegen/src/lei_extract_subset.py --download-only
     Command: python3 lei_extract_subset.py --download-only
     Output: Downloads to external/lei/

   Option B - Manual download:
     Visit: https://www.gleif.org/en/lei-data/gleif-golden-copy/download-the-golden-copy
     Download: LEI-CDF v3.1 (Concatenated File) and RR-CDF v2.1
     Extract: Unzip into external/lei/

2. GENERATE SUBSET FILES
   Script: projects/ores.codegen/scripts/generate_lei_subsets.sh
   Command: ./generate_lei_subsets.sh
   Output: Both small and large subsets in external/lei/

   Or generate specific sizes:
     ./generate_lei_subsets.sh --small    # Small subset only
     ./generate_lei_subsets.sh --large    # Large subset only

3. COMMIT TO REPOSITORY
   Note: Full LEI files are too large to commit (~4.3 GB).
   Only subset files should be committed.

   git add external/lei/*-subset-small.csv
   git add external/lei/*-subset-large.csv
   git commit -m "[data] Update LEI subset files"

SUBSET GENERATION METHODOLOGY
-----------------------------
The subset extractor creates diverse, representative subsets for testing by
sampling across multiple dimensions:

1. Geographic Diversity
   - Samples entities from all ~235 countries in the dataset
   - Configurable entities per country (small: 20, large: 60)

2. Entity Category Diversity
   - GENERAL (corporations, LLCs)
   - FUND (investment funds)
   - SOLE_PROPRIETOR
   - RESIDENT_GOVERNMENT_ENTITY
   - BRANCH
   - INTERNATIONAL_ORGANIZATION

3. Sector Diversity (detected from entity names via keywords)
   - Financial: BANK, INSURANCE, BROKER_DEALER, ASSET_MANAGEMENT
   - Funds: INVESTMENT_FUND, ETF, HEDGE_FUND, PRIVATE_EQUITY, PENSION
   - Industrial: ENERGY, MANUFACTURING, MINING, CONSTRUCTION
   - Services: TECHNOLOGY, HEALTHCARE, RETAIL, TELECOM
   - Other: REAL_ESTATE, AEROSPACE, SHIPPING, AGRICULTURE, MEDIA

4. Fund Type Diversity (for FUND entities)
   - ETF, BOND, EQUITY, INDEX, MONEY_MARKET
   - BALANCED, COMMODITY, REAL_ESTATE
   - GLOBAL, EMERGING_MARKETS

5. Relationship Depth
   - Entities with 0 children (standalone)
   - Entities with 1-4 children (small groups)
   - Entities with 5+ children (large corporate groups)

6. Hierarchy Completeness
   - After sampling, adds all children of selected parents
   - Adds all parents of selected children
   - Ensures complete parent-child relationships in subset

SIZE PRESETS
------------
Small (~10K entities):
  per_country=20, per_depth=10, per_sector=15
  per_category=20, per_fund_type=10, per_legal_form=5

Large (~50K entities):
  per_country=60, per_depth=30, per_sector=40
  per_category=60, per_fund_type=30, per_legal_form=10

4. GENERATE SQL POPULATE FILES
   Script: projects/ores.codegen/scripts/generate_lei_metadata.sh
   Command: ./generate_lei_metadata.sh
   Or directly: python3 projects/ores.codegen/src/lei_generate_metadata_sql.py

   The generator reads CSV subset files and the manifest (external/lei/manifest.json)
   to produce SQL populate scripts in projects/ores.sql/populate/lei/:

   Source file types and their target artefact tables:
   - LEI2 (lei2-golden-copy) CSV → ores_dq_lei_entities_artefact_tbl
     Entity master data: LEI code, legal name, entity category, legal form,
     jurisdiction, legal and headquarters addresses, registration metadata.
   - RR (rr-golden-copy) CSV → ores_dq_lei_relationships_artefact_tbl
     Corporate hierarchy: parent-child relationships (IS_DIRECTLY_CONSOLIDATED_BY,
     IS_ULTIMATELY_CONSOLIDATED_BY), relationship status and period dates.

   Generated files:
   - lei_catalog_populate.sql          - GLEIF catalog registration
   - lei_methodology_populate.sql      - Methodology registration
   - lei_dataset_populate.sql          - 4 dataset registrations (entities/relationships x small/large)
   - lei_dataset_dependency_populate.sql - 2 dataset dependencies
   - lei_entities_small_artefact_populate.sql  - Entity artefact data (~6K rows)
   - lei_entities_large_artefact_populate.sql  - Entity artefact data (~15K rows)
   - lei_relationships_small_artefact_populate.sql - Relationship artefact data (~2K rows)
   - lei_relationships_large_artefact_populate.sql - Relationship artefact data (~4K rows)
   - lei_populate.sql                  - Master include in dependency order

   Each artefact populate file uses PL/pgSQL with VALUES clauses for idempotent
   bulk insertion: lookup dataset_id, DELETE existing, INSERT from VALUES.

5. COMMIT GENERATED SQL
   git add projects/ores.sql/populate/lei/
   git commit -m "[sql] Generate LEI populate files"
