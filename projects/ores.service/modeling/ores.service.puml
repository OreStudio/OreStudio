' -*- mode: plantuml; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-
'
' Copyright (C) 2025 Marco Craveiro <marco.craveiro@gmail.com>
'
' This program is free software; you can redistribute it and/or modify it under
' the terms of the GNU General Public License as published by the Free Software
' Foundation; either version 3 of the License, or (at your option) any later
' version.
'
' This program is distributed in the hope that it will be useful, but WITHOUT
'  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
' FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
'
' You should have received a copy of the GNU General Public License along with
' GNU Emacs; see the file COPYING. If not, write to the Free Software
' Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
@startuml
!pragma layout smetana

title ores.service Component

set namespaceSeparator ::

namespace ores #F2F2F2 {
    note "Main service for ORE Studio." as ores_service_note
    service --- ores_service_note
    namespace service #F2F2F2 {
        note "Contains configuration-related entities." as ores_service_config_note
        config --- ores_service_config_note
        namespace config #F2F2F2 {
            '
            ' Layout groupings
            '

            together {
                class parser_exception
                class parser
            }

            together {
                class server_options
                class options
            }

            parser_exception -[hidden]down- parser
            server_options -[hidden]down- options

            '
            ' Class definitions
            '

            class parser_exception <<exception>> #D6B19F {
                +parser_exception(std::string_view message)
                +what() const : const char*
                -{field} message_ : std::string
            }

            note top of parser_exception
            A fatal error has occurred during option parsing.
            end note

            class parser #ECECEC {
                +parse(const std::vector<std::string>& arguments, std::ostream& info, std::ostream& error) const : std::optional<options>
            }
            parser ..> ores::service::config::options

            note top of parser
            Command-line parser implementation using boost program options.

            Note on logging: we are NOT logging any of the exceptions to the log in this
            class. This is by design. The logger is only initialised after the options
            have been parsed; were we to log prior to this, we would dump all the
            messages into the console. The output is very confusing for users that are
            accustomed to normal command line applications.
            end note

            class server_options #F7E5FF {
                +{field} port : std::uint16_t
                +{field} max_connections : std::uint32_t
                +{field} certificate_file : std::string
                +{field} private_key_file : std::string
                +{field} server_identifier : std::string
            }

            note top of server_options
            Configuration options for the ORES server.

            Fields:

            - port: Port to listen on.
            - max_connections: Maximum number of concurrent connections.
            - certificate_file: Path to SSL certificate file.
            - private_key_file: Path to SSL private key file.
            - server_identifier: Server identifier for handshake.
            end note

            class options #F7E5FF {
                +{field} logging : std::optional<ores::utility::log::logging_options>
                +{field} server : server_options
                +{field} database : ores::database::database_options
            }
            options o-- ores::service::config::server_options

            note top of options
            All of the configuration options required by the service.

            Fields:

            - logging: Configuration options related to logging, if any.
            - server: Configuration related to server operations.
            - database: Configuration related to database operations.
            end note
        }

        note "Contains application-related entities." as ores_service_app_note
        app --- ores_service_app_note
        namespace app #F2F2F2 {
            '
            ' Layout groupings
            '

            together {
                class application_exception
                class application
                class host
            }

            application_exception -[hidden]down- application
            application -[hidden]down- host

            '
            ' Class definitions
            '

            class application_exception <<exception>> #D6B19F {
                +application_exception(std::string_view message)
                +what() const : const char*
                -{field} message_ : std::string
            }

            note top of application_exception
            A fatal error has occurred whilst the application was running.
            end note

            class application #ECECEC {
                +application()
                +application(const application&) = delete
                +operator=(const application&) = delete : application&
                -{method} make_context(const std::optional<database::database_options>& db_opts) : utility::repository::context
                +run(boost::asio::io_context& io_ctx, const config::options& cfg) const : boost::asio::awaitable<void>
            }
            application ..> ores::service::config::options

            note top of application
            Entry point for the ores service application.

            Orchestrates:
            - Database context and system flag initialization
            - Event bus and postgres_event_source setup
            - Subscription manager for client notifications
            - Server startup with all subsystem handlers

            Event flow:
            1. PostgreSQL NOTIFY triggers -> postgres_event_source
            2. postgres_event_source -> event_bus (typed domain events)
            3. event_bus -> subscription_manager (via callbacks)
            4. subscription_manager -> client sessions (server-push)
            end note

            application ..> ores::eventing::service::event_bus : creates
            application ..> ores::eventing::service::postgres_event_source : creates
            application ..> ores::comms::service::subscription_manager : creates
            application ..> ores::comms::service::subscription_handler : creates
            application ..> ores::comms::net::server : creates

            class host #ECECEC {
                +{method} execute(const std::vector<std::string>& args, std::ostream& std_output, std::ostream& error_output, boost::asio::io_context& io_ctx) : boost::asio::awaitable<int>
            }

            note top of host
            Provides hosting services to the application.
            end note
        }
    }
}

' Local Variables:
' compile-command: "java -Djava.awt.headless=true -DPLANTUML_SECURITY_PROFILE=UNSECURE -DPLANTUML_LIMIT_SIZE=65535 -jar /usr/share/plantuml/plantuml.jar ores.service.puml"
' End:
@enduml
