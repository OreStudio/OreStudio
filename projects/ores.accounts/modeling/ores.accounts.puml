' -*- mode: plantuml; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*'
'
' Copyright (C) 2025 Marco Craveiro <marco.craveiro@gmail.com>
'
' This program is free software; you can redistribute it and/or modify it under
' the terms of the GNU General Public License as published by the Free Software
' Foundation; either version 3 of the License, or (at your option) any later
' version.
'
' This program is distributed in the hope that it will be useful, but WITHOUT
'  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
' FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
'
' You should have received a copy of the GNU General Public License along with
' GNU Emacs; see the file COPYING. If not, write to the Free Software
' Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
@startuml

title ores.accounts Component

set namespaceSeparator ::

namespace ores #F2F2F2 {
    note "Account management module for ORE Studio.\n\nThis module provides functionality for managing user accounts including\nauthentication, authorization, and login tracking." as ores_accounts_note
    accounts --- ores_accounts_note
    namespace accounts #F2F2F2 {
        namespace domain #F2F2F2 {
            '
            ' Layout groupings
            '

             ' together {
             '     class account
             '     class login_info
             ' }

            account -[hidden]down- login_info

            '
            ' Class definitions
            '

            class account #F7E5FF {
                +{field} version int
                +{field} modified_by std::string
                +{field} id boost::uuids::uuid
                +{field} username std::string
                +{field} password_hash std::string
                +{field} password_salt std::string
                +{field} totp_secret std::string
                +{field} email std::string
                +{field} is_admin bool
            }

            note top of account
            Represents a user account in the system.

            Fields:

            - version: Version number for optimistic locking and change tracking.
            - modified_by: Username of the user who last modified this account.
            - id: Unique identifier for the account.
            - username: Unique username for login purposes.
            - password_hash: Hashed password for secure authentication.
            - password_salt: Salt used in password hashing for additional security.
            - totp_secret: Time-based One-Time Password secret for two-factor authentication.
            - email: Email address associated with the account.
            - is_admin: Flag indicating whether the account has administrative privileges.
            end note

            class login_info #F7E5FF {
                +{field} account_id boost::uuids::uuid
                +{field} last_ip boost::asio::ip::address
                +{field} last_attempt_ip boost::asio::ip::address
                +{field} failed_logins int
                +{field} locked bool
                +{field} last_login std::chrono::system_clock::time_point
                +{field} online bool
            }

            note top of login_info
            Represents login tracking and security information for an account.

            Fields:

            - account_id: Foreign key referencing the associated account.
            - last_ip: IP address from the last successful login.
            - last_attempt_ip: IP address from the most recent login attempt (successful or failed).
            - failed_logins: Count of consecutive failed login attempts since last successful login.
            - locked: Flag indicating whether the account is locked due to security concerns.
            - last_login: Timestamp of the last successful login.
            - online: Flag indicating whether the user is currently logged in.
            end note

            login_info --> ores::accounts::domain::account
        }

        namespace eventing #F2F2F2 {
            '
            ' Layout groupings
            '

            together {
                class role_assigned_event
                class role_revoked_event
                class permissions_changed_event
            }

            role_assigned_event -[hidden]down- role_revoked_event
            role_revoked_event -[hidden]down- permissions_changed_event

            '
            ' Class definitions
            '

            class role_assigned_event #F7E5FF {
                +{field} account_id boost::uuids::uuid
                +{field} role_id boost::uuids::uuid
                +{field} timestamp std::chrono::system_clock::time_point
            }

            note top of role_assigned_event
            Event published when a role is assigned to an account.
            end note

            class role_revoked_event #F7E5FF {
                +{field} account_id boost::uuids::uuid
                +{field} role_id boost::uuids::uuid
                +{field} timestamp std::chrono::system_clock::time_point
            }

            note top of role_revoked_event
            Event published when a role is revoked from an account.
            end note

            class permissions_changed_event #F7E5FF {
                +{field} account_id boost::uuids::uuid
                +{field} timestamp std::chrono::system_clock::time_point
            }

            note top of permissions_changed_event
            Event published when an account's effective permissions change.
            end note
        }

        namespace domain::rbac #F2F2F2 {
            '
            ' Layout groupings
            '

            together {
                class permission
                class role
            }

            together {
                class account_role
                class role_permission
            }

            permission -[hidden]down- account_role
            role -[hidden]down- role_permission

            '
            ' Class definitions
            '

            class permission #F7E5FF {
                +{field} id boost::uuids::uuid
                +{field} code std::string
                +{field} description std::string
            }

            note top of permission
            Represents an atomic permission that can be granted to roles.

            Fields:

            - id: Unique identifier for the permission.
            - code: Permission code (e.g., "accounts:create").
            - description: Human-readable description.
            end note

            class role #F7E5FF {
                +{field} version int
                +{field} id boost::uuids::uuid
                +{field} name std::string
                +{field} description std::string
                +{field} recorded_by std::string
                +{field} recorded_at std::string
                +{field} permission_codes std::vector<std::string>
            }

            note top of role
            Represents a named collection of permissions.

            Fields:

            - version: Version number for optimistic locking.
            - id: Unique identifier for the role.
            - name: Unique name (e.g., "Trading", "Admin").
            - description: Human-readable description.
            - recorded_by: Username who last modified.
            - recorded_at: Timestamp of last modification.
            - permission_codes: Denormalized list of permission codes.
            end note

            class account_role #F7E5FF {
                +{field} account_id boost::uuids::uuid
                +{field} role_id boost::uuids::uuid
                +{field} assigned_by std::string
                +{field} assigned_at std::string
            }

            note top of account_role
            Junction entity linking accounts to roles.

            Fields:

            - account_id: The account receiving the role.
            - role_id: The role being assigned.
            - assigned_by: Username who assigned this role.
            - assigned_at: Timestamp of assignment.
            end note

            class role_permission #F7E5FF {
                +{field} role_id boost::uuids::uuid
                +{field} permission_id boost::uuids::uuid
            }

            note top of role_permission
            Junction entity linking roles to permissions.

            Fields:

            - role_id: The role receiving the permission.
            - permission_id: The permission being granted.
            end note

            ' Relationships
            role o-- ores::accounts::domain::rbac::permission : has
            account_role --> ores::accounts::domain::account
            account_role --> ores::accounts::domain::rbac::role
            role_permission --> ores::accounts::domain::rbac::role
            role_permission --> ores::accounts::domain::rbac::permission
        }

        namespace repository #F2F2F2 {
            '
            ' Layout groupings
            '

            ' Group: Account persistence
             ' together {
             '     class account_entity
             '     class account_mapper
             '     class account_repository
             ' }

            ' Group: Login info persistence
             ' together {
             '     class login_info_entity
             '     class login_info_mapper
             '     class login_info_repository
             ' }

            ' Stack account classes vertically
            account_entity -[hidden]down- account_mapper
            account_mapper -[hidden]down- account_repository

            ' Stack login_info classes vertically
            login_info_entity -[hidden]down- login_info_mapper
            login_info_mapper -[hidden]down- login_info_repository

            '
            ' Class definitions
            '

            class account_entity <<orm>> #99CB99 {
                +{field} id sqlgen::PrimaryKey<std::string>
                +{field} version int
                +{field} username std::string
                +{field} password_hash std::string
                +{field} password_salt std::string
                +{field} totp_secret std::string
                +{field} email std::string
                +{field} is_admin int
                +{field} modified_by std::string
                +{field} valid_from sqlgen::Timestamp<"%Y-%m-%d %H:%M:%S">
                +{field} valid_to sqlgen::Timestamp<"%Y-%m-%d %H:%M:%S">
            }

            note top of account_entity
            Represents an account in the database.

            ORM Settings:

            - Schema: oresdb
            - Table: accounts

            Fields:

            - id: Primary key.
            - version: Version for optimistic locking.
            - username: Username.
            - password_hash: Hashed password.
            - password_salt: Password salt.
            - totp_secret: TOTP secret for 2FA.
            - email: Email address.
            - is_admin: Admin flag.
            - modified_by: Username who modified.
            - valid_from: Temporal validity start.
            - valid_to: Temporal validity end.
            end note

            class login_info_entity <<orm>> #99CB99 {
                +{field} account_id sqlgen::PrimaryKey<std::string>
                +{field} last_ip std::string
                +{field} last_attempt_ip std::string
                +{field} failed_logins int
                +{field} locked int
                +{field} last_login sqlgen::Timestamp<"%Y-%m-%d %H:%M:%S">
                +{field} online int
            }

            note top of login_info_entity
            Represents login tracking information in the database.

            ORM Settings:

            - Schema: oresdb
            - Table: login_info

            Fields:

            - account_id: Foreign key to account.
            - last_ip: Last successful login IP.
            - last_attempt_ip: Last login attempt IP.
            - failed_logins: Failed login count.
            - locked: Account locked flag.
            - last_login: Last login timestamp.
            - online: Online status flag.
            end note

            class account_mapper <<orm>> #99CB99 {
                +{static} map(account_entity) domain::account
                +{static} map(domain::account) account_entity
                +{static} map(std::vector<account_entity>) std::vector<domain::account>
                +{static} map(std::vector<domain::account>) std::vector<account_entity>
            }

            note top of account_mapper
            Maps domain model entities to data storage layer and vice-versa.
            end note

            account_mapper ..> ores::accounts::domain::account
            account_mapper ..> ores::accounts::repository::account_entity

            class login_info_mapper <<orm>> #99CB99 {
                +{static} map(login_info_entity) domain::login_info
                +{static} map(domain::login_info) login_info_entity
                +{static} map(std::vector<login_info_entity>) std::vector<domain::login_info>
                +{static} map(std::vector<domain::login_info>) std::vector<login_info_entity>
                -{static} timestamp_to_timepoint(sqlgen::Timestamp) std::chrono::system_clock::time_point
                -{static} timepoint_to_timestamp(std::chrono::system_clock::time_point) sqlgen::Timestamp
            }

            note top of login_info_mapper
            Maps domain model entities to data storage layer and vice-versa.
            end note

            login_info_mapper ..> ores::accounts::domain::login_info
            login_info_mapper ..> ores::accounts::repository::login_info_entity

            class account_repository <<orm>> #99CB99 {
                +sql() std::string
                +write(context, domain::account) void
                +write(context, std::vector<domain::account>) void
                +read_latest(context) std::vector<domain::account>
                +read_latest(context, boost::uuids::uuid) std::vector<domain::account>
                +read_all(context) std::vector<domain::account>
                +read_all(context, boost::uuids::uuid) std::vector<domain::account>
                +read_latest_by_username(context, std::string) std::vector<domain::account>
                -ensure_success(auto) void
                -make_timestamp(std::string) auto
                -{field} max_timestamp std::string
            }

            note top of account_repository
            Reads and writes accounts off of data storage.
            end note

            account_repository ..> ores::accounts::domain::account

            class login_info_repository <<orm>> #99CB99 {
                +sql() std::string
                +write(context, std::vector<domain::login_info>) void
                +update(context, domain::login_info) void
                +read(context) std::vector<domain::login_info>
                +read(context, boost::uuids::uuid) std::vector<domain::login_info>
                -{static} ensure_success(auto) void
            }

            note top of login_info_repository
            Reads and writes login tracking information off of data storage.
            end note

            login_info_repository ..> ores::accounts::domain::login_info

            ' Group: Permission persistence
            together {
                class permission_entity
                class permission_mapper
                class permission_repository
            }

            ' Group: Role persistence
            together {
                class role_entity
                class role_mapper
                class role_repository
            }

            ' Group: Account-Role persistence
            together {
                class account_role_entity
                class account_role_mapper
                class account_role_repository
            }

            ' Group: Role-Permission persistence
            together {
                class role_permission_entity
                class role_permission_mapper
                class role_permission_repository
            }

            ' Stack RBAC classes vertically
            permission_entity -[hidden]down- permission_mapper
            permission_mapper -[hidden]down- permission_repository
            role_entity -[hidden]down- role_mapper
            role_mapper -[hidden]down- role_repository
            account_role_entity -[hidden]down- account_role_mapper
            account_role_mapper -[hidden]down- account_role_repository
            role_permission_entity -[hidden]down- role_permission_mapper
            role_permission_mapper -[hidden]down- role_permission_repository

            class permission_entity <<orm>> #99CB99 {
                +{field} id sqlgen::PrimaryKey<std::string>
                +{field} code std::string
                +{field} description std::string
                +{field} valid_from sqlgen::Timestamp<"%Y-%m-%d %H:%M:%S">
                +{field} valid_to sqlgen::Timestamp<"%Y-%m-%d %H:%M:%S">
            }

            note top of permission_entity
            ORM entity for permissions table.

            ORM Settings:

            - Schema: oresdb
            - Table: permissions
            end note

            class permission_mapper <<orm>> #99CB99 {
                +{static} map(permission_entity) domain::permission
                +{static} map(domain::permission) permission_entity
                +{static} map(std::vector<permission_entity>) std::vector<domain::permission>
            }

            note top of permission_mapper
            Maps permission domain to entity and vice-versa.
            end note

            permission_mapper ..> ores::accounts::domain::rbac::permission
            permission_mapper ..> ores::accounts::repository::permission_entity

            class permission_repository <<orm>> #99CB99 {
                +sql() std::string
                +write(domain::permission) void
                +write(std::vector<domain::permission>) void
                +read_latest() std::vector<domain::permission>
                +read_latest(boost::uuids::uuid) std::vector<domain::permission>
                +read_latest_by_code(std::string) std::vector<domain::permission>
                +remove(boost::uuids::uuid) void
            }

            note top of permission_repository
            Reads and writes permissions to data storage.
            end note

            permission_repository ..> ores::accounts::domain::rbac::permission

            class role_entity <<orm>> #99CB99 {
                +{field} id sqlgen::PrimaryKey<std::string>
                +{field} version int
                +{field} name std::string
                +{field} description std::string
                +{field} modified_by std::string
                +{field} valid_from sqlgen::Timestamp<"%Y-%m-%d %H:%M:%S">
                +{field} valid_to sqlgen::Timestamp<"%Y-%m-%d %H:%M:%S">
            }

            note top of role_entity
            ORM entity for roles table.

            ORM Settings:

            - Schema: oresdb
            - Table: roles
            end note

            class role_mapper <<orm>> #99CB99 {
                +{static} map(role_entity) domain::role
                +{static} map(domain::role) role_entity
                +{static} map(std::vector<role_entity>) std::vector<domain::role>
            }

            note top of role_mapper
            Maps role domain to entity and vice-versa.
            end note

            role_mapper ..> ores::accounts::domain::rbac::role
            role_mapper ..> ores::accounts::repository::role_entity

            class role_repository <<orm>> #99CB99 {
                +sql() std::string
                +write(domain::role) void
                +read_latest() std::vector<domain::role>
                +read_latest(boost::uuids::uuid) std::vector<domain::role>
                +read_latest_by_name(std::string) std::vector<domain::role>
                +read_latest_by_ids(std::vector<boost::uuids::uuid>) std::vector<domain::role>
                +remove(boost::uuids::uuid) void
            }

            note top of role_repository
            Reads and writes roles to data storage.
            end note

            role_repository ..> ores::accounts::domain::rbac::role

            class account_role_entity <<orm>> #99CB99 {
                +{field} account_id std::string
                +{field} role_id std::string
                +{field} assigned_by std::string
                +{field} valid_from sqlgen::Timestamp<"%Y-%m-%d %H:%M:%S">
                +{field} valid_to sqlgen::Timestamp<"%Y-%m-%d %H:%M:%S">
            }

            note top of account_role_entity
            ORM entity for account_roles junction table.

            ORM Settings:

            - Schema: oresdb
            - Table: account_roles
            - Primary Key: (account_id, role_id) at database level
            end note

            class account_role_mapper <<orm>> #99CB99 {
                +{static} map(account_role_entity) domain::account_role
                +{static} map(domain::account_role) account_role_entity
                +{static} map(std::vector<account_role_entity>) std::vector<domain::account_role>
            }

            note top of account_role_mapper
            Maps account_role domain to entity and vice-versa.
            end note

            account_role_mapper ..> ores::accounts::domain::rbac::account_role
            account_role_mapper ..> ores::accounts::repository::account_role_entity

            class account_role_repository <<orm>> #99CB99 {
                +sql() std::string
                +write(domain::account_role) void
                +write(std::vector<domain::account_role>) void
                +read_latest() std::vector<domain::account_role>
                +read_latest_by_account(boost::uuids::uuid) std::vector<domain::account_role>
                +read_latest_by_role(boost::uuids::uuid) std::vector<domain::account_role>
                +exists(boost::uuids::uuid, boost::uuids::uuid) bool
                +remove(boost::uuids::uuid, boost::uuids::uuid) void
                +remove_all_for_account(boost::uuids::uuid) void
                +read_effective_permissions(boost::uuids::uuid) std::vector<std::string>
                +read_roles_with_permissions(boost::uuids::uuid) std::vector<domain::role>
            }

            note top of account_role_repository
            Reads and writes account-role assignments.
            end note

            account_role_repository ..> ores::accounts::domain::rbac::account_role
            account_role_repository ..> ores::accounts::domain::rbac::role

            class role_permission_entity <<orm>> #99CB99 {
                +{field} role_id std::string
                +{field} permission_id std::string
                +{field} valid_from sqlgen::Timestamp<"%Y-%m-%d %H:%M:%S">
                +{field} valid_to sqlgen::Timestamp<"%Y-%m-%d %H:%M:%S">
            }

            note top of role_permission_entity
            ORM entity for role_permissions junction table.

            ORM Settings:

            - Schema: oresdb
            - Table: role_permissions
            - Primary Key: (role_id, permission_id) at database level
            end note

            class role_permission_mapper <<orm>> #99CB99 {
                +{static} map(role_permission_entity) domain::role_permission
                +{static} map(domain::role_permission) role_permission_entity
                +{static} map(std::vector<role_permission_entity>) std::vector<domain::role_permission>
            }

            note top of role_permission_mapper
            Maps role_permission domain to entity and vice-versa.
            end note

            role_permission_mapper ..> ores::accounts::domain::rbac::role_permission
            role_permission_mapper ..> ores::accounts::repository::role_permission_entity

            class role_permission_repository <<orm>> #99CB99 {
                +sql() std::string
                +write(domain::role_permission) void
                +write(std::vector<domain::role_permission>) void
                +read_latest() std::vector<domain::role_permission>
                +read_latest_by_role(boost::uuids::uuid) std::vector<domain::role_permission>
                +remove(boost::uuids::uuid, boost::uuids::uuid) void
                +remove_all_for_role(boost::uuids::uuid) void
                +read_all_role_permission_codes() std::map<std::string, std::vector<std::string>>
                +read_role_permission_codes(std::vector<boost::uuids::uuid>) std::map<std::string, std::vector<std::string>>
            }

            note top of role_permission_repository
            Reads and writes role-permission assignments.
            end note

            role_permission_repository ..> ores::accounts::domain::rbac::role_permission
        }

        namespace service #F2F2F2 {
            class account_service #ECECEC {
                +account_service(account_repository, login_info_repository)
                +get_account(boost::uuids::uuid) std::optional<domain::account>
                +create_account(context, std::string, std::string, std::string, std::string, bool) domain::account
                +list_accounts(context) std::vector<domain::account>
                +list_accounts(context, std::uint32_t, std::uint32_t) std::vector<domain::account>
                +get_total_account_count() std::uint32_t
                +delete_account(context, boost::uuids::uuid) void
                +login(context, std::string, std::string, boost::asio::ip::address) domain::account
                +logout(context, boost::uuids::uuid) void
                +lock_account(context, boost::uuids::uuid) bool
                +unlock_account(context, boost::uuids::uuid) bool
                +is_admin(boost::uuids::uuid) bool
                +update_account(boost::uuids::uuid, std::string, std::string, bool) bool
                +get_account_history(std::string) std::vector<domain::account>
                +set_password_reset_required(boost::uuids::uuid) bool
                +change_password(boost::uuids::uuid, std::string) std::string
                +get_login_info(boost::uuids::uuid) domain::login_info
                +update_my_email(boost::uuids::uuid, std::string) std::string
                -{static} throw_if_empty(std::string, std::string) void
                -{field} account_repo_ repository::account_repository
                -{field} login_info_repo_ repository::login_info_repository
                -{field} uuid_generator_ utility::uuid::uuid_v7_generator
            }

            note top of account_service
            Service for managing user accounts including creation, listing, and deletion.

            Key features:
            - Account CRUD operations
            - Login/logout with session tracking
            - Password reset and change
            - Email self-service update
            - Account locking/unlocking
            end note

            account_service o-- ores::accounts::repository::account_repository
            account_service o-- ores::accounts::repository::login_info_repository
            account_service ..> ores::accounts::domain::account
            account_service ..> ores::accounts::security::password_manager : uses
            account_service ..> ores::accounts::security::password_policy_validator : uses
            account_service ..> ores::accounts::security::email_validator : uses

            class bootstrap_mode_service #ECECEC {
                +bootstrap_mode_service(utility::repository::context)
                +is_in_bootstrap_mode() bool
                +initialize_bootstrap_state() void
                +exit_bootstrap_mode() void
                -{field} account_repo_ repository::account_repository
                -{field} feature_flags_service_ variability::service::feature_flags_service
                -{field} ctx_ utility::repository::context
            }

            note top of bootstrap_mode_service
            Service for managing system bootstrap mode state.

            Manages a special state where only the initial administrator account can be created.
            Uses feature flags to persist the bootstrap mode state.
            end note

            bootstrap_mode_service o-- ores::accounts::repository::account_repository

            class authorization_service #ECECEC {
                +authorization_service(context, event_bus*)
                +list_permissions() std::vector<domain::permission>
                +find_permission_by_code(std::string) std::optional<domain::permission>
                +create_permission(std::string, std::string) domain::permission
                +list_roles() std::vector<domain::role>
                +find_role(boost::uuids::uuid) std::optional<domain::role>
                +find_role_by_name(std::string) std::optional<domain::role>
                +create_role(std::string, std::string, std::vector<std::string>, std::string) domain::role
                +get_role_permissions(boost::uuids::uuid) std::vector<std::string>
                +assign_role(boost::uuids::uuid, boost::uuids::uuid, std::string) void
                +revoke_role(boost::uuids::uuid, boost::uuids::uuid) void
                +get_account_roles(boost::uuids::uuid) std::vector<domain::role>
                +get_effective_permissions(boost::uuids::uuid) std::vector<std::string>
                +has_permission(boost::uuids::uuid, std::string) bool
                +{static} check_permission(std::vector<std::string>, std::string) bool
                -{field} permission_repo_ repository::permission_repository
                -{field} role_repo_ repository::role_repository
                -{field} account_role_repo_ repository::account_role_repository
                -{field} role_permission_repo_ repository::role_permission_repository
                -{field} uuid_generator_ utility::uuid::uuid_v7_generator
                -{field} event_bus_ event_bus*
            }

            note top of authorization_service
            Service for managing role-based access control (RBAC).

            Provides functionality for:
            - Managing permissions (CRUD operations)
            - Managing roles and their associated permissions
            - Assigning and revoking roles from accounts
            - Checking if an account has specific permissions
            - Computing the effective permissions for an account

            Events are published when role assignments change.
            end note

            authorization_service o-- ores::accounts::repository::permission_repository
            authorization_service o-- ores::accounts::repository::role_repository
            authorization_service o-- ores::accounts::repository::account_role_repository
            authorization_service o-- ores::accounts::repository::role_permission_repository
            authorization_service ..> ores::accounts::domain::rbac::permission
            authorization_service ..> ores::accounts::domain::rbac::role
            authorization_service ..> ores::accounts::eventing::role_assigned_event : publishes
            authorization_service ..> ores::accounts::eventing::role_revoked_event : publishes
            authorization_service ..> ores::accounts::eventing::permissions_changed_event : publishes

            class rbac_seeder #ECECEC {
                +rbac_seeder(authorization_service&)
                +seed(std::string) void
                +seed_permissions() void
                +seed_roles(std::string) void
                -{field} auth_service_ authorization_service&
            }

            note top of rbac_seeder
            Seeds the RBAC system with predefined permissions and roles.

            Creates standard permissions and roles required for the application.
            Idempotent - running multiple times won't create duplicates.

            Predefined Roles:
            - Admin: Full access (wildcard permission)
            - Trading: currencies:read, currencies:history, flags:read
            - Sales: currencies:read, flags:read
            - Operations: currencies:*, flags:read, accounts:read
            - Support: All read permissions
            end note

            rbac_seeder o-- ores::accounts::service::authorization_service
        }

        namespace messaging #F2F2F2 {
            '
            ' Layout groupings
            '

            ' Group: Create account messages
            /'
             ' together {
             '     class create_account_request
             '     class create_account_response
             ' }
             '/

            ' Group: List accounts messages
            /'
             ' together {
             '     class list_accounts_request
             '     class list_accounts_response
             ' }
             '/

            ' Group: Login messages
            /'
             ' together {
             '     class login_request
             '     class login_response
             ' }
             '/

            ' Group: Logout messages
            /'
             ' together {
             '     class logout_request
             '     class logout_response
             ' }
             '/

            ' Group: Unlock account messages
            /'
             ' together {
             '     class unlock_account_request
             '     class unlock_account_response
             ' }
             '/

            ' Group: Handler infrastructure
            /'
             ' together {
             '     class accounts_message_handler
             '     class registrar
             ' }
             '/

            ' Stack request/response pairs vertically
            create_account_request -[hidden]down- create_account_response
            list_accounts_request -[hidden]down- list_accounts_response
            login_request -[hidden]down- login_response
            logout_request -[hidden]down- logout_response
            unlock_account_request -[hidden]down- unlock_account_response
            accounts_message_handler -[hidden]down- registrar

            ' Create row structure
            create_account_response -[hidden]down- list_accounts_request
            list_accounts_response -[hidden]down- login_request
            login_response -[hidden]down- logout_request
            logout_response -[hidden]down- unlock_account_request
            unlock_account_response -[hidden]down- accounts_message_handler

            '
            ' Class definitions
            '

            class create_account_request <<message>> #E1F5FF {
                +{field} username std::string
                +{field} password std::string
                +{field} totp_secret std::string
                +{field} email std::string
                +{field} modified_by std::string
                +{field} is_admin bool
                +serialize() std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t>) std::expected<create_account_request, comms::messaging::error_code>
            }

            note top of create_account_request
            Request to create a new account.

            Fields:

            - username: Username for the account.
            - password: Password for the account.
            - totp_secret: TOTP secret for 2FA.
            - email: Email address.
            - modified_by: Username who is creating.
            - is_admin: Admin flag.
            end note

            class create_account_response <<message>> #E1F5FF {
                +{field} account_id boost::uuids::uuid
                +serialize() std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t>) std::expected<create_account_response, comms::messaging::error_code>
            }

            note top of create_account_response
            Response containing the created account ID.

            Fields:

            - account_id: ID of the created account.
            end note

            class list_accounts_request <<message>> #E1F5FF {
                +serialize() std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t>) std::expected<list_accounts_request, comms::messaging::error_code>
            }

            note top of list_accounts_request
            Request to retrieve all accounts.

            This request has no parameters - it retrieves all accounts in the system.
            end note

            class list_accounts_response <<message>> #E1F5FF {
                +{field} accounts std::vector<domain::account>
                +serialize() std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t>) std::expected<list_accounts_response, comms::messaging::error_code>
            }

            note top of list_accounts_response
            Response containing all accounts.

            Fields:

            - accounts: Vector of all accounts.
            end note

            list_accounts_response o-- ores::accounts::domain::account

            class login_request <<message>> #E1F5FF {
                +{field} username std::string
                +{field} password std::string
                +serialize() std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t>) std::expected<login_request, comms::messaging::error_code>
            }

            note top of login_request
            Request to authenticate a user.

            Fields:

            - username: Username for authentication.
            - password: Password for authentication.
            end note

            class login_response <<message>> #E1F5FF {
                +{field} success bool
                +{field} error_message std::string
                +{field} account_id boost::uuids::uuid
                +{field} username std::string
                +{field} is_admin bool
                +serialize() std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t>) std::expected<login_response, comms::messaging::error_code>
            }

            note top of login_response
            Response containing authentication result and account information.

            Fields:

            - success: Authentication success flag.
            - error_message: Error message if authentication failed.
            - account_id: ID of authenticated account.
            - username: Username of authenticated account.
            - is_admin: Admin flag of authenticated account.
            end note

            class unlock_account_request <<message>> #E1F5FF {
                +{field} account_id boost::uuids::uuid
                +serialize() std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t>) std::expected<unlock_account_request, comms::messaging::error_code>
            }

            note top of unlock_account_request
            Request to unlock a locked account.

            Fields:

            - account_id: ID of account to unlock.
            end note

            class unlock_account_response <<message>> #E1F5FF {
                +{field} success bool
                +{field} error_message std::string
                +serialize() std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t>) std::expected<unlock_account_response, comms::messaging::error_code>
            }

            note top of unlock_account_response
            Response indicating whether unlock operation succeeded.

            Fields:

            - success: Unlock success flag.
            - error_message: Error message if unlock failed.
            end note

            class logout_request <<message>> #E1F5FF {
                +{field} account_id boost::uuids::uuid
                +serialize() std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t>) std::expected<logout_request, comms::messaging::error_code>
            }

            note top of logout_request
            Request to logout a user.

            Fields:

            - account_id: ID of account to logout.
            end note

            class logout_response <<message>> #E1F5FF {
                +{field} success bool
                +{field} message std::string
                +serialize() std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t>) std::expected<logout_response, comms::messaging::error_code>
            }

            note top of logout_response
            Response indicating logout result.

            Fields:

            - success: Logout success flag.
            - message: Message (error if failed, confirmation if succeeded).
            end note

            class accounts_message_handler #ECECEC {
                +accounts_message_handler(database::context, std::shared_ptr<variability::service::system_flags_service>, std::shared_ptr<comms::service::auth_session_service>)
                +handle_message(comms::messaging::message_type, std::span<const std::uint8_t>, std::string) boost::asio::awaitable<std::expected<std::vector<std::uint8_t>, comms::messaging::error_code>>
                -handle_create_account_request(std::span<const std::uint8_t>) boost::asio::awaitable<std::expected<std::vector<std::uint8_t>, comms::messaging::error_code>>
                -handle_list_accounts_request(std::span<const std::uint8_t>) boost::asio::awaitable<std::expected<std::vector<std::uint8_t>, comms::messaging::error_code>>
                -handle_login_request(std::span<const std::uint8_t>, std::string) boost::asio::awaitable<std::expected<std::vector<std::uint8_t>, comms::messaging::error_code>>
                -handle_logout_request(std::span<const std::uint8_t>, std::string) boost::asio::awaitable<std::expected<std::vector<std::uint8_t>, comms::messaging::error_code>>
                -handle_unlock_account_request(std::span<const std::uint8_t>) boost::asio::awaitable<std::expected<std::vector<std::uint8_t>, comms::messaging::error_code>>
                -{field} ctx_ database::context
                -{field} account_repo_ repository::account_repository
                -{field} login_info_repo_ repository::login_info_repository
                -{field} sessions_ std::shared_ptr<comms::service::auth_session_service>
            }

            note top of accounts_message_handler
            Message handler for accounts subsystem messages.

            Processes messages in the accounts subsystem range (0x2000-0x2FFF).
            Currently handles:
            - create_account_request: Creates a new account
            - list_accounts_request: Retrieves all accounts from the repository
            - login_request: Authenticates a user and updates login tracking
            - logout_request: Logs out a user, marks them as offline, removes session
            - unlock_account_request: Unlocks a locked account

            Uses the shared auth_session_service to store/remove sessions on login/logout.
            Authorization checking is done by the message_dispatcher, not here.
            end note

            accounts_message_handler o-- ores::accounts::repository::account_repository
            accounts_message_handler o-- ores::accounts::repository::login_info_repository
            accounts_message_handler ..> ores::accounts::service::account_service : uses
            accounts_message_handler ..> ores::accounts::messaging::create_account_request : uses
            accounts_message_handler ..> ores::accounts::messaging::create_account_response : uses
            accounts_message_handler ..> ores::accounts::messaging::list_accounts_request : uses
            accounts_message_handler ..> ores::accounts::messaging::list_accounts_response : uses
            accounts_message_handler ..> ores::accounts::messaging::login_request : uses
            accounts_message_handler ..> ores::accounts::messaging::login_response : uses
            accounts_message_handler ..> ores::accounts::messaging::unlock_account_request : uses
            accounts_message_handler ..> ores::accounts::messaging::unlock_account_response : uses
            accounts_message_handler ..> ores::accounts::messaging::logout_request : uses
            accounts_message_handler ..> ores::accounts::messaging::logout_response : uses

            class registrar #ECECEC {
                +{static} register_handlers(comms::server&, utility::repository::context) void
            }

            note top of registrar
            Register accounts subsystem message handlers with the server.

            Registers handlers for all accounts subsystem messages (0x2000-0x2FFF).
            Must be called before server.run().
            end note
        }

        namespace security #F2F2F2 {
            '
            ' Layout groupings
            '

            /'
             ' together {
             '     class password_manager
             '     class password_policy_validator
             '     class email_validator
             ' }
             '/

            password_manager -[hidden]down- password_policy_validator
            password_policy_validator -[hidden]down- email_validator

            '
            ' Class definitions
            '

            class password_manager #ECECEC {
                +{static} create_password_hash(std::string) std::string
                +{static} verify_password_hash(std::string, std::string) bool
                -{static} base64_encode(std::vector<unsigned char>) std::string
                -{static} base64_decode(std::string) std::vector<unsigned char>
                -{static} {field} DEFAULT_N std::uint64_t
                -{static} {field} DEFAULT_r std::uint32_t
                -{static} {field} DEFAULT_p std::uint32_t
                -{static} {field} SALT_LEN std::size_t
                -{static} {field} HASH_LEN std::size_t
            }

            note top of password_manager
            Manages password hashing and verification using the scrypt algorithm.

            The password_manager class provides static methods to securely hash passwords
            and verify them against stored hashes. It uses the scrypt key derivation
            function from OpenSSL to generate and validate password hashes, ensuring
            strong security through configurable CPU/memory cost parameters.
            end note

            class password_policy_validator #ECECEC {
                +{static} validate(std::string, bool) validation_result
                -{static} {field} MIN_LENGTH std::size_t
                -{static} {field} SPECIAL_CHARS const char*
            }

            note top of password_policy_validator
            Validates passwords against OWASP-compliant security policy.

            Requirements:
            - Minimum 12 characters
            - At least one uppercase letter (A-Z)
            - At least one lowercase letter (a-z)
            - At least one digit (0-9)
            - At least one special character
            end note

            class email_validator #ECECEC {
                +{static} validate(std::string) validation_result
            }

            note top of email_validator
            Validates email addresses against basic format requirements.

            Checks:
            - Not empty
            - Exactly one '@' symbol
            - '@' not at start or end
            - Domain contains '.'
            - Domain doesn't start/end with '.'
            end note
        }

        namespace generators #F2F2F2 {
            class generate_synthetic_account <<generator>> #D89EF1 {
            }

            note top of generate_synthetic_account
            Generates a synthetic account.
            end note

            generate_synthetic_account --> ores::accounts::domain::account: generates

            class generate_synthetic_accounts <<generator>> #D89EF1 {
            }

            note top of generate_synthetic_accounts
            Generates N synthetic accounts.

            Note: C++ 23 generators are not supported on all compilers.
            end note

            generate_synthetic_accounts --> ores::accounts::domain::account: generates
        }

        namespace tests #F2F2F2 {
            '
            ' Layout groupings
            '

            ' Group: Domain tests
            /'
             ' together {
             '     class domain_account_tests
             '     class domain_logins_tests
             ' }
             '/

            ' Group: Messaging tests
            /'
             ' together {
             '     class messaging_accounts_message_handler_tests
             '     class messaging_protocol_tests
             ' }
             '/

            ' Group: Repository and service tests
            /'
             ' together {
             '     class repository_account_repository_tests
             '     class service_account_service_tests
             ' }
             '/

            ' Group: Security tests
            /'
             ' together {
             '     class security_password_manager_tests
             '     class security_password_policy_validator_tests
             '     class security_email_validator_tests
             ' }
             '/

            ' Stack related tests vertically
            domain_account_tests -[hidden]down- domain_logins_tests
            messaging_accounts_message_handler_tests -[hidden]down- messaging_protocol_tests
            repository_account_repository_tests -[hidden]down- service_account_service_tests
            security_password_manager_tests -[hidden]down- security_password_policy_validator_tests
            security_password_policy_validator_tests -[hidden]down- security_email_validator_tests

            '
            ' Class definitions
            '

            class domain_account_tests <<test suite>> #C5E1A5 {
                +create_account_with_valid_fields() void
                +create_admin_account() void
                +account_with_specific_uuid() void
                +account_insertion_operator() void
                +create_account_with_faker() void
                +create_multiple_random_accounts() void
                +account_convert_single_to_table() void
                +account_convert_multiple_to_table() void
                +account_convert_single_to_json() void
                +account_convert_multiple_to_json() void
                +account_convert_empty_vector_to_table() void
                +account_table_with_faker_data() void
            }

            note top of domain_account_tests
            Test suite for account domain model.

            Tests cover account creation, admin flags, UUIDs,
            serialization (JSON/table), and faker data generation.
            end note

            domain_account_tests ..> ores::accounts::domain::account : tests

            class domain_logins_tests <<test suite>> #C5E1A5 {
                +create_login_info_with_ipv4_addresses() void
                +create_login_info_with_ipv6_addresses() void
                +create_locked_account_login_info() void
                +login_info_with_failed_attempts() void
                +login_info_serialization_to_json() void
                +login_info_with_different_ip_versions() void
                +create_login_info_with_faker() void
                +create_multiple_random_login_infos() void
                +login_info_convert_single_to_table() void
                +login_info_convert_multiple_to_table() void
                +login_info_table_with_faker_data() void
            }

            note top of domain_logins_tests
            Test suite for login_info domain model.

            Tests cover IPv4/IPv6 addresses, locked accounts,
            failed attempts, JSON serialization, and table conversion.
            end note

            domain_logins_tests ..> ores::accounts::domain::login_info : tests

            class messaging_accounts_message_handler_tests <<test suite>> #C5E1A5 {
                +handle_single_create_account_request() void
                +handle_many_create_account_requests() void
                +handle_list_accounts_request_empty() void
                +handle_list_accounts_request_with_accounts() void
                +handle_login_request_with_valid_password() void
                +handle_login_request_with_invalid_password() void
                +handle_unlock_account_request() void
                +handle_invalid_message_type() void
                +handle_login_request_non_existent_user() void
                +handle_delete_account_request_success() void
                +handle_delete_account_request_non_existent_account() void
            }

            note top of messaging_accounts_message_handler_tests
            Test suite for accounts_message_handler.

            Tests cover all message types: create, list, login, unlock,
            delete accounts. Includes error scenarios and edge cases.
            end note

            messaging_accounts_message_handler_tests ..> ores::accounts::messaging::accounts_message_handler : tests

            class messaging_protocol_tests <<test suite>> #C5E1A5 {
                +create_account_request_with_valid_fields() void
                +create_account_request_with_faker() void
                +create_account_request_serialize_deserialize() void
                +create_account_response_with_valid_uuid() void
                +create_account_response_serialize_deserialize() void
                +list_accounts_request_serialize_deserialize() void
                +list_accounts_response_with_faker() void
                +list_accounts_response_serialize_deserialize() void
                +login_request_with_valid_credentials() void
                +login_request_with_faker() void
                +login_request_serialize_deserialize() void
                +login_response_success() void
                +login_response_failure() void
                +login_response_serialize_deserialize() void
                +unlock_account_request_with_valid_uuid() void
                +unlock_account_request_serialize_deserialize() void
                +unlock_account_response_success() void
                +unlock_account_response_failure() void
                +unlock_account_response_serialize_deserialize() void
                +create_multiple_random_login_requests() void
                +create_multiple_random_create_account_requests() void
                +delete_account_request_with_valid_uuid() void
                +delete_account_request_serialize_deserialize() void
                +delete_account_response_success() void
                +delete_account_response_failure() void
                +delete_account_response_serialize_deserialize() void
                +logout_request_with_valid_uuid() void
                +logout_request_serialize_deserialize() void
                +logout_response_success() void
                +logout_response_failure() void
                +logout_response_serialize_deserialize() void
            }

            note top of messaging_protocol_tests
            Test suite for messaging protocol serialization.

            Tests cover all request/response message types:
            create_account, list_accounts, login, logout, unlock_account,
            delete_account. Validates serialization/deserialization.
            end note

            messaging_protocol_tests ..> ores::accounts::messaging::create_account_request : tests
            messaging_protocol_tests ..> ores::accounts::messaging::create_account_response : tests
            messaging_protocol_tests ..> ores::accounts::messaging::list_accounts_request : tests
            messaging_protocol_tests ..> ores::accounts::messaging::list_accounts_response : tests
            messaging_protocol_tests ..> ores::accounts::messaging::login_request : tests
            messaging_protocol_tests ..> ores::accounts::messaging::login_response : tests
            messaging_protocol_tests ..> ores::accounts::messaging::logout_request : tests
            messaging_protocol_tests ..> ores::accounts::messaging::logout_response : tests
            messaging_protocol_tests ..> ores::accounts::messaging::unlock_account_request : tests
            messaging_protocol_tests ..> ores::accounts::messaging::unlock_account_response : tests

            class repository_account_repository_tests <<test suite>> #C5E1A5 {
                +write_single_account() void
                +write_multiple_accounts() void
                +read_latest_accounts() void
                +read_latest_account_by_id() void
                +read_all_accounts() void
                +read_all_accounts_by_id() void
                +read_latest_by_username() void
                +read_nonexistent_account_by_id() void
                +read_nonexistent_username() void
                +write_and_read_admin_account() void
            }

            note top of repository_account_repository_tests
            Test suite for account_repository.

            Tests cover write, read (latest/all), read by ID,
            read by username, and non-existent account scenarios.
            end note

            repository_account_repository_tests ..> ores::accounts::repository::account_repository : tests

            class security_password_manager_tests <<test suite>> #C5E1A5 {
                +verify_password_hash_with_correct_password() void
                +verify_password_hash_with_incorrect_password() void
                +hash_is_not_deterministic() void
                +invalid_hash_format_fails_verification() void
                +empty_password_throws() void
            }

            note top of security_password_manager_tests
            Test suite for password_manager.

            Tests cover password hashing, verification,
            non-deterministic hashing, and error scenarios.
            end note

            security_password_manager_tests ..> ores::accounts::security::password_manager : tests

            class security_password_policy_validator_tests <<test suite>> #C5E1A5 {
                +valid_password_passes_validation() void
                +valid_password_with_all_special_chars() void
                +password_exactly_12_chars_passes() void
                +password_too_short_fails() void
                +password_without_uppercase_fails() void
                +password_without_lowercase_fails() void
                +password_without_digit_fails() void
                +password_without_special_char_fails() void
                +empty_password_fails() void
                +password_with_all_special_chars_types() void
                +long_valid_password_passes() void
                +password_with_spaces_passes_if_valid() void
                +weak_password_passes_when_validation_disabled() void
                +validation_enabled_by_default() void
            }

            note top of security_password_policy_validator_tests
            Test suite for password policy validation.

            Tests cover password length, uppercase/lowercase,
            digits, special characters, and validation enable/disable.
            end note

            security_password_policy_validator_tests ..> ores::accounts::security::password_policy_validator : tests

            class security_email_validator_tests <<test suite>> #C5E1A5 {
                +valid_email_passes_validation() void
                +valid_email_with_subdomain() void
                +valid_email_with_plus_sign() void
                +valid_email_with_dots_in_local_part() void
                +empty_email_fails() void
                +email_without_at_symbol_fails() void
                +email_with_multiple_at_symbols_fails() void
                +email_starting_with_at_fails() void
                +email_ending_with_at_fails() void
                +email_without_dot_in_domain_fails() void
                +email_with_domain_starting_with_dot_fails() void
                +email_with_domain_ending_with_dot_fails() void
                +valid_email_with_numbers() void
                +valid_email_with_hyphen_in_domain() void
            }

            note top of security_email_validator_tests
            Test suite for email validation.

            Tests cover valid email formats (standard, subdomain, plus sign,
            dots, numbers, hyphens) and invalid formats (empty, missing @,
            multiple @, domain without dot, invalid dot placement).
            end note

            security_email_validator_tests ..> ores::accounts::security::email_validator : tests

            class service_account_service_tests <<test suite>> #C5E1A5 {
                +create_account_with_valid_data() void
                +create_account_with_admin_flag() void
                +create_multiple_accounts() void
                +create_account_with_empty_username_throws() void
                +create_account_with_empty_email_throws() void
                +create_account_with_empty_password_throws() void
                +list_accounts_returns_empty_for_no_accounts() void
                +list_accounts_returns_created_accounts() void
                +login_with_valid_credentials() void
                +login_with_invalid_password_throws() void
                +login_with_nonexistent_username_throws() void
                +login_with_empty_username_throws() void
                +login_with_empty_password_throws() void
                +account_locks_after_multiple_failed_logins() void
                +unlock_account_successful() void
                +unlock_nonexistent_account_throws() void
                +login_with_different_ip_addresses() void
            }

            note top of service_account_service_tests
            Test suite for account_service.

            Tests cover account creation, listing, login, unlock,
            validation errors, account locking, and IP tracking.
            end note

            service_account_service_tests ..> ores::accounts::service::account_service : tests
        }
    }
}

' Local Variables:
' compile-command: "java -Djava.awt.headless=true -DPLANTUML_SECURITY_PROFILE=UNSECURE -DPLANTUML_LIMIT_SIZE=65535 -jar /usr/share/plantuml/plantuml.jar ores.accounts.puml"
' End:
@enduml
