# -*- mode: cmake; tab-width: 4; indent-tabs-mode: nil -*-
#
# Copyright (C) 2025 Marco Craveiro <marco.craveiro@gmail.com>
#
#
# This program is free software; you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free Software
# Foundation; either version 3 of the License, or (at your option) any later
# version.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program; if not, write to the Free Software Foundation, Inc., 51 Franklin
# Street, Fifth Floor, Boston, MA 02110-1301, USA.
#
#
#  CMake itself
#
{
   CMake Binary Leak
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:malloc
   obj:*/bin/cmake
   obj:*/bin/cmake
   ...
}
#
#  Boost.Log – Thread Local
#
{
   Boost Log Thread Local Get Severity
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:_Znwm
   # boost::log::v2s_mt_posix::sources::aux::get_severity_level()
   fun:_ZN5boost3log12v2s_mt_posix7sources3aux18get_severity_levelEv
   # boost::log::v2s_mt_posix::sources::aux::severity_level<ores::logging::boost_severity>::set_value(...)
   fun:_ZN5boost3log12v2s_mt_posix7sources3aux14severity_levelIN4ores7logging14boost_severityEE9set_valueES7_
   ...
}
{
   Boost Log Thread Local Random Seed
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:_Znwm
   fun:_ZN5boost3log12v2s_mt_posix3aux11this_thread6get_idEv
   fun:_ZN5boost3log12v2s_mt_posix4core14implementation11thread_data15get_random_seedEv
   ...
}
#
#  Boost.Log – Thread Exit
#
{
   Boost Log Thread Exit Function
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:_Znwm
   fun:_ZN5boost6detail8heap_newINS0_20thread_exit_function*
   ...
   fun:_ZN5boost11this_thread14at_thread_exit*
}
{
   Boost Log Thread Exit Add
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:_Znwm
   fun:_ZN5boost6detail24add_thread_exit_function*
}
{
   Boost Log Thread Exit Callback
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:_Znwm
   fun:_ZN5boost6detail8heap_newINS0_25thread_exit_callback_nodeERPNS0_25thread_exit_function_baseERPS2_EEPT_OT0_OT1_
   ...
}
#
#  Boost.Log – Thread Data
#
{
   Boost Log Thread Data Shared Ptr
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:_Znwm
   fun:_ZN5boost6detail12shared_countC*
   fun:_ZN5boost10shared_ptrINS_6detail16thread_data_baseEE*
}
{
   Boost Log Thread Data Shared Ptr 2
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:_Znwm
   fun:_ZN5boost6detail12shared_countC1INS0_16thread_data_baseEEEPT_
   fun:_ZN5boost6detail20sp_pointer_constructINS0_16thread_data_baseES2_EEvPNS_10shared_ptrIT_EEPT0_RNS0_12shared_countE
   fun:_ZN5boost10shared_ptrINS_6detail16thread_data_baseEEC1IS2_EEPT_
   fun:_ZN5boost10shared_ptrINS_6detail16thread_data_baseEE5resetIS2_EEvPT_
   fun:_ZN5boost6detail25make_external_thread_dataEv
   fun:_ZN5boost6detail31get_or_make_current_thread_dataEv
   fun:_ZN5boost6detail24add_thread_exit_functionEPNS0_25thread_exit_function_baseE
   fun:_ZN5boost11this_thread14at_thread_exitIZNS_3log12v2s_mt_posix7sources3aux18get_severity_levelEvEUlvE_EEvT_
   # boost::log::v2s_mt_posix::sources::aux::get_severity_level()
   fun:_ZN5boost3log12v2s_mt_posix7sources3aux18get_severity_levelEv
   # boost::log::v2s_mt_posix::sources::aux::severity_level<ores::logging::boost_severity>::set_value(...)
   fun:_ZN5boost3log12v2s_mt_posix7sources3aux14severity_levelIN4ores7logging14boost_severityEE9set_valueES7_
   ...
   fun:main
}

{
   Boost Log External Thread Data
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:_Znwm
   fun:_ZN5boost6detail25make_external_thread_dataEv
}
#
#  Boost.Log – ores::logging namespace variant
#
{
   Boost Log Thread Local Get Severity (ores::logging)
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:_Znwm
   # boost::log::v2s_mt_posix::sources::aux::get_severity_level()
   fun:_ZN5boost3log12v2s_mt_posix7sources3aux18get_severity_levelEv
   # boost::log::v2s_mt_posix::sources::aux::severity_level<ores::logging::boost_severity>::set_value(...)
   fun:_ZN5boost3log12v2s_mt_posix7sources3aux14severity_levelIN4ores7logging14boost_severityEE9set_valueES7_
   ...
}
{
   Boost Log Thread Data Shared Ptr (ores::logging)
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:_Znwm
   fun:_ZN5boost6detail12shared_countC1INS0_16thread_data_baseEEEPT_
   fun:_ZN5boost6detail20sp_pointer_constructINS0_16thread_data_baseES2_EEvPNS_10shared_ptrIT_EEPT0_RNS0_12shared_countE
   fun:_ZN5boost10shared_ptrINS_6detail16thread_data_baseEEC1IS2_EEPT_
   fun:_ZN5boost10shared_ptrINS_6detail16thread_data_baseEE5resetIS2_EEvPT_
   fun:_ZN5boost6detail25make_external_thread_dataEv
   fun:_ZN5boost6detail31get_or_make_current_thread_dataEv
   fun:_ZN5boost6detail24add_thread_exit_functionEPNS0_25thread_exit_function_baseE
   fun:_ZN5boost11this_thread14at_thread_exitIZNS_3log12v2s_mt_posix7sources3aux18get_severity_levelEvEUlvE_EEvT_
   # boost::log::v2s_mt_posix::sources::aux::get_severity_level()
   fun:_ZN5boost3log12v2s_mt_posix7sources3aux18get_severity_levelEv
   # boost::log::v2s_mt_posix::sources::aux::severity_level<ores::logging::boost_severity>::set_value(...)
   fun:_ZN5boost3log12v2s_mt_posix7sources3aux14severity_levelIN4ores7logging14boost_severityEE9set_valueES7_
   ...
   fun:main
}
{
   Boost Log External Launch Thread Data
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:_Znwm
   fun:_ZN5boost6detail8heap_newINS0_26externally_launched_threadEEEPT_v
   ...
}
#
# OpenSSL Init
#
{
   OpenSSL Init Thread Local
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:malloc
   fun:CRYPTO_malloc
   fun:CRYPTO_zalloc
   fun:ossl_sa_new
   ...
}
{
   OpenSSL Init Error State
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:malloc
   fun:CRYPTO_malloc
   fun:CRYPTO_zalloc
   fun:CRYPTO_calloc
   fun:CRYPTO_THREAD_set_local_ex
   fun:ossl_err_get_state_int
   ...
}
{
   OpenSSL Init Config Modules
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:malloc
   fun:CRYPTO_malloc
   fun:CRYPTO_zalloc
   fun:CRYPTO_calloc
   fun:alloc_node
   fun:ossl_sa_set
   ...
}
{
   OpenSSL Init Rand
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:malloc
   fun:CRYPTO_malloc
   fun:CRYPTO_zalloc
   fun:CRYPTO_calloc
   fun:alloc_node
   fun:ossl_sa_set
   fun:ossl_sa_CTX_TABLE_ENTRY_set
   fun:CRYPTO_THREAD_set_local_ex
   fun:rand_get0_public
   ...
}
{
   OpenSSL Thread Cleanup
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:malloc
   fun:CRYPTO_malloc
   fun:CRYPTO_zalloc
   fun:rand_delete_thread_state
   fun:init_thread_stop
   fun:OPENSSL_thread_stop
   fun:OPENSSL_cleanup
   fun:__run_exit_handlers
   fun:exit
}
#
# OpenSSL Other
#
{
   OpenSSL Node Alloc During Connect
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:malloc
   fun:CRYPTO_malloc
   fun:CRYPTO_calloc
   fun:alloc_node
   fun:ossl_sa_set
}
{
   OpenSSL Rand Usage
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:malloc
   fun:CRYPTO_malloc
   fun:CRYPTO_zalloc
   fun:rand_get0_public
   fun:RAND_bytes_ex
   fun:RAND_bytes
}
{
   OpenSSL Exit Cleanup
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:malloc
   fun:CRYPTO_malloc
   fun:CRYPTO_zalloc
   fun:rand_delete_thread_state
   fun:OPENSSL_cleanup
   fun:_ZZ4mainEN19boost_se_guard_t_31*
   fun:main
}
#
# Boost.Asio SSL Init (C++ wrapper around OpenSSL)
# These suppressions cover the boost::asio::ssl initialization which uses
# a shared_ptr to hold the OpenSSL init singleton. This is harmless - the
# memory is intentionally kept alive for the lifetime of the process.
#
{
   Boost Asio SSL OpenSSL Init Instance
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:_Znwm
   fun:_ZN5boost4asio3ssl6detail17openssl_init_base8instanceEv
   ...
}
{
   Boost Asio SSL OpenSSL Init Constructor
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:_Znwm
   ...
   fun:_ZN5boost4asio3ssl6detail12openssl_initILb1EE*
   ...
}
{
   Boost Asio SSL OpenSSL Init Shared Ptr
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:_Znwm
   fun:_ZNSt14__shared_count*openssl_init_base*
   ...
}
{
   Boost Asio SSL OpenSSL Init Shared Ptr 2
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:_Znwm
   fun:_ZNSt12__shared_ptr*openssl_init_base*
   ...
}
#
# Catch2 Reporter Registry
# Catch2 registers all its built-in reporters (Automake, Compact, Console,
# JUnit, SonarQube, TAP, TeamCity, XML) at static initialization time.
# These are intentionally kept alive for the lifetime of the test process.
#
{
   Catch2 Reporter Registry Init
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:_Znwm
   fun:_ZN5Catch6Detail11make_unique*ReporterFactory*
   fun:_ZN5Catch16ReporterRegistry*
   ...
}
{
   Catch2 Registry Hub Init
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:_Znwm
   ...
   fun:_ZN5Catch*RegistryHub*
   ...
}
{
   Catch2 Singleton Init
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:_Znwm
   ...
   fun:_ZN5Catch9Singleton*
   ...
}
#
# Postgres OpenSSL
#
{
   Postgres SSL Connection Init
   Memcheck:Leak
   match-leak-kinds: reachable,possible
   fun:malloc
   fun:CRYPTO_malloc
   ...
   fun:pg_strong_random
   fun:build_client_first_message
   fun:scram_exchange
   fun:pg_SASL_init
   fun:pg_fe_sendauth
   fun:PQconnectPoll
   ...
}
#
# Pthread/Glibc Thread Local Storage
# When threads are created, glibc allocates TLS (Thread Local Storage) via
# allocate_dtv/_dl_allocate_tls. Valgrind reports these as "possibly lost"
# because the pointer to the memory isn't direct (it's accessed via %fs
# register on x86_64). This is a known false positive.
#
{
   Pthread TLS Allocation
   Memcheck:Leak
   match-leak-kinds: possible
   fun:calloc
   ...
   fun:allocate_dtv
   fun:_dl_allocate_tls
   ...
   fun:pthread_create*
   ...
}
{
   Pthread TLS Allocation via std::thread
   Memcheck:Leak
   match-leak-kinds: possible
   fun:calloc
   ...
   fun:allocate_dtv
   fun:_dl_allocate_tls
   ...
   fun:*std*thread*_M_start_thread*
   ...
}
