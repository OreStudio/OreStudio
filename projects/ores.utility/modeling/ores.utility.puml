' -*- mode: plantuml; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-
'
' Copyright (C) 2025 Marco Craveiro <marco.craveiro@gmail.com>
'
' This program is free software; you can redistribute it and/or modify it under
' the terms of the GNU General Public License as published by the Free Software
' Foundation; either version 3 of the License, or (at your option) any later
' version.
'
' This program is distributed in the hope that it will be useful, but WITHOUT
'  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
' FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
'
' You should have received a copy of the GNU General Public License along with
' GNU Emacs; see the file COPYING. If not, write to the Free Software
' Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
@startuml
!pragma layout smetana

title ores.utility Component

set namespaceSeparator ::

namespace ores #F2F2F2 {
    namespace utility #F2F2F2 {
        namespace string #F2F2F2 {
            '
            ' Layout groupings
            '

            together {
                class conversion_error
                class converter
            }

            conversion_error -[hidden]down- converter

            '
            ' Class definitions
            '

            class conversion_error <<exception>> #D6B19F {
            }

            note top of conversion_error
            An error occurred whilst converting a string.
            end note

            class converter #ECECEC {
                +{static} string_to_int(std::string, int) int
            }

            note top of converter
            Type conversion utilities.

            Methods:

            - string_to_int: Converts a string into an integer.
            end note
        }

        namespace streaming #F2F2F2 {
        }

        namespace filesystem #F2F2F2 {
            '
            ' Layout groupings
            '

            together {
                class file_not_found
                class io_error
                class file
            }

            file_not_found -[hidden]down- io_error
            io_error -[hidden]down- file

            '
            ' Class definitions
            '

            class file_not_found <<exception>> #D6B19F {
            }

            note top of file_not_found
            File was not found.
            end note

            class io_error <<exception>> #D6B19F {
            }

            note top of io_error
            An error occurred whilst performing an IO operation.
            end note

            class file #ECECEC {
                +{static} read_content(std::istream&) std::string
                +{static} read_content(const std::filesystem::path&) std::string
                +{static} write_content(const std::filesystem::path&, const std::string&) void
                +{static} write(const std::filesystem::path&, const Ioable&) void
                +{static} find_files(const std::filesystem::path&) std::set<std::filesystem::path>
                +{static} find_files(const std::vector<std::filesystem::path>&) std::set<std::filesystem::path>
                +{static} find_files(const std::list<std::filesystem::path>&) std::set<std::filesystem::path>
                +{static} find_file_recursively_upwards(std::filesystem::path, const std::filesystem::path&) std::filesystem::path
                +{static} remove(const std::list<std::filesystem::path>&) void
                +{static} remove_empty_directories(const std::filesystem::path&) void
                +{static} remove_empty_directories(const std::list<std::filesystem::path>&) void
                +{static} recreate_directory(const std::filesystem::path&) void
            }

            note top of file
            Utility class for file operations.

            Methods:

            - read_content: Returns the contents of the file.
            - write_content: Writes the string to a file located at path.
            - write: Dump the object as a stream to the file.
            - find_files: Returns all files available in all input directories, recursively.
            - find_file_recursively_upwards: Finds the relative path, by searching recursively upwards from the starting directory.
            - remove: Deletes all files in the supplied list.
            - remove_empty_directories: Removes all empty directories, recursively.
            - recreate_directory: If the directory exists, deletes it and recreates it. Otherwise, creates it.
            end note
        }

        namespace database #C6F0D8 {
            struct database_options #F7E5FF {
                +{field} user std::string
                +{field} password rfl::Skip<std::string>
                +{field} host std::string
                +{field} database std::string
                +{field} port int
            }

            note top of database_options
            Configuration for database connection.

            Fields:

            - user: Database user name.
            - password: Password for the user.
            - host: Host to connect to.
            - database: Database to connect to.
            - port: Port the database is listening on.
            end note

            class database_configuration #ECECEC {
                +{static} make_options_description() boost::program_options::options_description
                +{static} read_options(const boost::program_options::variables_map&) database_options
            }

            note top of database_configuration
            Centralized manager for database configuration parsing.

            Provides utilities for creating command-line option descriptions,
            reading configuration from parsed options, and mapping environment
            variables.

            Methods:

            - make_options_description: Creates the boost::program_options description for database CLI arguments.
            - read_options: Reads database options from parsed variables map.
            end note

            database_configuration ..> ores::utility::database::database_options
        }

        namespace environment #F2F2F2 {
            class environment #ECECEC {
                +{static} get_value(const std::string&) std::optional<std::string>
                +{static} get_value_or_default(const std::string&, const std::string&) std::string
                +{static} get_int_value_or_default(const std::string&, int) int
            }

            note top of environment
            Utilities for reading environment variables.

            Methods:

            - get_value: Gets an environment variable value.
            - get_value_or_default: Gets an environment variable value with a default.
            - get_int_value_or_default: Gets an environment variable value as an integer.
            end note
        }

        namespace log #F2F2F2 {
            '
            ' Layout groupings
            '

            together {
                enum severity_level
                class lifecycle_manager
            }

            together {
                struct logging_options
                class logging_options_validator
                class logging_configuration
                class logging_exception
            }

            severity_level -[hidden]down- lifecycle_manager
            logging_options -[hidden]down- logging_options_validator
            logging_options_validator -[hidden]down- logging_configuration
            logging_configuration -[hidden]down- logging_exception

            '
            ' Class definitions
            '

            enum severity_level {
                trace
                debug
                info
                warn
                error
            }

            note top of severity_level
            Logging severity.

            This must be a C++-03 enum due to the boost::log internals. It also
            makes logging easier otherwise we'd have to always prefix "severity_level::".

            Values:
            - trace
            - debug
            - info
            - warn
            - error
            end note

            class lifecycle_manager #ECECEC {
                -{static} make_file_sink(std::filesystem::path, severity_level, std::string) boost::shared_ptr<file_sink_type>
                -{static} make_console_sink(severity_level, std::string) boost::shared_ptr<console_sink_type>
            }

            note top of lifecycle_manager
            Manages the starting and stopping of logging for an application.

            Note: this class uses boost shared_ptr due to legacy reasons (boost log does
            not support std::shared_ptr).

            Fields:

            - file_sink_: Boost log file sink.
            - console_sink_: Boost log console sink.
            end note

            lifecycle_manager o-- ores::utility::log::severity_level

            struct logging_options #F7E5FF {
                +{field} severity std::string
                +{field} filename std::string
                +{field} output_to_console bool
                +{field} output_directory std::filesystem::path
                +{field} tag std::string
            }

            note top of logging_options
            Options related to logging.

            Fields:

            - severity: Level at which to log.
            - filename: Name of the file to log into. If empty, file logging is disabled.
            - output_to_console: If true, dumps the log into the console.
            - output_directory: Directory in which to place the output.
            - tag: Tag to filter the logging. If supplied, only messages with this tag will be logged.
            end note

            class logging_options_validator #ECECEC {
                +{static} validate(const logging_options&) void
            }

            note top of logging_options_validator
            Checks the validity of the supplied logging options.
            end note

            logging_options_validator ..> ores::utility::log::logging_options

            class logging_configuration #ECECEC {
                +{static} make_options_description(const std::string&) boost::program_options::options_description
                +{static} read_options(const boost::program_options::variables_map&) std::optional<logging_options>
            }

            note top of logging_configuration
            Centralized manager for logging configuration parsing.

            Provides utilities for creating command-line option descriptions,
            reading configuration from parsed options.

            Methods:

            - make_options_description: Creates the boost::program_options description for logging CLI arguments.
            - read_options: Reads logging options from parsed variables map.
            end note

            logging_configuration ..> ores::utility::log::logging_options

            class logging_exception <<exception>> #D6B19F {
            }

            note top of logging_exception
            An exception has occurred during logging.
            end note
        }

        namespace repository #F2F2F2 {
            '
            ' Layout groupings
            '

            together {
                class context
                class repository_exception
                class context_factory
                struct configuration
            }

            context -[hidden]down- repository_exception
            repository_exception -[hidden]down- context_factory
            context_factory -[hidden]down- configuration

            '
            ' Class definitions
            '

            class context #ECECEC {
                +connection_pool() connection_pool_type
            }

            note top of context
            Context for the operations on a repository.

            Fields:

            - connection_pool_: Connection pool for database operations.
            end note

            class repository_exception <<exception>> #D6B19F {
            }

            note top of repository_exception
            A fatal error has occurred whilst reading or writing to the
            repository.
            end note

            class context_factory #ECECEC {
                +{static} make_context(const configuration&) context
            }

            note top of context_factory
            Generates a new repository context.

            Methods:

            - make_context: Creates a repository context from configuration.
            end note

            struct configuration #F7E5FF {
                +{field} user std::string
                +{field} password rfl::Skip<std::string>
                +{field} host std::string
                +{field} database std::string
                +{field} port int
                +{field} pool_size std::size_t
                +{field} num_attempts std::size_t
                +{field} wait_time_in_seconds std::size_t
            }

            note top of configuration
            Configuration for creating repository context.

            Fields:

            - user: Database user name.
            - password: Password for the user.
            - host: Host to connect to.
            - database: Database to connect to.
            - port: Port the database is listening in on.
            - pool_size: Number of connections in the pool.
            - num_attempts: Number of retry attempts when acquiring a connection.
            - wait_time_in_seconds: Wait time between retry attempts.
            end note

            context_factory +-- configuration
            context_factory ..> ores::utility::repository::context
            context_factory ..> ores::utility::repository::configuration
        }

        namespace uuid #F2F2F2 {
            class uuid_v7_generator #ECECEC {
                +operator()() boost::uuids::uuid
            }

            note top of uuid_v7_generator
            A generator for UUID version 7 (v7) based on RFC 9562.

            This class creates UUIDs that are time-sortable and contain
            high-entropy random data. A UUID v7 is composed of a 48-bit Unix timestamp
            (in milliseconds), a 4-bit version field, and 74 bits of random data.

            The combination of a timestamp and random data makes v7 UUIDs excellent for
            use as primary keys in distributed databases, as they are sortable by
            generation time and have a very low probability of collision.

            This implementation is designed to be efficient, creating and seeding a
            random number engine only once upon construction.

            Fields:

            - random_engine: The Mersenne Twister 19937 64-bit random number engine.
            end note
        }

        namespace program_options #F2F2F2 {
            class environment_mapper_factory #ECECEC {
                +{static} make_mapper(const std::string) std::function<std::string(const std::string&)>
            }

            note top of environment_mapper_factory
            Makes environment mappers for program options.

            Note: Logging is not available during configuration.

            Methods:

            - make_mapper: Creates an environment variable name mapping function.
            end note
        }

        namespace rfl #F2F2F2 {
        }

        namespace tests #F2F2F2 {
            '
            ' Layout groupings
            '

            ' Group: Converter tests
            together {
                class convert_base32_converter_tests
                class convert_base64_converter_tests
                class string_converter_tests
            }

            ' Group: Other tests
            together {
                class faker_internet_tests
                class faker_totp_tests
                class uuid_uuid_v7_generator_tests
            }

            ' Stack vertically
            convert_base32_converter_tests -[hidden]down- convert_base64_converter_tests
            convert_base64_converter_tests -[hidden]down- string_converter_tests
            faker_internet_tests -[hidden]down- faker_totp_tests
            faker_totp_tests -[hidden]down- uuid_uuid_v7_generator_tests

            '
            ' Class definitions
            '

            class convert_base32_converter_tests <<test suite>> #C5E1A5 {
                +base32_encode_empty_input() void
                +base32_encode_single_byte() void
                +base32_encode_hello() void
                +base32_encode_foobar() void
                +base32_encode_various_lengths() void
                +base32_encode_binary_data() void
                +base32_encode_all_zeros() void
                +base32_encode_alphabet_coverage() void
            }

            note top of convert_base32_converter_tests
            Test suite for base32 encoding functionality.

            Tests cover empty input, single byte, text strings,
            various length inputs, binary data, and alphabet coverage.
            end note

            class convert_base64_converter_tests <<test suite>> #C5E1A5 {
                +base64_encode_empty_input() void
                +base64_encode_hello() void
                +base64_encode_hello_world() void
                +base64_decode_hello() void
                +base64_roundtrip_conversion() void
                +base64_encode_binary_data() void
                +base64_roundtrip_binary_data() void
                +base64_decode_empty_throws() void
                +base64_encode_various_lengths() void
                +base64_encode_long_text() void
                +base64_encode_all_zeros() void
                +base64_encode_all_ones() void
            }

            note top of convert_base64_converter_tests
            Test suite for base64 encoding/decoding functionality.

            Tests cover encoding, decoding, roundtrip conversions,
            binary data, various length inputs, and error handling.
            end note

            class faker_internet_tests <<test suite>> #C5E1A5 {
                +internet_endpoint_format() void
                +internet_endpoint_port_range() void
                +internet_endpoint_unique_values() void
                +internet_ipv4_is_valid() void
                +internet_ipv4_to_string_format() void
                +internet_ipv4_octets_in_range() void
                +internet_ipv4_unique_values() void
                +internet_ipv4_can_create_address() void
                +internet_endpoint_multiple_calls() void
                +internet_ipv4_not_unspecified() void
            }

            note top of faker_internet_tests
            Test suite for faker internet data generation.

            Tests cover endpoint generation (format, port range),
            IPv4 generation (validation, format, uniqueness),
            and address creation.
            end note

            class faker_totp_tests <<test suite>> #C5E1A5 {
                +totp_secret_default_size() void
                +totp_secret_custom_size_10() void
                +totp_secret_custom_size_5() void
                +totp_secret_custom_size_32() void
                +totp_secret_is_valid_base32() void
                +totp_secret_generates_unique_values() void
                +totp_secret_different_sizes_produce_different_lengths() void
                +totp_secret_standard_size_16() void
                +totp_secret_very_small_size() void
                +totp_secret_multiple_calls_different_results() void
            }

            note top of faker_totp_tests
            Test suite for faker TOTP secret generation.

            Tests cover default and custom secret sizes, base32
            validation, uniqueness, and multiple generation calls.
            end note

            class string_converter_tests <<test suite>> #C5E1A5 {
                +string_to_int_valid_decimal() void
                +string_to_int_negative_number() void
                +string_to_int_zero() void
                +string_to_int_hexadecimal() void
                +string_to_int_hex_lowercase() void
                +string_to_int_binary() void
                +string_to_int_octal() void
                +string_to_int_max_int() void
                +string_to_int_min_int() void
                +string_to_int_invalid_empty_string() void
                +string_to_int_invalid_non_numeric() void
                +string_to_int_partial_parse_stops_at_invalid() void
                +string_to_int_invalid_whitespace() void
                +string_to_int_out_of_range_overflow() void
                +string_to_int_out_of_range_underflow() void
                +string_to_int_different_bases() void
                +string_to_int_partial_parse_binary() void
                +string_to_int_partial_parse_hex() void
                +string_to_int_large_hex_value() void
                +string_to_int_negative_hex() void
            }

            note top of string_converter_tests
            Test suite for string converter functionality.

            Tests cover decimal, hexadecimal, binary, and octal
            conversions, boundary values, error handling,
            and different number bases.
            end note

            string_converter_tests ..> ores::utility::string::converter : tests

            class uuid_uuid_v7_generator_tests <<test suite>> #C5E1A5 {
                +generate_uuid_v7_is_not_nil() void
                +generate_multiple_unique_uuids() void
                +uuid_v7_has_correct_version() void
                +uuid_v7_has_correct_variant() void
                +uuid_v7_preserves_time_ordering() void
                +uuid_v7_string_format_is_valid() void
                +uuid_v7_timestamp_extraction() void
                +generate_batch_of_time_ordered_uuids() void
                +uuid_v7_format_components() void
            }

            note top of uuid_uuid_v7_generator_tests
            Test suite for UUID v7 generator.

            Tests cover UUID generation, uniqueness, version/variant
            validation, time ordering, string format, and timestamp
            extraction.
            end note

            uuid_uuid_v7_generator_tests ..> ores::utility::uuid::uuid_v7_generator : tests
        }
    }
}

' Local Variables:
' compile-command: "java -Djava.awt.headless=true -DPLANTUML_SECURITY_PROFILE=UNSECURE -DPLANTUML_LIMIT_SIZE=65535 -jar /usr/share/plantuml/plantuml.jar ores.utility.puml"
' End:
@enduml
