' -*- mode: plantuml; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-
'
' Copyright (C) 2025 Marco Craveiro <marco.craveiro@gmail.com>
'
' This program is free software; you can redistribute it and/or modify it under
' the terms of the GNU General Public License as published by the Free Software
' Foundation; either version 3 of the License, or (at your option) any later
' version.
'
' This program is distributed in the hope that it will be useful, but WITHOUT
'  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
' FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
'
' You should have received a copy of the GNU General Public License along with
' GNU Emacs; see the file COPYING. If not, write to the Free Software
' Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
@startuml
set namespaceSeparator ::

namespace ores #F2F2F2 {
    note "Domain model for the ORE types and other related classes." as ores_risk_note
    risk --- ores_risk_note
    namespace risk #F2F2F2 {
        note "Provides XML serialisation support for the ORE domain model types\nusing native ORE XML." as ores_risk_orexml_note
        orexml --- ores_risk_orexml_note
        namespace orexml #F2F2F2 {
            class parsing_error #FFFACD {
                +parsing_error(std::string_view message)
                +what() const : const char*
                -{field} message_ : std::string
            }

            note top of parsing_error
            A fatal error has occurred during parsing of ORE XML.
            end note

            class CurrencyElement #F7E5FF {
                +{field} Name : std::string
                +{field} ISOCode : std::string
                +{field} NumericCode : std::string
                +{field} Symbol : std::string
                +{field} FractionSymbol : std::string
                +{field} FractionsPerUnit : int
                +{field} RoundingType : std::string
                +{field} RoundingPrecision : int
                +{field} Format : std::string
                +{field} CurrencyType : std::optional<std::string>
            }

            note top of CurrencyElement
            Represents a currencies in ORE XML format.

            Fields:

            - Name: Name of the currency.
            - ISOCode: ISO code for the currency.
            - NumericCode: Numeric code for the currency.
            - Symbol: Symbol used for the currency.
            - FractionSymbol: Symbol for fractions.
            - FractionsPerUnit: Number of fractions per unit.
            - RoundingType: Type of rounding used.
            - RoundingPrecision: Precision for rounding.
            - Format: Format string for display.
            - CurrencyType: Optional type of currency.
            end note

            class CurrencyConfig #F7E5FF {
                +{field} Currency : std::vector<CurrencyElement>
                +{static} to_xml(const CurrencyConfig& v) : std::string
                +{static} from_xml(const std::string& xml) : CurrencyConfig
            }

            note top of CurrencyConfig
            Represents a set of currencies in ORE XML format.

            Fields:

            - Currency: Vector of currency elements.
            end note

            CurrencyConfig o-u- ores::risk::orexml::CurrencyElement

            class importer #FFFACD {
                +{static} import_currency_config(const std::filesystem::path& path) : std::vector<domain::currency>
                -{static} lg() : auto&
            }

            note top of importer
            Imports domain objects from their ORE XML representation.
            end note

            class currency_mapper #FFFACD {
                +{static} map(const CurrencyElement& v) : domain::currency
                +{static} map(const domain::currency& v) : CurrencyElement
                +{static} map(const CurrencyConfig& v) : std::vector<domain::currency>
                +{static} map(const std::vector<domain::currency>& v) : CurrencyConfig
                -{static} lg() : auto&
            }

            note top of currency_mapper
            Maps domain model entities to ORE XML and vice-versa.
            end note

            class exporter #FFFACD {
                +{static} export_currency_config(const std::vector<domain::currency>& v) : std::string
                -{static} lg() : auto&
            }

            note top of exporter
            Exports domain objects from their ORE XML representation.
            end note
        }

        namespace domain #F2F2F2 {
            class currency #F7E5FF {
                +{field} iso_code : std::string
                +{field} name : std::string
                +{field} numeric_code : std::string
                +{field} symbol : std::string
                +{field} fraction_symbol : std::string
                +{field} fractions_per_unit : int
                +{field} rounding_type : std::string
                +{field} rounding_precision : int
                +{field} format : std::string
                +{field} currency_type : std::string
                +{field} modified_by : std::string
                +{field} valid_from : std::string
                +{field} valid_to : std::string
            }

            note top of currency
            Represents a currency.

            Fields:

            - iso_code: ISO code for the currency.
            - name: Name of the currency.
            - numeric_code: Numeric code for the currency.
            - symbol: Symbol used for the currency.
            - fraction_symbol: Symbol for fractions.
            - fractions_per_unit: Number of fractions per unit.
            - rounding_type: Type of rounding used.
            - rounding_precision: Precision for rounding.
            - format: Format string for display.
            - currency_type: Type of currency.
            - modified_by: User who modified the currency.
            - valid_from: Start of validity period.
            - valid_to: End of validity period.
            end note

            class currency_version #F7E5FF {
                +{field} data : currency
                +{field} version_number : int
                +{field} modified_by : std::string
                +{field} modified_at : std::string
                +{field} change_summary : std::string
            }

            note top of currency_version
            Represents a specific version of a currency with metadata.

            Fields:

            - data: The currency data at this version.
            - version_number: Version number (1-based, higher is newer).
            - modified_by: Username of the person who created this version.
            - modified_at: Timestamp when this version was created (ISO 8601 format).
            - change_summary: Summary of changes made in this version.
            end note

            currency_version o-u- ores::risk::domain::currency

            class currency_version_history #F7E5FF {
                +{field} iso_code : std::string
                +{field} versions : std::vector<currency_version>
            }

            note top of currency_version_history
            Contains the full version history for a currency.

            Fields:

            - iso_code: ISO code of the currency.
            - versions: All versions of this currency, ordered from newest to oldest.
            end note

            currency_version_history o-u- ores::risk::domain::currency_version
        }

        namespace repository #F2F2F2 {
            class currency_entity #F7E5FF {
                +{field} iso_code : sqlgen::PrimaryKey<std::string>
                +{field} name : std::string
                +{field} numeric_code : std::string
                +{field} symbol : std::string
                +{field} fraction_symbol : std::string
                +{field} fractions_per_unit : int
                +{field} rounding_type : std::string
                +{field} rounding_precision : int
                +{field} format : std::string
                +{field} currency_type : std::string
                +{field} modified_by : std::string
                +{field} valid_from : std::optional<sqlgen::Timestamp<"%Y-%m-%d %H:%M:%S">>
                +{field} valid_to : std::optional<sqlgen::Timestamp<"%Y-%m-%d %H:%M:%S">>
            }

            note top of currency_entity
            Represents a currency in the database.

            Fields:

            - iso_code: ISO code for the currency (primary key).
            - name: Name of the currency.
            - numeric_code: Numeric code for the currency.
            - symbol: Symbol used for the currency.
            - fraction_symbol: Symbol for fractions.
            - fractions_per_unit: Number of fractions per unit.
            - rounding_type: Type of rounding used.
            - rounding_precision: Precision for rounding.
            - format: Format string for display.
            - currency_type: Type of currency.
            - modified_by: User who modified the currency.
            - valid_from: Start of validity period.
            - valid_to: End of validity period.
            end note

            class currency_mapper #FFFACD {
                +{static} map(const currency_entity& v) : domain::currency
                +{static} map(const domain::currency& v) : currency_entity
                +{static} map(const std::vector<currency_entity>& v) : std::vector<domain::currency>
                +{static} map(const std::vector<domain::currency>& v) : std::vector<currency_entity>
                -{static} lg() : auto&
            }

            note top of currency_mapper
            Maps domain model entities to data storage layer and vice-versa.
            end note

            class currency_repository #FFFACD {
                +sql() : std::string
                +write(context ctx, const domain::currency& currencies) : void
                +write(context ctx, const std::vector<domain::currency>& currencies) : void
                +read_latest(context ctx) : std::vector<domain::currency>
                +read_latest(context ctx, const std::string& iso_code) : std::vector<domain::currency>
                +read_at_timepoint(context ctx, const std::string& as_of) : std::vector<domain::currency>
                +read_at_timepoint(context ctx, const std::string& as_of, const std::string& iso_code) : std::vector<domain::currency>
                +read_all(context ctx) : std::vector<domain::currency>
                +read_all(context ctx, const std::string& iso_code) : std::vector<domain::currency>
                +update(context ctx, const domain::currency& currency) : void
                +remove(context ctx, const std::string& iso_code) : void
                -{static} lg() : auto&
                -ensure_success(const auto result) : void
                -make_timestamp(const std::string& s) : auto
                -{field} max_timestamp : const std::string
            }

            note top of currency_repository
            Reads and writes currencies off of data storage.
            end note
        }

        namespace generators #F2F2F2 {
            class "<functions>" as currency_generator #FFFACD {
                +{static} generate_synthetic_currency() : domain::currency
                +{static} generate_synthetic_unicode_currencies() : std::vector<domain::currency>
                +{static} generate_synthetic_currencies(std::size_t n) : std::vector<domain::currency>
                +{static} generate_unique_synthetic_currencies(std::size_t n) : std::vector<domain::currency>
            }

            note top of currency_generator
            Functions for generating synthetic currency data.
            end note
        }

        namespace csv #F2F2F2 {
            class exporter #FFFACD {
                +{static} export_currency_config(const std::vector<domain::currency>& v) : std::string
                -{static} lg() : auto&
            }

            note top of exporter
            Exports domain objects to their CSV representation.
            end note
        }

        namespace messaging #F2F2F2 {
            class get_currencies_request #F7E5FF {
                +serialize() const : std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t> data) : std::expected<get_currencies_request, comms::protocol::error_code>
            }

            note top of get_currencies_request
            Request to retrieve all currencies.

            This request has no parameters - it retrieves all currencies in the system.
            end note

            class get_currencies_response #F7E5FF {
                +{field} currencies : std::vector<domain::currency>
                +serialize() const : std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t> data) : std::expected<get_currencies_response, comms::protocol::error_code>
            }

            note top of get_currencies_response
            Response containing all currencies.

            Fields:

            - currencies: List of all currencies.
            end note

            class create_currency_request #F7E5FF {
                +{field} currency : domain::currency
                +serialize() const : std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t> data) : std::expected<create_currency_request, comms::protocol::error_code>
            }

            note top of create_currency_request
            Request to create a new currency.

            Fields:

            - currency: The currency to create.
            end note

            class create_currency_response #F7E5FF {
                +{field} success : bool
                +{field} message : std::string
                +serialize() const : std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t> data) : std::expected<create_currency_response, comms::protocol::error_code>
            }

            note top of create_currency_response
            Response confirming currency creation.

            Fields:

            - success: Whether the operation succeeded.
            - message: Status or error message.
            end note

            class update_currency_request #F7E5FF {
                +{field} currency : domain::currency
                +serialize() const : std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t> data) : std::expected<update_currency_request, comms::protocol::error_code>
            }

            note top of update_currency_request
            Request to update a currency.

            Fields:

            - currency: The currency with updated data.
            end note

            class update_currency_response #F7E5FF {
                +{field} success : bool
                +{field} message : std::string
                +serialize() const : std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t> data) : std::expected<update_currency_response, comms::protocol::error_code>
            }

            note top of update_currency_response
            Response confirming currency update.

            Fields:

            - success: Whether the operation succeeded.
            - message: Status or error message.
            end note

            class delete_currency_request #F7E5FF {
                +{field} iso_code : std::string
                +serialize() const : std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t> data) : std::expected<delete_currency_request, comms::protocol::error_code>
            }

            note top of delete_currency_request
            Request to delete a currency.

            Fields:

            - iso_code: ISO code of the currency to delete.
            end note

            class delete_currency_response #F7E5FF {
                +{field} success : bool
                +{field} message : std::string
                +serialize() const : std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t> data) : std::expected<delete_currency_response, comms::protocol::error_code>
            }

            note top of delete_currency_response
            Response confirming currency deletion.

            Fields:

            - success: Whether the operation succeeded.
            - message: Status or error message.
            end note

            class get_currency_history_request #F7E5FF {
                +{field} iso_code : std::string
                +serialize() const : std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t> data) : std::expected<get_currency_history_request, comms::protocol::error_code>
            }

            note top of get_currency_history_request
            Request to retrieve version history for a currency.

            Fields:

            - iso_code: ISO code of the currency.
            end note

            class get_currency_history_response #F7E5FF {
                +{field} success : bool
                +{field} message : std::string
                +{field} history : domain::currency_version_history
                +serialize() const : std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t> data) : std::expected<get_currency_history_response, comms::protocol::error_code>
            }

            note top of get_currency_history_response
            Response containing currency version history.

            Fields:

            - success: Whether the operation succeeded.
            - message: Status or error message.
            - history: The version history for the currency.
            end note

            get_currency_history_response o-u- ores::risk::domain::currency_version_history

            class risk_message_handler #FFFACD {
                +risk_message_handler(utility::repository::context ctx)
                +handle_message(comms::protocol::message_type type, std::span<const std::uint8_t> payload, const std::string& remote_address) : boost::asio::awaitable<std::expected<std::vector<std::uint8_t>, comms::protocol::error_code>>
                -{static} lg() : auto&
                -handle_get_currencies_request(std::span<const std::uint8_t> payload) : boost::asio::awaitable<std::expected<std::vector<std::uint8_t>, comms::protocol::error_code>>
                -handle_update_currency_request(std::span<const std::uint8_t> payload) : boost::asio::awaitable<std::expected<std::vector<std::uint8_t>, comms::protocol::error_code>>
                -handle_delete_currency_request(std::span<const std::uint8_t> payload) : boost::asio::awaitable<std::expected<std::vector<std::uint8_t>, comms::protocol::error_code>>
                -handle_get_currency_history_request(std::span<const std::uint8_t> payload) : boost::asio::awaitable<std::expected<std::vector<std::uint8_t>, comms::protocol::error_code>>
                -handle_create_currency_request(std::span<const std::uint8_t> payload) : boost::asio::awaitable<std::expected<std::vector<std::uint8_t>, comms::protocol::error_code>>
                -{field} ctx_ : utility::repository::context
                -{field} currency_repo_ : repository::currency_repository
            }

            note top of risk_message_handler
            Message handler for risk subsystem messages.

            Processes messages in the risk subsystem range (0x1000-0x1FFF).
            Currently handles:
            - get_currencies_request: Retrieves all currencies from the repository
            end note

            class registrar #FFFACD {
                +{static} register_handlers(comms::server& server, utility::repository::context ctx) : void
                -{static} lg() : auto&
            }

            note top of registrar
            Register risk subsystem message handlers with the server.

            Registers handlers for all risk subsystem messages (0x1000-0x1FFF).
            Must be called before server.run().
            end note
        }
    }
}

' Local Variables:
' compile-command: "java -Djava.awt.headless=true -DPLANTUML_SECURITY_PROFILE=UNSECURE -DPLANTUML_LIMIT_SIZE=65535 -jar /usr/share/plantuml/plantuml.jar ores.risk.puml"
' End:
@enduml
