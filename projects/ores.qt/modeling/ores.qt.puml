' -*- mode: plantuml; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-
'
' Copyright (C) 2025 Marco Craveiro <marco.craveiro@gmail.com>
'
' This program is free software; you can redistribute it and/or modify it under
' the terms of the GNU General Public License as published by the Free Software
' Foundation; either version 3 of the License, or (at your option) any later
' version.
'
' This program is distributed in the hope that it will be useful, but WITHOUT
'  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
' FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
'
' You should have received a copy of the GNU General Public License along with
' GNU Emacs; see the file COPYING. If not, write to the Free Software
' Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
@startuml
set namespaceSeparator ::

namespace ores #F2F2F2 {
    note "Qt based Graphical User Interface for ORE Studio." as ores_qt_note
    qt --- ores_qt_note

    namespace qt #F2F2F2 {

        ' Main Window
        class MainWindow #ECECEC {
            +MainWindow(QWidget* parent)
            +~MainWindow()
            +getClient() std::shared_ptr<comms::client>
            -onLoginTriggered() void
            -onDisconnectTriggered() void
            -onAboutTriggered() void
            -onDetachAllTriggered() void
            -onReattachAllTriggered() void
            -onWindowMenuAboutToShow() void
            -updateMenuState() void
            -createControllers() void
            -{field} ui_ Ui::MainWindow*
            -{field} mdiArea_ MdiAreaWithBackground*
            -{field} connectionStatusIconLabel_ QLabel*
            -{field} allDetachableWindows_ QList<DetachableMdiSubWindow*>
            -{field} connectedIcon_ QIcon
            -{field} disconnectedIcon_ QIcon
            -{field} currencyController_ std::unique_ptr<CurrencyController>
            -{field} io_context_ std::unique_ptr<boost::asio::io_context>
            -{field} work_guard_ std::unique_ptr<boost::asio::executor_work_guard>
            -{field} io_thread_ std::unique_ptr<std::thread>
            -{field} client_ std::shared_ptr<comms::client>
            -{field} username_ std::string
        }
        note top of MainWindow
        Main application window providing the MDI interface and entity management.

        - ui_: Auto-generated UI elements
        - mdiArea_: MDI area with custom background
        - connectionStatusIconLabel_: Status bar connection icon
        - allDetachableWindows_: List of all detachable windows
        - connectedIcon_: Connected state icon
        - disconnectedIcon_: Disconnected state icon
        - currencyController_: Currency operations controller
        - io_context_: Boost ASIO IO context
        - work_guard_: Work guard for IO context
        - io_thread_: Thread running IO context
        - client_: Client connection to server
        - username_: Logged-in username
        end note

        ' MDI Infrastructure
        class MdiAreaWithBackground #ECECEC {
            +MdiAreaWithBackground(QWidget* parent)
            +setBackgroundLogo(const QString& imagePath) void
            #paintEvent(QPaintEvent* event) void
            -{field} backgroundLogo_ QPixmap
        }
        note top of MdiAreaWithBackground
        Custom QMdiArea that displays a background logo when no windows are open.

        - backgroundLogo_: Background logo image
        end note

        class DetachableMdiSubWindow #ECECEC {
            +DetachableMdiSubWindow(QWidget* parent)
            +~DetachableMdiSubWindow()
            +isDetached() bool
            +detach() void
            +reattach() void
            #contextMenuEvent(QContextMenuEvent* event) void
            #closeEvent(QCloseEvent* event) void
            -{field} isDetached_ bool
            -{field} savedMdiArea_ QPointer<QMdiArea>
            -{field} savedMdiPosition_ QPoint
            -{field} savedMdiSize_ QSize
        }
        note top of DetachableMdiSubWindow
        QMdiSubWindow that can be detached to become a floating window.

        - isDetached_: Detachment state flag
        - savedMdiArea_: Saved MDI area reference
        - savedMdiPosition_: Saved MDI position
        - savedMdiSize_: Saved MDI size
        end note

        ' Entity Controller Pattern
        class EntityController #ECECEC {
            +EntityController(QMainWindow* mainWindow, QMdiArea* mdiArea, std::shared_ptr<comms::client> client, const QString& username, QObject* parent)
            +~EntityController()
            +{abstract} showListWindow() void
            +setClient(std::shared_ptr<comms::client> client, const QString& username) void
            +{abstract} closeAllWindows() void
            #statusMessage(const QString& message)
            #errorMessage(const QString& message)
            #{field} mainWindow_ QMainWindow*
            #{field} mdiArea_ QMdiArea*
            #{field} client_ std::shared_ptr<comms::client>
            #{field} username_ QString
        }
        note top of EntityController
        Base class for entity-specific controllers.

        - mainWindow_: Parent main window
        - mdiArea_: MDI area for windows
        - client_: Shared client connection
        - username_: Logged-in username
        end note

        class CurrencyController #ECECEC {
            +CurrencyController(QMainWindow* mainWindow, QMdiArea* mdiArea, std::shared_ptr<comms::client> client, const QString& username, QList<DetachableMdiSubWindow*>& allDetachableWindows, QObject* parent)
            +~CurrencyController()
            +showListWindow() void
            +closeAllWindows() void
            -onAddNewRequested() void
            -onShowCurrencyDetails(const risk::domain::currency& currency) void
            -onShowCurrencyHistory(const QString& isoCode) void
            -{field} allDetachableWindows_ QList<DetachableMdiSubWindow*>&
            -{field} currencyListWindow_ QPointer<DetachableMdiSubWindow>
        }
        note top of CurrencyController
        Controller managing all currency-related windows and operations.

        - allDetachableWindows_: Reference to MainWindow's window list
        - currencyListWindow_: Weak pointer to currency list window
        end note

        ' Currency Windows
        class CurrencyMdiWindow #ECECEC {
            +CurrencyMdiWindow(std::shared_ptr<comms::client> client, QWidget* parent)
            +~CurrencyMdiWindow()
            +currencyModel() ClientCurrencyModel*
            +sizeHint() QSize
            +reload() void
            +addNew() void
            +editSelected() void
            +deleteSelected() void
            +viewHistorySelected() void
            +exportToCSV() void
            +exportToXML() void
            -onDataLoaded() void
            -onLoadError(const QString& error_message) void
            -onRowDoubleClicked(const QModelIndex& index) void
            -onSelectionChanged() void
            -updateActionStates() void
            -{field} verticalLayout_ QVBoxLayout*
            -{field} currencyTableView_ QTableView*
            -{field} toolBar_ QToolBar*
            -{field} addAction_ QAction*
            -{field} editAction_ QAction*
            -{field} deleteAction_ QAction*
            -{field} historyAction_ QAction*
            -{field} currencyModel_ std::unique_ptr<ClientCurrencyModel>
            -{field} client_ std::shared_ptr<comms::client>
        }
        note top of CurrencyMdiWindow
        MDI window for displaying currencies.

        - verticalLayout_: Layout for window
        - currencyTableView_: Table view for currencies
        - toolBar_: Toolbar with actions
        - addAction_: Add currency action
        - editAction_: Edit currency action
        - deleteAction_: Delete currency action
        - historyAction_: View history action
        - currencyModel_: Currency data model
        - client_: Client connection
        end note

        class ClientCurrencyModel #ECECEC {
            +ClientCurrencyModel(std::shared_ptr<comms::client> client, QObject* parent)
            +~ClientCurrencyModel()
            +rowCount(const QModelIndex& parent) int
            +columnCount(const QModelIndex& parent) int
            +data(const QModelIndex& index, int role) QVariant
            +headerData(int section, Qt::Orientation orientation, int role) QVariant
            +refresh() void
            +getCurrency(int row) const risk::domain::currency*
            +getCurrencies() std::vector<risk::domain::currency>
            -onCurrenciesLoaded() void
            -{field} client_ std::shared_ptr<comms::client>
            -{field} currencies_ std::vector<risk::domain::currency>
            -{field} watcher_ QFutureWatcher<FutureWatcherResult>*
        }
        note top of ClientCurrencyModel
        Model for displaying currencies fetched from the server via client.

        - client_: Client connection
        - currencies_: Currency data
        - watcher_: Future watcher for async loading
        end note

        class CurrencyDetailDialog #ECECEC {
            +CurrencyDetailDialog(QWidget* parent)
            +~CurrencyDetailDialog()
            +setClient(std::shared_ptr<comms::client> client) void
            +setUsername(const std::string& username) void
            +setCurrency(const risk::domain::currency& currency) void
            +getCurrency() risk::domain::currency
            +clearDialog() void
            +save() void
            -onSaveClicked() void
            -onResetClicked() void
            -onDeleteClicked() void
            -onFieldChanged() void
            -updateSaveResetButtonState() void
            -{field} ui_ std::unique_ptr<Ui::CurrencyDetailDialog>
            -{field} isDirty_ bool
            -{field} isAddMode_ bool
            -{field} username_ std::string
            -{field} toolBar_ QToolBar*
            -{field} saveAction_ QAction*
            -{field} deleteAction_ QAction*
            -{field} client_ std::shared_ptr<comms::client>
            -{field} currentCurrency_ risk::domain::currency
        }
        note top of CurrencyDetailDialog
        Widget for creating/editing currency details.

        - ui_: Auto-generated UI elements
        - isDirty_: Dirty flag
        - isAddMode_: Add mode flag
        - username_: Logged-in username
        - toolBar_: Toolbar with actions
        - saveAction_: Save action
        - deleteAction_: Delete action
        - client_: Client connection
        - currentCurrency_: Current currency being edited
        end note

        class CurrencyHistoryDialog #ECECEC {
            +CurrencyHistoryDialog(QString iso_code, std::shared_ptr<comms::client> client, QWidget* parent)
            +~CurrencyHistoryDialog()
            +loadHistory() void
            +sizeHint() QSize
            -onVersionSelected(int index) void
            -onHistoryLoaded() void
            -onHistoryLoadError(const QString& error) void
            -displayChangesTab(int version_index) void
            -displayFullDetailsTab(int version_index) void
            -calculateDiff(const risk::domain::currency_version& current, const risk::domain::currency_version& previous) DiffResult
            -{field} ui_ std::unique_ptr<Ui::CurrencyHistoryDialog>
            -{field} client_ std::shared_ptr<comms::client>
            -{field} isoCode_ QString
            -{field} history_ risk::domain::currency_version_history
        }
        note top of CurrencyHistoryDialog
        Widget for displaying currency version history.

        - ui_: Auto-generated UI elements
        - client_: Client connection
        - isoCode_: ISO code of currency
        - history_: Version history data
        end note

        ' Dialogs
        class LoginDialog #ECECEC {
            +LoginDialog(QWidget* parent)
            +~LoginDialog()
            +getClient() std::shared_ptr<comms::client>
            +getUsername() std::string
            +takeIOContext() std::unique_ptr<boost::asio::io_context>
            +takeIOThread() std::unique_ptr<std::thread>
            +takeWorkGuard() std::unique_ptr<boost::asio::executor_work_guard>
            -onLoginClicked() void
            -onConnectionResult(bool success, const QString& error_message) void
            -onLoginResult(bool success, const QString& error_message) void
            -setupUI() void
            -enableForm(bool enabled) void
            -performLogin(const std::string& username, const std::string& password) void
            -{field} username_edit_ QLineEdit*
            -{field} password_edit_ QLineEdit*
            -{field} host_edit_ QLineEdit*
            -{field} port_spinbox_ QSpinBox*
            -{field} login_button_ QPushButton*
            -{field} cancel_button_ QPushButton*
            -{field} status_label_ QLabel*
            -{field} io_context_ std::unique_ptr<boost::asio::io_context>
            -{field} work_guard_ std::unique_ptr<boost::asio::executor_work_guard>
            -{field} io_thread_ std::unique_ptr<std::thread>
            -{field} client_ std::shared_ptr<comms::client>
        }
        note top of LoginDialog
        Dialog for user authentication and server connection.

        - username_edit_: Username input field
        - password_edit_: Password input field
        - host_edit_: Server host field
        - port_spinbox_: Server port field
        - login_button_: Login button
        - cancel_button_: Cancel button
        - status_label_: Status message label
        - io_context_: Boost ASIO IO context
        - work_guard_: Work guard for IO context
        - io_thread_: Thread running IO context
        - client_: Client connection
        end note

        class AboutDialog #ECECEC {
            +AboutDialog(QWidget* parent)
            +~AboutDialog()
            #showEvent(QShowEvent* e) void
            -updateVersionLabels() void
            -{field} ui_ Ui::AboutDialog
            -{field} logoLabel_ LogoLabel*
        }
        note top of AboutDialog
        Modal dialog displaying application version and build metadata.

        - ui_: Auto-generated UI elements
        - logoLabel_: Logo label with overlay
        end note

        class SplashScreen #ECECEC {
            +SplashScreen(const QPixmap& pixmap)
            +paintEvent(QPaintEvent* e) void
            +ensureFirstPaint() void
            +setProgressDuration(int milliseconds) void
            +setMessage(const QString& message) void
            -updateProgress() void
            -{field} painted_ bool
            -{field} progress_ int
            -{field} progressTimer_ QTimer*
            -{field} totalDuration_ int
            -{field} elapsedTime_ int
            -{field} updateInterval_ int
            -{field} messageText_ QString
        }
        note top of SplashScreen
        Splash screen with progress indicator.

        - painted_: Paint state flag
        - progress_: Current progress value
        - progressTimer_: Timer for progress updates
        - totalDuration_: Total duration for progress
        - elapsedTime_: Elapsed time
        - updateInterval_: Update interval
        - messageText_: Status message text
        end note

        ' Helpers
        class CurrencyItemDelegate #ECECEC {
            +CurrencyItemDelegate(QObject* parent)
            +paint(QPainter* painter, const QStyleOptionViewItem& option, const QModelIndex& index) void
            -{field} monospaceFont_ QFont
        }
        note top of CurrencyItemDelegate
        Custom item delegate for currency display.

        - monospaceFont_: Monospace font for rendering
        end note

        class MessageBoxHelper #ECECEC {
            +{static} question(QWidget* parent, const QString& title, const QString& text, QMessageBox::StandardButtons buttons) QMessageBox::StandardButton
            +{static} warning(QWidget* parent, const QString& title, const QString& text) void
            +{static} critical(QWidget* parent, const QString& title, const QString& text) void
            +{static} information(QWidget* parent, const QString& title, const QString& text) void
            -{static} createColoredIcon(const QString& svgPath, const QColor& color) QIcon
        }
        note top of MessageBoxHelper
        Utility class for creating message boxes with Fluent icons.
        end note

        class IconUtils #ECECEC {
            +{static} createRecoloredIcon(const QString& svgPath, const QColor& color) QIcon
        }
        note top of IconUtils
        Utility class for icon manipulation operations.
        end note

        class LogoLabel #ECECEC {
            +LogoLabel(QWidget* parent)
            +setTextOverlay(const QString& text) void
            #paintEvent(QPaintEvent* event) void
            -{field} overlayText_ QString
        }
        note top of LogoLabel
        Custom QLabel with text overlay capability.

        - overlayText_: Text to overlay on label
        end note

        ' Relationships - Main Window Structure
        ores::qt::MainWindow *-- ores::qt::MdiAreaWithBackground
        ores::qt::MainWindow o-- ores::qt::DetachableMdiSubWindow
        ores::qt::MainWindow *-- ores::qt::CurrencyController

        ' Relationships - Entity Controller Pattern
        ores::qt::CurrencyController -up-|> ores::qt::EntityController
        ores::qt::CurrencyController o-- ores::qt::DetachableMdiSubWindow

        ' Relationships - Currency Components
        ores::qt::CurrencyMdiWindow *-- ores::qt::ClientCurrencyModel
        ores::qt::CurrencyMdiWindow ..> ores::qt::CurrencyItemDelegate : uses

        ' Relationships - Dialogs
        ores::qt::AboutDialog *-- ores::qt::LogoLabel

        ' Relationships - MainWindow uses
        ores::qt::MainWindow ..> ores::qt::LoginDialog : uses
        ores::qt::MainWindow ..> ores::qt::AboutDialog : uses
        ores::qt::MainWindow ..> ores::qt::MessageBoxHelper : uses
        ores::qt::MainWindow ..> ores::qt::IconUtils : uses

        ' Relationships - CurrencyController creates windows
        ores::qt::CurrencyController ..> ores::qt::CurrencyMdiWindow : creates
        ores::qt::CurrencyController ..> ores::qt::CurrencyDetailDialog : creates
        ores::qt::CurrencyController ..> ores::qt::CurrencyHistoryDialog : creates
    }
}

' Local Variables:
' compile-command: "java -Djava.awt.headless=true -DPLANTUML_SECURITY_PROFILE=UNSECURE -DPLANTUML_LIMIT_SIZE=65535 -jar /usr/share/plantuml/plantuml.jar ores.qt.puml"
' End:
@enduml
