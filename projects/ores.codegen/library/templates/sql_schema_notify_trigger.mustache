{{! Template to generate SQL notification trigger for entity changes }}
{{{sql_license}}}
/*
 * AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
 * Template: sql_schema_notify_trigger.mustache
 * To modify, update the template and regenerate.
 */

create or replace function {{entity.schema}}.{{entity.component}}_{{entity.entity_plural}}_notify_fn()
returns trigger as $$
declare
    notification_payload jsonb;
    entity_name text := 'ores.{{entity.component}}.{{entity.entity_singular}}';
    change_timestamp timestamptz := NOW();
    changed_{{entity.primary_key.column}} {{entity.primary_key.type}};
    changed_tenant_id text;
begin
    if TG_OP = 'DELETE' then
        changed_{{entity.primary_key.column}} := OLD.{{entity.primary_key.column}};
        changed_tenant_id := OLD.tenant_id::text;
    else
        changed_{{entity.primary_key.column}} := NEW.{{entity.primary_key.column}};
        changed_tenant_id := NEW.tenant_id::text;
    end if;

    notification_payload := jsonb_build_object(
        'entity', entity_name,
        'timestamp', to_char(change_timestamp, 'YYYY-MM-DD HH24:MI:SS'),
        'entity_ids', jsonb_build_array(changed_{{entity.primary_key.column}}),
        'tenant_id', changed_tenant_id
    );

    perform pg_notify('ores_{{entity.entity_plural}}', notification_payload::text);

    return null;
end;
$$ language plpgsql;

create or replace trigger {{entity.component}}_{{entity.entity_plural}}_notify_trg
after insert or update or delete on {{entity.schema}}.{{entity.component}}_{{entity.entity_plural}}_tbl
for each row execute function {{entity.schema}}.{{entity.component}}_{{entity.entity_plural}}_notify_fn();
