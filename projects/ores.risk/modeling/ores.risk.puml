' -*- mode: plantuml; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-
'
' Copyright (C) 2025 Marco Craveiro <marco.craveiro@gmail.com>
'
' This program is free software; you can redistribute it and/or modify it under
' the terms of the GNU General Public License as published by the Free Software
' Foundation; either version 3 of the License, or (at your option) any later
' version.
'
' This program is distributed in the hope that it will be useful, but WITHOUT
'  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
' FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
'
' You should have received a copy of the GNU General Public License along with
' GNU Emacs; see the file COPYING. If not, write to the Free Software
' Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
@startuml

title ores.risk Component

set namespaceSeparator ::

namespace ores #F2F2F2 {
    note "Domain model for the ORE types and other related classes." as ores_risk_note
    risk --- ores_risk_note
    namespace risk #F2F2F2 {
        note "Provides XML serialisation support for the ORE domain model types\nusing native ORE XML." as ores_risk_orexml_note
        orexml --- ores_risk_orexml_note
        namespace orexml #F2F2F2 {
            class parsing_error <<exception>> #D6B19F {
                +parsing_error(std::string_view message)
                +what() const : const char*
                -{field} message_ : std::string
            }

            note top of parsing_error
            A fatal error has occurred during parsing of ORE XML.
            end note

            class CurrencyElement #F7E5FF {
                +{field} Name : std::string
                +{field} ISOCode : std::string
                +{field} NumericCode : std::string
                +{field} Symbol : std::string
                +{field} FractionSymbol : std::string
                +{field} FractionsPerUnit : int
                +{field} RoundingType : std::string
                +{field} RoundingPrecision : int
                +{field} Format : std::string
                +{field} CurrencyType : std::optional<std::string>
            }

            note top of CurrencyElement
            Represents a currencies in ORE XML format.

            Fields:

            - Name: Name of the currency.
            - ISOCode: ISO code for the currency.
            - NumericCode: Numeric code for the currency.
            - Symbol: Symbol used for the currency.
            - FractionSymbol: Symbol for fractions.
            - FractionsPerUnit: Number of fractions per unit.
            - RoundingType: Type of rounding used.
            - RoundingPrecision: Precision for rounding.
            - Format: Format string for display.
            - CurrencyType: Optional type of currency.
            end note

            class CurrencyConfig #F7E5FF {
                +{field} Currency : std::vector<CurrencyElement>
                +{static} to_xml(const CurrencyConfig& v) : std::string
                +{static} from_xml(const std::string& xml) : CurrencyConfig
            }

            note top of CurrencyConfig
            Represents a set of currencies in ORE XML format.

            Fields:

            - Currency: Vector of currency elements.
            end note

            CurrencyConfig o-u- ores::risk::orexml::CurrencyElement

            class importer #ECECEC {
                +{static} import_currency_config(const std::filesystem::path& path) : std::vector<domain::currency>
            }

            note top of importer
            Imports domain objects from their ORE XML representation.
            end note

            importer ..> ores::risk::orexml::CurrencyConfig : uses
            importer ..> ores::risk::domain::currency : imports

            class currency_mapper #ECECEC {
                +{static} map(const CurrencyElement& v) : domain::currency
                +{static} map(const domain::currency& v) : CurrencyElement
                +{static} map(const CurrencyConfig& v) : std::vector<domain::currency>
                +{static} map(const std::vector<domain::currency>& v) : CurrencyConfig
            }

            note top of currency_mapper
            Maps domain model entities to ORE XML and vice-versa.
            end note

            currency_mapper ..> ores::risk::orexml::CurrencyElement : uses
            currency_mapper ..> ores::risk::orexml::CurrencyConfig : uses
            currency_mapper ..> ores::risk::domain::currency : uses

            class exporter #ECECEC {
                +{static} export_currency_config(const std::vector<domain::currency>& v) : std::string
            }

            note top of exporter
            Exports domain objects from their ORE XML representation.
            end note

            exporter ..> ores::risk::domain::currency : exports
            exporter ..> ores::risk::orexml::CurrencyConfig : uses
        }

        namespace domain #F2F2F2 {
            class currency #F7E5FF {
                +{field} iso_code : std::string
                +{field} name : std::string
                +{field} numeric_code : std::string
                +{field} symbol : std::string
                +{field} fraction_symbol : std::string
                +{field} fractions_per_unit : int
                +{field} rounding_type : std::string
                +{field} rounding_precision : int
                +{field} format : std::string
                +{field} currency_type : std::string
                +{field} modified_by : std::string
                +{field} valid_from : std::string
                +{field} valid_to : std::string
            }

            note top of currency
            Represents a currency.

            Fields:

            - iso_code: ISO code for the currency.
            - name: Name of the currency.
            - numeric_code: Numeric code for the currency.
            - symbol: Symbol used for the currency.
            - fraction_symbol: Symbol for fractions.
            - fractions_per_unit: Number of fractions per unit.
            - rounding_type: Type of rounding used.
            - rounding_precision: Precision for rounding.
            - format: Format string for display.
            - currency_type: Type of currency.
            - modified_by: User who modified the currency.
            - valid_from: Start of validity period.
            - valid_to: End of validity period.
            end note

            class currency_version #F7E5FF {
                +{field} data : currency
                +{field} version_number : int
                +{field} modified_by : std::string
                +{field} modified_at : std::string
                +{field} change_summary : std::string
            }

            note top of currency_version
            Represents a specific version of a currency with metadata.

            Fields:

            - data: The currency data at this version.
            - version_number: Version number (1-based, higher is newer).
            - modified_by: Username of the person who created this version.
            - modified_at: Timestamp when this version was created (ISO 8601 format).
            - change_summary: Summary of changes made in this version.
            end note

            currency_version o-u- ores::risk::domain::currency

            class currency_version_history #F7E5FF {
                +{field} iso_code : std::string
                +{field} versions : std::vector<currency_version>
            }

            note top of currency_version_history
            Contains the full version history for a currency.

            Fields:

            - iso_code: ISO code of the currency.
            - versions: All versions of this currency, ordered from newest to oldest.
            end note

            currency_version_history o-u- ores::risk::domain::currency_version
        }

        namespace repository #F2F2F2 {
            class currency_entity <<orm>> #99CB99 {
                +{field} iso_code : sqlgen::PrimaryKey<std::string>
                +{field} name : std::string
                +{field} numeric_code : std::string
                +{field} symbol : std::string
                +{field} fraction_symbol : std::string
                +{field} fractions_per_unit : int
                +{field} rounding_type : std::string
                +{field} rounding_precision : int
                +{field} format : std::string
                +{field} currency_type : std::string
                +{field} modified_by : std::string
                +{field} valid_from : std::optional<sqlgen::Timestamp<"%Y-%m-%d %H:%M:%S">>
                +{field} valid_to : std::optional<sqlgen::Timestamp<"%Y-%m-%d %H:%M:%S">>
            }

            note top of currency_entity
            Represents a currency in the database.

            Fields:

            - iso_code: ISO code for the currency (primary key).
            - name: Name of the currency.
            - numeric_code: Numeric code for the currency.
            - symbol: Symbol used for the currency.
            - fraction_symbol: Symbol for fractions.
            - fractions_per_unit: Number of fractions per unit.
            - rounding_type: Type of rounding used.
            - rounding_precision: Precision for rounding.
            - format: Format string for display.
            - currency_type: Type of currency.
            - modified_by: User who modified the currency.
            - valid_from: Start of validity period.
            - valid_to: End of validity period.
            end note

            class currency_mapper <<orm>> #99CB99 {
                +{static} map(const currency_entity& v) : domain::currency
                +{static} map(const domain::currency& v) : currency_entity
                +{static} map(const std::vector<currency_entity>& v) : std::vector<domain::currency>
                +{static} map(const std::vector<domain::currency>& v) : std::vector<currency_entity>
            }

            note top of currency_mapper
            Maps domain model entities to data storage layer and vice-versa.
            end note

            currency_mapper ..> ores::risk::repository::currency_entity : uses
            currency_mapper ..> ores::risk::domain::currency : uses

            class currency_repository <<orm>> #99CB99 {
                +sql() : std::string
                +write(context ctx, const domain::currency& currencies) : void
                +write(context ctx, const std::vector<domain::currency>& currencies) : void
                +read_latest(context ctx) : std::vector<domain::currency>
                +read_latest(context ctx, const std::string& iso_code) : std::vector<domain::currency>
                +read_at_timepoint(context ctx, const std::string& as_of) : std::vector<domain::currency>
                +read_at_timepoint(context ctx, const std::string& as_of, const std::string& iso_code) : std::vector<domain::currency>
                +read_all(context ctx) : std::vector<domain::currency>
                +read_all(context ctx, const std::string& iso_code) : std::vector<domain::currency>
                +update(context ctx, const domain::currency& currency) : void
                +remove(context ctx, const std::string& iso_code) : void
                -ensure_success(const auto result) : void
                -make_timestamp(const std::string& s) : auto
                -{field} max_timestamp : const std::string
            }

            note top of currency_repository
            Reads and writes currencies off of data storage.
            end note

            currency_repository ..> ores::risk::domain::currency : uses
            currency_repository ..> ores::risk::repository::currency_entity : uses
        }

        namespace generators #F2F2F2 {
            class "<functions>" as currency_generator #FFFACD {
                +{static} generate_synthetic_currency() : domain::currency
                +{static} generate_synthetic_unicode_currencies() : std::vector<domain::currency>
                +{static} generate_synthetic_currencies(std::size_t n) : std::vector<domain::currency>
                +{static} generate_unique_synthetic_currencies(std::size_t n) : std::vector<domain::currency>
            }

            note top of currency_generator
            Functions for generating synthetic currency data.
            end note

            currency_generator ..> ores::risk::domain::currency : generates
        }

        namespace csv #F2F2F2 {
            class exporter #ECECEC {
                +{static} export_currency_config(const std::vector<domain::currency>& v) : std::string
            }

            note top of exporter
            Exports domain objects to their CSV representation.
            end note

            exporter ..> ores::risk::domain::currency : exports
        }

        namespace messaging #F2F2F2 {
            class get_currencies_request <<message>> #E1F5FF {
                +serialize() const : std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t> data) : std::expected<get_currencies_request, comms::messaging::error_code>
            }

            note top of get_currencies_request
            Request to retrieve all currencies.

            This request has no parameters - it retrieves all currencies in the system.
            end note

            class get_currencies_response <<message>> #E1F5FF {
                +{field} currencies : std::vector<domain::currency>
                +serialize() const : std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t> data) : std::expected<get_currencies_response, comms::messaging::error_code>
            }

            note top of get_currencies_response
            Response containing all currencies.

            Fields:

            - currencies: List of all currencies.
            end note

            get_currencies_response o-- ores::risk::domain::currency

            class save_currency_request <<message>> #E1F5FF {
                +{field} currency : domain::currency
                +serialize() const : std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t> data) : std::expected<save_currency_request, comms::messaging::error_code>
            }

            note top of save_currency_request
            Request to save a currency (create or update).

            Due to bitemporal storage, both create and update operations
            result in writing a new record. Database triggers handle
            temporal versioning automatically.

            Fields:

            - currency: The currency to save.
            end note

            save_currency_request o-- ores::risk::domain::currency

            class save_currency_response <<message>> #E1F5FF {
                +{field} success : bool
                +{field} message : std::string
                +serialize() const : std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t> data) : std::expected<save_currency_response, comms::messaging::error_code>
            }

            note top of save_currency_response
            Response confirming currency save operation.

            Fields:

            - success: Whether the operation succeeded.
            - message: Status or error message.
            end note

            class delete_currency_request <<message>> #E1F5FF {
                +{field} iso_code : std::string
                +serialize() const : std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t> data) : std::expected<delete_currency_request, comms::messaging::error_code>
            }

            note top of delete_currency_request
            Request to delete a currency.

            Fields:

            - iso_code: ISO code of the currency to delete.
            end note

            class delete_currency_response <<message>> #E1F5FF {
                +{field} success : bool
                +{field} message : std::string
                +serialize() const : std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t> data) : std::expected<delete_currency_response, comms::messaging::error_code>
            }

            note top of delete_currency_response
            Response confirming currency deletion.

            Fields:

            - success: Whether the operation succeeded.
            - message: Status or error message.
            end note

            class get_currency_history_request <<message>> #E1F5FF {
                +{field} iso_code : std::string
                +serialize() const : std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t> data) : std::expected<get_currency_history_request, comms::messaging::error_code>
            }

            note top of get_currency_history_request
            Request to retrieve version history for a currency.

            Fields:

            - iso_code: ISO code of the currency.
            end note

            class get_currency_history_response <<message>> #E1F5FF {
                +{field} success : bool
                +{field} message : std::string
                +{field} history : domain::currency_version_history
                +serialize() const : std::vector<std::uint8_t>
                +{static} deserialize(std::span<const std::uint8_t> data) : std::expected<get_currency_history_response, comms::messaging::error_code>
            }

            note top of get_currency_history_response
            Response containing currency version history.

            Fields:

            - success: Whether the operation succeeded.
            - message: Status or error message.
            - history: The version history for the currency.
            end note

            get_currency_history_response o-u- ores::risk::domain::currency_version_history

            class risk_message_handler #ECECEC {
                +risk_message_handler(utility::repository::context ctx)
                +handle_message(comms::messaging::message_type type, std::span<const std::uint8_t> payload, const std::string& remote_address) : boost::asio::awaitable<std::expected<std::vector<std::uint8_t>, comms::messaging::error_code>>
                -handle_get_currencies_request(std::span<const std::uint8_t> payload) : boost::asio::awaitable<std::expected<std::vector<std::uint8_t>, comms::messaging::error_code>>
                -handle_update_currency_request(std::span<const std::uint8_t> payload) : boost::asio::awaitable<std::expected<std::vector<std::uint8_t>, comms::messaging::error_code>>
                -handle_delete_currency_request(std::span<const std::uint8_t> payload) : boost::asio::awaitable<std::expected<std::vector<std::uint8_t>, comms::messaging::error_code>>
                -handle_get_currency_history_request(std::span<const std::uint8_t> payload) : boost::asio::awaitable<std::expected<std::vector<std::uint8_t>, comms::messaging::error_code>>
                -handle_save_currency_request(std::span<const std::uint8_t> payload) : boost::asio::awaitable<std::expected<std::vector<std::uint8_t>, comms::messaging::error_code>>
                -{field} ctx_ : utility::repository::context
                -{field} currency_repo_ : repository::currency_repository
            }

            note top of risk_message_handler
            Message handler for risk subsystem messages.

            Processes messages in the risk subsystem range (0x1000-0x1FFF).
            Currently handles:
            - get_currencies_request: Retrieves all currencies from the repository
            end note

            risk_message_handler o-- ores::risk::repository::currency_repository
            risk_message_handler ..> ores::risk::messaging::get_currencies_request : uses
            risk_message_handler ..> ores::risk::messaging::get_currencies_response : uses
            risk_message_handler ..> ores::risk::messaging::save_currency_request : uses
            risk_message_handler ..> ores::risk::messaging::save_currency_response : uses
            risk_message_handler ..> ores::risk::messaging::delete_currency_request : uses
            risk_message_handler ..> ores::risk::messaging::delete_currency_response : uses
            risk_message_handler ..> ores::risk::messaging::get_currency_history_request : uses
            risk_message_handler ..> ores::risk::messaging::get_currency_history_response : uses

            class registrar #ECECEC {
                +{static} register_handlers(comms::server& server, utility::repository::context ctx) : void
            }

            note top of registrar
            Register risk subsystem message handlers with the server.

            Registers handlers for all risk subsystem messages (0x1000-0x1FFF).
            Must be called before server.run().
            end note

            registrar ..> ores::risk::messaging::risk_message_handler : creates
        }

        namespace tests #F2F2F2 {
            class domain_currency_tests <<test suite>> #C5E1A5 {
                +create_currency_with_valid_fields() void
                +create_currency_with_faker() void
                +create_multiple_random_currencies() void
                +create_currency_with_high_precision() void
                +create_currency_with_no_fractions() void
                +create_currency_with_three_decimal_places() void
                +create_currencies_with_different_symbols() void
                +currency_convert_single_to_table() void
                +currency_convert_multiple_to_table() void
                +currency_table_with_faker_data() void
            }

            note top of domain_currency_tests
            Test suite for currency domain model.

            Tests cover currency creation, precision levels,
            decimal places, symbols, and table conversion.
            end note

            domain_currency_tests ..> ores::risk::domain::currency : tests

            class domain_currency_version_tests <<test suite>> #C5E1A5 {
                +create_currency_version_with_valid_fields() void
                +create_currency_version_with_faker() void
                +currency_version_convert_multiple_to_table() void
                +currency_version_table_with_faker_data() void
                +create_currency_version_history_with_valid_fields() void
                +currency_version_history_convert_multiple_to_table() void
                +currency_version_history_table_with_faker_data() void
            }

            note top of domain_currency_version_tests
            Test suite for currency_version domain model.

            Tests cover version creation, history tracking,
            and table conversion with faker data.
            end note

            domain_currency_version_tests ..> ores::risk::domain::currency_version : tests

            class messaging_protocol_tests <<test suite>> #C5E1A5 {
                +get_currencies_request_serialize_deserialize() void
                +get_currencies_response_empty() void
                +get_currencies_response_with_single_currency() void
                +get_currencies_response_serialize_deserialize() void
                +get_currencies_response_large_dataset() void
                +get_currencies_response_with_special_characters() void
                +get_currencies_response_with_empty_fields() void
            }

            note top of messaging_protocol_tests
            Test suite for messaging protocol serialization.

            Tests cover get_currencies request/response messages,
            serialization/deserialization, and edge cases.
            end note

            messaging_protocol_tests ..> ores::risk::messaging::get_currencies_request : tests
            messaging_protocol_tests ..> ores::risk::messaging::get_currencies_response : tests

            class messaging_risk_message_handler_tests <<test suite>> #C5E1A5 {
                +handle_get_currencies_request_empty() void
                +handle_get_currencies_request_with_single_currency() void
                +handle_get_currencies_request_with_multiple_currencies() void
                +handle_get_currencies_request_with_faker() void
                +handle_get_currencies_request_verify_serialization_roundtrip() void
                +handle_get_currencies_request_with_unicode_symbols() void
                +handle_invalid_message_type() void
            }

            note top of messaging_risk_message_handler_tests
            Test suite for risk_message_handler.

            Tests cover currency retrieval scenarios: empty,
            single, multiple, faker data, and error cases.
            end note

            messaging_risk_message_handler_tests ..> ores::risk::messaging::risk_message_handler : tests

            class orexml_currency_config_tests <<test suite>> #C5E1A5 {
                +read_currency_config_from_simple_xml() void
                +read_currency_config_from_currencies_xml() void
                +read_currency_config_from_currencies_01_xml() void
                +read_currency_config_from_currencies_41_xml() void
                +read_currency_config_from_currencies_42_xml() void
                +read_currency_config_from_currencies_62_xml() void
                +read_currency_config_from_currencies_API_xml() void
            }

            note top of orexml_currency_config_tests
            Test suite for ORE XML currency configuration.

            Tests cover reading currency configurations from
            various ORE XML format versions.
            end note

            orexml_currency_config_tests ..> ores::risk::orexml::CurrencyConfig : tests
            orexml_currency_config_tests ..> ores::risk::orexml::importer : tests

            class repository_currency_repository_tests <<test suite>> #C5E1A5 {
                +write_single_currency() void
                +write_multiple_currencies() void
                +read_latest_currencies() void
                +read_latest_currency_by_iso_code() void
                +read_all_currencies() void
                +read_all_currencies_multiple_versions() void
                +read_nonexistent_iso_code() void
                +write_and_read_currency_with_unicode_symbols() void
                +write_and_read_currency_with_no_fractions() void
            }

            note top of repository_currency_repository_tests
            Test suite for currency_repository.

            Tests cover write, read (latest/all), ISO code lookup,
            versioning, and Unicode symbol handling.
            end note

            repository_currency_repository_tests ..> ores::risk::repository::currency_repository : tests
        }
    }
}

' Local Variables:
' compile-command: "java -Djava.awt.headless=true -DPLANTUML_SECURITY_PROFILE=UNSECURE -DPLANTUML_LIMIT_SIZE=65535 -jar /usr/share/plantuml/plantuml.jar ores.risk.puml"
' End:
@enduml
