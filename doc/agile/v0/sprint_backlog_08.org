:PROPERTIES:
:ID: A9FB22A0-E067-46D4-A217-AF10C20DFB90
:END:
#+title: Sprint Backlog 08
#+options: <:nil c:nil ^:nil d:nil date:nil author:nil toc:nil html-postamble:nil
#+todo: STARTED | COMPLETED CANCELLED POSTPONED BLOCKED
#+tags: { code(c) infra(i) analysis(n) agile(a) }
#+startup: inlineimages

* Sprint Mission

- implement reference data.

* Stories

** Active

#+begin: clocktable :maxlevel 3 :scope subtree :tags t :indent nil :emphasize nil :scope file :narrow 75 :formula % :block today
#+TBLNAME: today_summary
#+CAPTION: Clock summary at [2026-01-11 Sun 01:00], for Sunday, January 11, 2026.
|      | <75>                    |        |      |      |       |
| Tags | Headline                | Time   |      |      |     % |
|------+-------------------------+--------+------+------+-------|
|      | *Total time*            | *0:57* |      |      | 100.0 |
|------+-------------------------+--------+------+------+-------|
|      | Stories                 | 0:57   |      |      | 100.0 |
|      | Active                  |        | 0:57 |      | 100.0 |
| code | Change reasons UI fixes |        |      | 0:57 | 100.0 |
#+end:

#+begin: clocktable :maxlevel 3 :scope subtree :tags t :indent nil :emphasize nil :scope file :narrow 75 :formula %
#+TBLNAME: sprint_summary
#+CAPTION: Clock summary at [2026-01-11 Sun 01:00]
|       | <75>                                         |         |       |       |       |
| Tags  | Headline                                     | Time    |       |       |     % |
|-------+----------------------------------------------+---------+-------+-------+-------|
|       | *Total time*                                 | *67:05* |       |       | 100.0 |
|-------+----------------------------------------------+---------+-------+-------+-------|
|       | Stories                                      | 67:05   |       |       | 100.0 |
|       | Active                                       |         | 67:05 |       | 100.0 |
| agile | Sprint and product backlog refinement        |         |       |  1:50 |   2.7 |
| code  | Rerun SQL scripts from scratch               |         |       |  7:52 |  11.7 |
| code  | Run qt client and validate all new features  |         |       |  1:19 |   2.0 |
| code  | Refactor options and parser                  |         |       |  0:27 |   0.7 |
| code  | Check functionality in =ores.wt=             |         |       |  2:03 |   3.1 |
| code  | Rename =ores.shell= to =ores.comms.shell=    |         |       |  1:30 |   2.2 |
| code  | Review HTTP service                          |         |       |  7:24 |  11.0 |
| code  | Assorted fixes to currency dialog            |         |       |  4:19 |   6.4 |
| code  | Add support for offsets in pagination        |         |       |  1:46 |   2.6 |
| code  | Assorted fixes to feature flags dialog       |         |       |  2:52 |   4.3 |
| code  | Add country support                          |         |       |  6:31 |   9.7 |
| code  | Amend and delete reasons base infrastructure |         |       |  5:58 |   8.9 |
| code  | Change reasons UI fixes                      |         |       |  3:34 |   5.3 |
| code  | Assorted fixes to currencies dialog          |         |       |  7:52 |  11.7 |
| code  | Assorted fixes to accounts dialog            |         |       |  1:10 |   1.7 |
| code  | Review comms analyser work                   |         |       |  0:27 |   0.7 |
| code  | Review telemetry work                        |         |       | 10:11 |  15.2 |
#+end:

*** STARTED Sprint and product backlog refinement                     :agile:
    :LOGBOOK:
    CLOCK: [2026-01-08 Thu 09:59]--[2026-01-08 Thu 10:32] =>  0:33
    CLOCK: [2026-01-02 Fri 01:20]--[2026-01-02 Fri 01:32] =>  0:12
    CLOCK: [2025-12-31 Wed 10:21]--[2025-12-31 Wed 11:26] =>  1:05
    :END:

Updates to sprint and product backlog.

#+begin_src emacs-lisp :exports none
;; agenda
(org-agenda-file-to-front)
#+end_src

#+name: pie-stories-chart
#+begin_src R :var sprint_summary=sprint_summary :colnames yes :results file graphics :exports results :file sprint_backlog_08_stories_pie_sorted.png :width 1920 :height 1080
library(conflicted)
library(ggplot2)
library(tidyverse)
library(tibble)

# Filter to only rows with actual story data (non-empty Tags column)
clean_sprint_summary <- sprint_summary %>% dplyr::filter(!is.na(Tags) & nzchar(Tags))
stories <- unlist(clean_sprint_summary[2])
percent_values <- as.numeric(unlist(clean_sprint_summary[6]))

# Create a data frame and explicitly sort the stories by defining factor levels
df <- data.frame(
  stories = stories,
  percent = percent_values
) %>%
  # 1. Sort the data frame by percentage in descending order
  arrange(desc(percent)) %>%
  # 2. Convert 'stories' to a factor, setting the levels based on the sorted order.
  # This makes the order of the slices explicit for ggplot.
  mutate(
    stories = factor(stories, levels = stories),
    lab.pos = cumsum(percent) - 0.5 * percent
  )

# Manually selected colors to resemble the screenshot
custom_palette <- c(
  "#21518f", "#f37735", "#ffc425", "#81b214", "#d7385e",
  "#662e91", "#00a9ae", "#5c5c5c", "#a0c6e0", "#f8b195",
  "#ffe385", "#bde0fe", "#c5e0d4", "#e0b8a0", "#a56f8f",
  "#7a448a", "#4a9a9b", "#9b9b9b", "#6fa8dc", "#f7a072",
  "#ffd166", "#99d98c", "#ef5d60", "#9d529f", "#3a86ff",
  "#c1d6e1", "#f9e0ac", "#c2d6a4", "#e69a8d", "#a07d9f"
)

# Ensure the palette has enough colors for all stories.
if (length(custom_palette) < length(df$stories)) {
  warning("Not enough custom colors for all stories. Colors will repeat.")
  custom_palette <- rep(custom_palette, length.out = length(df$stories))
}

p <- ggplot(df, aes(x = "", y = percent, fill = stories)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start = 0) +
  scale_fill_manual(values = custom_palette) +
  ggtitle("Sprint 8: Resourcing per Story")  +
  labs(x = NULL, y = NULL, fill = "Stories") +
  theme_minimal() +
  theme(
    axis.text.x = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 18),
    legend.position = "right",
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  )

print(p)
#+end_src

#+RESULTS: pie-stories-chart
[[file:sprint_backlog_08_stories_pie_sorted.png]]

#+name: stories-chart
#+begin_src R :var sprint_summary=sprint_summary :colnames yes :results file graphics :exports results :file sprint_backlog_08_stories.png :width 1200 :height 650
library(conflicted)
library(grid)
library(tidyverse)
library(tibble)

# Filter to only rows with actual story data (non-empty Tags column)
clean_sprint_summary <- sprint_summary %>% dplyr::filter(Tags != "")
names <- unlist(clean_sprint_summary[2])
values <- as.numeric(unlist(clean_sprint_summary[6]))

# Create a data frame.
df <- data.frame(
  cost = values,
  stories = factor(names, levels = names[order(values, decreasing = FALSE)]),
  y = seq(length(names)) * 0.9
)

# Setup the colors
blue <- "#076fa2"

p <- ggplot(df) +
  aes(x = cost, y = stories) +
  geom_col(fill = blue, width = 0.6) +
  ggtitle("Sprint 8: Resourcing per Story") +
  xlab("Resourcing (%)") + ylab("Stories") +
  theme(text = element_text(size = 15))

print(p)
#+end_src

#+RESULTS: stories-chart
[[file:sprint_backlog_08_stories.png]]

#+name: tags-chart
#+begin_src R :var sprint_summary=sprint_summary :colnames yes :results file graphics :exports results :file sprint_backlog_08_tags.png :width 600 :height 400
library(conflicted)
library(grid)
library(tidyverse)
library(tibble)

# Filter to only rows with actual story data (non-empty Tags column)
clean_sprint_summary <- sprint_summary %>% dplyr::filter(Tags != "")
names <- unlist(clean_sprint_summary[1])
values <- as.numeric(unlist(clean_sprint_summary[6]))

# Create a data frame.
df <- data.frame(
  cost = values,
  tags = names,
  y = seq(length(names)) * 0.9
)
# factor(names, levels = names[order(values, decreasing = FALSE)])

df2 <- setNames(aggregate(df$cost, by = list(df$tags), FUN = sum),  c("cost", "tags"))
# Setup the colors
blue <- "#076fa2"

p <- ggplot(df2) +
  aes(x = cost, y = tags) +
  geom_col(fill = blue, width = 0.6) +
  ggtitle("Sprint 8: Resourcing per Tag") +
  xlab("Resourcing (%)") + ylab("Story types") +
  theme(text = element_text(size = 15))

print(p)
#+end_src

#+RESULTS: tags-chart
[[file:sprint_backlog_08_tags.png]]

*** OCR scan notebooks for this sprint                                :infra:

We need to scan all of our finance notebooks so we can use them with AI. Each
sprint will have a story similar to this until we scan and process them all.

*** Add AI generated sprint summary                                   :infra:

At the end of the sprint, generate the sprint summary using the prompt.

*** Sprint Demo                                                       :infra:

Time spent doing the demo. This is the first one so it will be very basic.

**** Presentation

***** ORE Studio v0.0.4, "Fazenda Camilunga"

    Marco Craveiro
    Moimba Software Engineering
    Released on 16th November 2025



*** COMPLETED Rerun SQL scripts from scratch                           :code:
    :LOGBOOK:
    CLOCK: [2026-01-01 Thu 22:30]--[2026-01-01 Thu 23:59] =>  1:29
    CLOCK: [2026-01-01 Thu 20:15]--[2026-01-01 Thu 21:10] =>  0:55
    CLOCK: [2026-01-01 Thu 19:08]--[2026-01-01 Thu 19:35] =>  0:27
    CLOCK: [2026-01-01 Thu 17:29]--[2026-01-01 Thu 19:05] =>  1:36
    CLOCK: [2026-01-01 Thu 16:30]--[2026-01-01 Thu 17:28] =>  0:58
    CLOCK: [2025-12-31 Wed 11:27]--[2025-12-31 Wed 13:54] =>  2:27
    :END:

We need to validate the scripts and fix all issues we find.

#+begin_quote
This pull request significantly refines the integration of TimescaleDB within
the ORES SQL schema, making it more adaptable to different TimescaleDB license
tiers and ensuring robust functionality. It introduces runtime license detection
to intelligently enable or disable advanced TimescaleDB features, alongside
implementing per-database extension installation for PostgreSQL. Furthermore,
this PR substantially expands the project's documentation by adding detailed
architectural overviews for the ores.assets and ores.comms.analyser components,
and a comprehensive guide to the overall SQL schema, enhancing clarity and
maintainability for developers and users alike.

Highlights:

- Enhanced TimescaleDB Integration: The system now correctly integrates with
  both Apache and Timescale license editions of TimescaleDB, dynamically
  adjusting features based on the detected license.
- Per-Database Extension Installation: PostgreSQL extensions are now installed
  on a per-database basis, ensuring proper functionality within each ORES
  database instance, including the template.
- Runtime License Detection: SQL scripts now include runtime checks for the
  TimescaleDB license, gracefully skipping advanced features like compression,
  retention policies, and continuous aggregates if only the Apache license is
  present.
- New Component Documentation: Detailed Org-mode documentation has been added
  for the ores.assets and ores.comms.analyser components, outlining their
  architecture, domain types, and usage.
- Comprehensive SQL Schema Documentation: The ores.sql.org file has been added,
  providing extensive documentation on the ORES SQL schema, including
  architecture, design patterns, PostgreSQL extensions (especially TimescaleDB),
  and database creation processes. Schema Prefix for TimescaleDB Functions:
  TimescaleDB function calls in sessions_create.sql and session_stats_create.sql
  now explicitly use the public. schema prefix to avoid issues when search_path
  is set to 'ores'.
#+end_quote

*** COMPLETED =ores.qt= is not using client session                    :code:

*Rationale*: implemented in previous sprint.

Refactor client manager to use it.

*** COMPLETED Remove seeders in code                                   :code:

Since we have to seed from SQL scripts, having code seeding as well is just
confusing.

#+begin_quote
This pull request fundamentally shifts the database seeding mechanism from C++
application code to SQL population scripts. This change centralizes the initial
setup of permissions, roles, and system flags directly within the database
template, simplifying application startup logic and ensuring consistent data
across new instances. Consequently, the test suites have been refactored to
accommodate this pre-seeded state, improving test reliability and reflecting the
new database initialization flow.

Highlights:

- Migration to SQL for Database Seeding: The C++ rbac_seeder and
  system_flags_seeder have been replaced with dedicated SQL population scripts
  for permissions, roles, and system flags, centralizing initial data setup
  within the database template.
- Directory Renaming for Clarity: The sql/data/ directory, containing various
  population scripts and assets, has been renamed to sql/populate/ to better
  reflect its purpose.
- Test Suite Adaptation: Numerous test cases across ores.iam, ores.risk, and
  ores.variability have been updated to correctly handle pre-seeded database
  data, moving away from assumptions of empty databases and instead accounting
  for existing entries.
- Streamlined Instance Initialization: The init_instance.sql script has been
  simplified, removing direct seeding calls as the population is now handled
  during the database template creation process.
- Documentation Refinements: A modeling link in
  projects/modeling/system_model.org was corrected, and
  doc/recipes/sql_recipes.org was updated with new SQL commands and output
  examples.
#+end_quote

*** COMPLETED Run qt client and validate all new features              :code:
    :LOGBOOK:
    CLOCK: [2026-01-02 Fri 00:44]--[2026-01-02 Fri 01:20] =>  0:36
    CLOCK: [2026-01-02 Fri 00:00]--[2026-01-02 Fri 00:43] =>  0:43
    :END:

We added quite a few new features during the holidays but due to the laptop
constraints we could not validate them properly. Check they all work correctly
and fix what needs fixing. Features:

- session monitoring. Looks good for tracking, cannot view in app.
- flags display. Looks good.
- Roles and permissions: cannot edit, display should use a table.

*** COMPLETED Refactor options and parser                              :code:
    :LOGBOOK:
    CLOCK: [2026-01-02 Fri 01:33]--[2026-01-02 Fri 02:00] =>  0:27
    :END:

We have a lot of boost program options parsers and options. We need to do an
inventory of all of the implementations and figure out if we can have common
code under utility.

#+begin_quote
This pull request significantly refactors the command-line interface (CLI)
configuration across various applications by introducing a modular and
composable architecture. The primary goal is to ensure consistency in how
command-line options are defined and parsed, making it easier to manage and
extend CLI functionality. This change centralizes common options and provides
dedicated classes for specific configurations like server, client, and
compression settings, while also enhancing logging capabilities with a new PID
inclusion option.

Highlights:

- Composable CLI Configuration: Introduced new composable configuration classes
  (common_configuration, server_configuration, client_configuration,
  compression_configuration) to standardize command-line options across
  applications.
- Standardized CLI Flags: Standardized common CLI flags such as -h/--help,
  -v/--version, and --verbose across all relevant applications.
- Log PID Inclusion: Added a new --log-include-pid option to include the process
  ID in log filenames, enhancing log management and identification.
- Application Migration: Migrated ores.comms.service, ores.cli, ores.qt, and
  ores.comms.analyser applications to utilize the new configuration architecture
  and standardized flags.
#+end_quote

*** COMPLETED Check functionality in =ores.wt=                         :code:
    :LOGBOOK:
    CLOCK: [2026-01-02 Fri 11:00]--[2026-01-02 Fri 12:49] =>  1:49
    CLOCK: [2026-01-02 Fri 02:01]--[2026-01-02 Fri 02:15] =>  0:14
    :END:

We created the application but did not validate it.

Notes:

- need support for dark and light themes.
- currencies are hard-coded.
- password written to log file.
- can't see details in accounts dialog.
- edit currency dialog is too tall.
- use images for site logo, etc.

*** COMPLETED Rename =ores.shell= to =ores.comms.shell=                :code:
    :LOGBOOK:
    CLOCK: [2026-01-03 Sat 14:10]--[2026-01-03 Sat 15:40] =>  1:30
    :END:

The shell is specific to the binary protocol.

#+begin_quote
This pull request implements a significant renaming effort, transitioning the
ores.shell component to ores.comms.shell. This change clarifies the component's
specific function as an interactive shell for the binary communications
protocol. The modifications are comprehensive, touching all aspects of the
project from file paths and C++ namespaces to build configurations and
user-facing documentation, ensuring consistency and improved clarity regarding
the component's purpose.

Highlights:

- Project Renaming: The ores.shell project has been renamed to ores.comms.shell
  to accurately reflect its role as a shell specifically designed for the binary
  communications protocol.
- Namespace Updates: All C++ namespaces within the project have been updated
  from ores::shell to ores::comms::shell.
- Build System & Paths: CMake targets, include paths, and header guards across
  the project have been modified to align with the new naming convention.
- Documentation Alignment: System UML diagrams, documentation references, and
  shell recipe examples have been updated to reflect the ores.comms.shell name.
#+end_quote

*** COMPLETED Review HTTP service                                      :code:
    :LOGBOOK:
    CLOCK: [2026-01-06 Tue 08:45]--[2026-01-06 Tue 10:02] =>  1:17
    CLOCK: [2026-01-06 Tue 01:33]--[2026-01-06 Tue 01:54] =>  0:21
    CLOCK: [2026-01-05 Mon 23:31]--[2026-01-06 Tue 01:32] =>  2:01
    CLOCK: [2026-01-05 Mon 16:01]--[2026-01-05 Mon 18:02] =>  2:01
    CLOCK: [2026-01-03 Sat 23:50]--[2026-01-04 Sun 01:34] =>  1:44
    :END:

We need to make sure the swagger works, create recipes etc.

*** COMPLETED Assorted fixes to currency dialog                        :code:
    :LOGBOOK:
    CLOCK: [2026-01-06 Tue 10:03]--[2026-01-06 Tue 11:47] =>  1:44
    CLOCK: [2026-01-05 Mon 22:15]--[2026-01-05 Mon 23:30] =>  1:15
    CLOCK: [2026-01-05 Mon 19:00]--[2026-01-05 Mon 20:20] =>  1:20
    :END:

At present the following is not working or is a snag:

- can we make the details windows unmaximisable.
- We need to either make the columns configurable, or remove some less useful
  columns such as symbol, fraction etc. These are still visible in details.
- can we refactor reload logic into common entity code?
- wrong icon in revert for currency history. no option to reload history
- when creating a new currency we cannot attach a flag to it.

*** COMPLETED Troubleshoot skills in claude                           :infra:

*Rationale*: this seems to work now, with the rename to SKILLS.md.

We don't seem to be able to use skills reliably.

Links:

- [[https://code.claude.com/docs/en/skills][Claude: Agent Skills]]
- [[https://www.reddit.com/r/ClaudeCode/comments/1oywsa1/claude_code_skills_activate_20_of_the_time_heres/][reddit: Claude Code skills activate 20% of the time. Here's how I got to 84%.]]
- [[https://scottspence.com/posts/how-to-make-claude-code-skills-activate-reliably][How to Make Claude Code Skills Activate Reliably]]

*** COMPLETED Add support for simple log shipping                      :code:

*Rationale*: implemented with telemetry work.

It would be very useful to be able to browse both client and server logs from
the client (either command line or qt). This will be even more useful with AI
agents. Add a simple component that periodically loads up the logs to the
database.

Possible names: log shipping, log forwarding, etc.

*** COMPLETED Merge toolbars when you maximise currencies              :code:

*Rationale*: you can't maximise currencies any longer.

At present we end up with two tool bars, one below the other.

*** COMPLETED Add support for JWT                                      :code:

*Rationale*: implemented.

When we add support for HTTP/REST, we need to ensure it uses JWT.

Links:

- [[https://iniakunhuda.medium.com/building-secure-jwt-authentication-in-go-with-postgresql-94b6724f9b75][Building Secure JWT Authentication in Go with PostgreSQL]]
- [[https://github.com/Thalhammer/jwt-cpp][GH jwt-cpp]]

*** COMPLETED Add support for offsets in pagination                    :code:
    :LOGBOOK:
    CLOCK: [2026-01-07 Wed 15:30]--[2026-01-07 Wed 16:28] =>  0:58
    CLOCK: [2026-01-07 Wed 14:41]--[2026-01-07 Wed 15:29] =>  0:48
    :END:

#+begin_quote
This pull request focuses on a significant upgrade to the sqlgen library, moving
to version 0.6.0. This update allows for the removal of several previous
workarounds, including custom vcpkg overlay ports and a single_connection hack
for aggregation queries. The primary impact is the adoption of sqlgen's native
offset() and limit() operators, which streamlines pagination logic across
various repositories, improving the robustness and maintainability of database
interactions throughout the codebase.

Highlights:

- SQLGen Update: The sqlgen library has been updated to version 0.6.0 by
  updating the vcpkg submodule to the latest release.
- Overlay Port Removal: Custom vcpkg overlay ports for sqlgen have been removed
  as the necessary fixes and features are now merged upstream into the main
  sqlgen repository.
- Native Pagination Support: Manual offset and limit workarounds in database
  queries have been replaced with sqlgen's new native offset() and limit()
  operators, simplifying pagination logic.
- Single Connection Removal: The single_connection hack, previously used for
  aggregation queries due to a sqlgen limitation (issue Fix cli tests #99), has
  been removed as sqlgen 0.6.0 resolves this issue. Consequently, the
  single_connection member has been removed from the database context entirely.
- Expanded Pagination: Pagination support (offset/limit + total count) has been
  added to feature_flags_repository, role_repository, permission_repository,
  image_repository, tag_repository, and login_info_repository.
#+end_quote

Now available in vcpkg with all required features.

At present we disabled pagination in UI because sqlgen does not support offset.
We implemented this feature in sqlgen. When it is released to vcpkg we should
update our code to use it.

Remember also this:

#+begin_src c++
    // HACK: Using single connection instead of session because sqlgen sessions
    // doesn't seem to support SELECT FROM with aggregations. Plain connections
    // work fine. This is a temporary workaround until the sqlgen library is
    // fixed. See: https://github.com/getml/sqlgen/issues/99
    struct count_result {
        long long count;
    };
#+end_src

Links:

- [[https://github.com/getml/sqlgen/issues/100][GH #100: Feature request: offset support]]
- https://vcpkg.io/en/packages?query=sqlgen

*** COMPLETED Add faker support to model                               :code:

*Rationale*: already implemented.

vcpkg will support faker soon:

- [[https://github.com/microsoft/vcpkg/pull/38583][#38583: [faker-cxx] add new port]]

When that is available, we should try to add support for it.

*** COMPLETED Assorted fixes to feature flags dialog                   :code:
    :LOGBOOK:
    CLOCK: [2026-01-08 Thu 13:24]--[2026-01-08 Thu 13:48] =>  0:24
    CLOCK: [2026-01-08 Thu 10:55]--[2026-01-08 Thu 13:23] =>  2:28
    :END:

#+begin_quote
This pull request significantly enhances the user experience for managing
feature flags within the Qt application. It introduces real-time feedback
through event subscriptions and visual cues like pulsing highlights for recent
changes and colored badges for status. Additionally, it improves data
presentation by adding new columns and refining the detail dialog, while also
updating the backend protocol to support these new data points. The changes aim
to make feature flag management more intuitive and informative for users.

Highlights:

- Real-time Updates: The UI now subscribes to feature flag change events,
  enabling real-time updates and notifications when flags are modified
  externally.
- Recency Highlighting: Recently modified feature flags in the list view will
  now display a pulsing yellow highlight to draw attention to their recent
  changes.
- Enhanced 'Enabled' Column: The 'Enabled' column in the feature flags list now
  uses colored badges (green for 'Yes', gray for 'No') for improved visual
  clarity.
- New Data Columns: The feature flags list has been augmented with 'Version' and
  'Recorded At' columns, providing more detailed historical context for each
  flag.
- Improved Detail Dialog UX: The feature flag detail dialog has been updated to
  use a combo box for the 'Enabled' status and now displays the 'Recorded At'
  timestamp.
- Optimized Reload Behavior: Saving a feature flag or receiving an external
  change notification now marks the list as 'stale' instead of triggering an
  immediate auto-reload, improving responsiveness.
- Protocol Updates: The underlying communication protocol has been updated to
  version 20.0 to include the new 'recorded_at' and 'version' fields for feature
  flags.
- Logging Cleanup: All MXN-specific debug logging has been removed from the
  ImageCache component, streamlining log output.
#+end_quote

*** COMPLETED Create a set of fake currencies                          :code:

We need to create fake data so we can explore the problem domain. This is
something to work on in the future. We can use LLMs to help with the fake data,
where it makes sense.

Example:

| Country code | Country name | Currency Code | Currency Number | Currency           |
|--------------+--------------+---------------+-----------------+--------------------|
| AL           | Aerilon      | ALD           |           10001 | Aerilonian Dollar  |
| AR           | Arcturia     | ARA           |           10002 | Arcturian Arct     |
| BA           | Balthoria    | BAF           |           10003 | Balthorian Florin  |
| BE           | Belloria     | BEB           |           10004 | Bellorian Bell     |
| CA           | Calandria    | CAC           |           10005 | Calandrian Crown   |
| CD           | Caledonia    | CDC           |           10006 | Caledonian Caled   |
| DA           | Daeloria     | DAD           |           10007 | Daelorian Dinar    |
| DE           | Delvadia     | DED           |           10008 | Delvadian Delv     |
| ER           | Eriador      | ERE           |           10009 | Eriadoran Euro     |
| ES           | Esteria      | ESE           |           10010 | Esterian Est       |
| FE           | Feloria      | FEF           |           10011 | Felorian Franc     |
| FN           | Fendaria     | FNF           |           10012 | Fendarian Fen      |
| GA           | Galdoria     | GAG           |           10013 | Galdorian Galleon  |
| GR           | Grendoria    | GRG           |           10014 | Grendorian Grend   |
| HE           | Helvetia     | HEF           |           10015 | Helvetian Franc    |
| HY           | Hydronia     | HYH           |           10016 | Hydronian Hyd      |
| IR           | Iridia       | IRD           |           10017 | Iridian Dollar     |
| IT           | Ithaca       | ITI           |           10018 | Ithacan Ith        |
| JE           | Jethro       | JEJ           |           10019 | Jethronian Jet     |
| JO           | Jorvik       | JOK           |           10020 | Jorvikian Krona    |
| KA           | Kaelor       | KAK           |           10021 | Kaelorian Krown    |
| KR           | Krynn        | KRK           |           10022 | Krynnish Krynn     |
| LU           | Luminia      | LUL           |           10023 | Luminian Lum       |
| LY           | Lysandria    | LYL           |           10024 | Lysandrian Lira    |
| MA           | Maldoria     | MAM           |           10025 | Maldorian Mal      |
| MR           | Mariposa     | MRP           |           10026 | Mariposan Peso     |
| NE           | Nektonia     | NEN           |           10027 | Nektonian Nek      |
| NT           | Netharia     | NTN           |           10028 | Netharian Naira    |
| OR           | Orinoco      | ORB           |           10029 | Orinocan Bolivar   |
| OL           | Orlanthia    | OLO           |           10030 | Orlanthian Orl     |
| PA           | Paldoria     | PAP           |           10031 | Paldorian Peso     |
| PY           | Pyrrhia      | PYP           |           10032 | Pyrrhian Pyr       |
| QU           | Quentaria    | QUQ           |           10033 | Quentarian Quen    |
| QN           | Quinaria     | QNQ           |           10034 | Quinarian Quetzal  |
| RE           | Rendellia    | RER           |           10035 | Rendellian Rend    |
| RI           | Rivenia      | RIR           |           10036 | Rivenian Ruble     |
| SE           | Serendia     | SES           |           10037 | Serendian Shilling |
| SI           | Sildoria     | SIS           |           10038 | Sildorian Sild     |
| TA           | Tandor       | TAT           |           10039 | Tandorian Taka     |
| TE           | Tenebria     | TET           |           10040 | Tenebrian Ten      |
| UL           | Uldoria      | ULU           |           10041 | Uldorian Uld       |
| UT           | Utopia       | UTU           |           10042 | Utopian Unit       |
| VA           | Valoria      | VAV           |           10042 | Valorian Valt      |
| VL           | Valtaria     | VLV           |           10043 | Valtarian Val      |
| WI           | Wintervale   | WIW           |           10044 | Wintervalean Won   |
| WY           | Wysteria     | WYW           |           10045 | Wysterian Wys      |
| XA           | Xandria      | XAX           |           10046 | Xandrian Xan       |
| XE           | Xenoria      | XEX           |           10047 | Xenorian Xen       |
| YS           | Yslandia     | YSY           |           10048 | Yslandian Yen      |
| ZE           | Zephyria     | ZEZ           |           10049 | Zephyrian Zephyr   |

*** COMPLETED Add country support                                      :code:
    :LOGBOOK:
    CLOCK: [2026-01-08 Thu 21:30]--[2026-01-08 Thu 23:30] =>  2:00
    CLOCK: [2026-01-08 Thu 20:20]--[2026-01-08 Thu 20:51] =>  0:31
    CLOCK: [2026-01-08 Thu 18:10]--[2026-01-08 Thu 19:16] =>  1:06
    CLOCK: [2026-01-08 Thu 15:33]--[2026-01-08 Thu 16:33] =>  1:00
    CLOCK: [2026-01-08 Thu 13:49]--[2026-01-08 Thu 14:06] =>  0:17
    CLOCK: [2026-01-07 Wed 22:02]--[2026-01-07 Wed 23:06] =>  1:04
    CLOCK: [2026-01-07 Wed 19:01]--[2026-01-07 Wed 19:34] =>  0:33
    :END:

#+begin_quote
This pull request significantly expands the application's data management
capabilities by adding full support for ISO 3166-1 countries. It establishes new
data structures, persistence mechanisms, and a service layer for country-related
operations, alongside user interface components for interactive management. The
changes ensure that country data is stored bitemporally, allowing for historical
tracking and auditing, and provides a framework for associating countries with
visual assets like flags.

Highlights:

- ISO 3166-1 Country Support: Introduced a comprehensive system for managing ISO
  3166-1 countries, including domain models, bitemporal repository, and a
  dedicated service layer within the ores.risk module.
- Database Schema and Population: Added new SQL scripts to create a bitemporal
  countries table and populate it with data for all 249 ISO 3166-1 countries.
  Also included drop scripts for cleanup.
- Country Image Linkage: Implemented a new country_images table and associated
  domain, repository, and mapper components in ores.assets to link countries
  with their flag images.
- Web UI Components: Developed new Wt UI components, country_list_widget and
  country_dialog, enabling full CRUD (Create, Read, Update, Delete) operations
  for country data through the web interface.
- Service Integration: Integrated the new country_service into the
  application_context to make country management functionalities available
  across the application.
#+end_quote

Add standard ISO country codes.

*** COMPLETED Amend and delete reasons base infrastructure             :code:
    :LOGBOOK:
    CLOCK: [2026-01-09 Fri 15:07]--[2026-01-09 Fri 20:00] =>  4:53
    CLOCK: [2026-01-09 Fri 14:01]--[2026-01-09 Fri 15:06] =>  1:05
    :END:

#+begin_quote
This pull request significantly enhances the database's change tracking
capabilities by introducing a comprehensive amendment control schema. The new
tables and associated logic provide a structured way to record and categorize
reasons for data modifications and deletions, which is crucial for maintaining
data integrity and meeting stringent regulatory requirements. This foundational
change enables a more auditable and compliant data management framework.

Highlights:

- New Temporal Tables for Amendment Control: Introduced three new temporal
  tables: reason_categories, amendment_reasons, and entity_reason_categories.
  These tables are designed to track changes and provide historical context for
  data amendments and deletions.
- Regulatory-Compliant Taxonomy: Implemented a taxonomy for amendment reasons
  that aligns with key financial regulatory standards, including BCBS 239, FRTB,
  FINRA, and MiFID II, ensuring robust auditability and compliance.
- Idempotent Data Population: Added idempotent population scripts that seed the
  new tables with initial data, including 3 reason categories ('system',
  'common', 'trade') and 17 specific amendment reasons. This ensures consistent
  setup across environments.
- Temporal Versioning and Soft Deletes: Each new table incorporates temporal
  versioning via valid_from and valid_to columns, managed by BEFORE INSERT
  triggers. Deletion is handled as a soft delete using INSTEAD OF DELETE rules,
  preserving historical data.
#+end_quote

**** Tasks

- [X] Create SQL schema for change_reason_categories and change_reasons tables
- [X] Create C++ domain types (change_reason_category, change_reason)
- [X] Create JSON I/O for both types
- [X] Create Table I/O for both types
- [X] Create generators for both types
- [X] Create repository entities and mappers
- [X] Create repositories with CRUD operations
- [X] Create change_management_service
- [X] Create messaging protocol (get_change_reason_categories, get_change_reasons, get_change_reasons_by_category)
- [X] Integrate handlers into accounts_message_handler
- [X] Build and test (895 assertions, 227 test cases passed)
- [X] Create Qt UI for change management
- [ ] Add protocol support for creating/updating/deleting reasons

**** Modified files

- =projects/ores.iam/include/ores.iam/domain/change_reason_category.hpp= - Domain type
- =projects/ores.iam/include/ores.iam/domain/change_reason.hpp= - Domain type
- =projects/ores.iam/src/domain/change_reason_category_json_io.cpp= - JSON serialization
- =projects/ores.iam/src/domain/change_reason_json_io.cpp= - JSON serialization
- =projects/ores.iam/src/domain/change_reason_category_table*.cpp= - Table I/O
- =projects/ores.iam/src/domain/change_reason_table*.cpp= - Table I/O
- =projects/ores.iam/src/generators/change_reason_category_generator.cpp= - Test data generation
- =projects/ores.iam/src/generators/change_reason_generator.cpp= - Test data generation
- =projects/ores.iam/src/repository/change_reason_category_*.cpp= - Repository layer
- =projects/ores.iam/src/repository/change_reason_*.cpp= - Repository layer
- =projects/ores.iam/src/service/change_management_service.cpp= - Service layer
- =projects/ores.iam/src/messaging/change_management_protocol.cpp= - Protocol messages
- =projects/ores.iam/src/messaging/accounts_message_handler.cpp= - Handler integration
- =projects/ores.comms/include/ores.comms/messaging/message_types.hpp= - New message types (0x2050-0x2055)
- =projects/ores.iam/include/ores.iam/eventing/change_reason_category_changed_event.hpp= - Category change event
- =projects/ores.iam/include/ores.iam/eventing/change_reason_changed_event.hpp= - Reason change event
- =projects/ores.qt/include/ores.qt/ClientChangeReasonCategoryModel.hpp= - Qt model for categories
- =projects/ores.qt/src/ClientChangeReasonCategoryModel.cpp= - Qt model implementation
- =projects/ores.qt/include/ores.qt/ChangeReasonCategoryMdiWindow.hpp= - Category list window
- =projects/ores.qt/src/ChangeReasonCategoryMdiWindow.cpp= - Category list window implementation
- =projects/ores.qt/include/ores.qt/ChangeReasonCategoryController.hpp= - Category controller
- =projects/ores.qt/src/ChangeReasonCategoryController.cpp= - Category controller implementation
- =projects/ores.qt/include/ores.qt/ClientChangeReasonModel.hpp= - Qt model for reasons
- =projects/ores.qt/src/ClientChangeReasonModel.cpp= - Qt model implementation
- =projects/ores.qt/include/ores.qt/ChangeReasonMdiWindow.hpp= - Reason list window
- =projects/ores.qt/src/ChangeReasonMdiWindow.cpp= - Reason list window implementation
- =projects/ores.qt/include/ores.qt/ChangeReasonController.hpp= - Reason controller
- =projects/ores.qt/src/ChangeReasonController.cpp= - Reason controller implementation
- =projects/ores.qt/ui/MainWindow.ui= - Added menu entries for change management
- =projects/ores.qt/include/ores.qt/MainWindow.hpp= - Added controller declarations
- =projects/ores.qt/src/MainWindow.cpp= - Integrated change management controllers

Sketch analysis:

All entities need a reason for amends and deletes, and they should also support
comments.

Different entities will have different reasons. For example, reasons for
currencies, countries:

- Front Office Error
- Operations Error
- Dummy Amend (we need a button for dummy amend and maybe a better name)
- Duplicate (delete only)

We need some kind of grouping for the reasons:

- static data group
- trade related
- market data

And the reason should say if is applicable to amend and/or delete.

*** COMPLETED Change reasons UI fixes                                  :code:
    :LOGBOOK:
    CLOCK: [2026-01-10 Sat 23:12]--[2026-01-11 Sun 00:57] =>  1:45
    CLOCK: [2026-01-10 Sat 07:41]--[2026-01-10 Sat 08:35] =>  0:54
    CLOCK: [2026-01-09 Fri 20:20]--[2026-01-09 Fri 21:15] =>  0:55
    :END:

#+begin_quote
This pull request significantly enhances the system's data integrity and
auditability by introducing a robust change tracking mechanism. It establishes a
structured framework for recording and categorizing reasons behind all entity
modifications, crucial for regulatory compliance and transparent data
management. This foundational change impacts both the database schema and the
user interface, ensuring that every alteration is justified and documented.

Highlights:

- Change Tracking Infrastructure: Introduced 'change_reasons' and
  'change_reason_categories' database tables for comprehensive entity
  modification tracking.
- Entity Integration: Integrated 'change_reason_code' and 'change_commentary'
  fields into all temporal entities across the system for audit trails.
- Qt User Interface for Management: Implemented a Qt UI for administrators to
  manage change reason categories and individual reasons.
- Mandatory Reason Selection: Added a 'ChangeReasonDialog' popup to enforce
  mandatory reason selection when saving existing entities in the UI.
- Client-Side Caching: Developed a 'ChangeReasonCache' for efficient client-side
  caching and event-driven refresh of change reasons.
- History Visibility: Enhanced entity history dialogs to display the associated
  change reason and commentary.
- Protocol Version Update: Updated the messaging protocol version to 21.1,
  standardizing naming conventions (e.g., 'list' to 'get', 'create'/'update' to
  'save') and incorporating change tracking fields.
#+end_quote

Review:

- both: missing reason for change in change reasons. Done.
- categories: does not ask for reason on save, no option to add comment. Done.
- categories: remove description from main list, add header configuration so
  users can add them if they want. Done
- change reasons are not showing categories in combo box. would be nice if there
  was a box to show the category details near the combo box. Done.
- both: recorded at uses human readable time but no other dialog does. Done.
- change reason: make description a bigger box. Done.
- change reason cannot save. Done.
- history: don't need change reason and commentary in full details, it's already
  at the top. Done.
- save dialog: rename "save changes" to just "save". Done.
- details dialogs: should allow save even when no fields have changed, but then
  it should be hard coded to touch. will be checked on the server side. Done.
- save dialog: cannot be touch if any of the fields changed. will be checked on
  the server side. Done.
- details dialogs: meta-data missing change management fields. Done.
- code: CHECK_DIFF_STRING: why not use a regular c++ function? avoid macros. Done.
- both change management dialogs: should be possible to add, delete and edit. Done.
- change reason: code column should be wider.
- change reason: commentary column is too narrow.
- both change management dialogs: remove description, will show in details dialog.
- change reason: is grid following CSS with spacing, etc? Done.
- both change management dialogs: recorded at should use human readable time. Done.
- both change management dialogs: icons not following skill icon-guidelines. Done.
- both change management dialogs: no history. Done.
- both change management dialogs: details is not a standard details window like
  all other details. Done.
- change reason: use emblems like we do in accounts for yes and no, with yes in
  green. Done.
- both change management: menu icons for change are not very
  informative. have a look at the icons for change reasons and change reason
  categories: /home/marco/Development/fluentui-system-icons-mayin/assets. Done.
- both change management dialogs: not using standard icons. see skill
  icon-guidelines. Done.
- refactor: have a common save dialog.

*** COMPLETED Assorted fixes to currencies dialog                      :code:
    :LOGBOOK:
    CLOCK: [2026-01-09 Fri 08:45]--[2026-01-09 Fri 10:16] =>  1:31
    CLOCK: [2026-01-09 Fri 00:59]--[2026-01-09 Fri 01:17] =>  0:18
    CLOCK: [2026-01-08 Thu 23:31]--[2026-01-09 Fri 00:58] =>  1:27
    CLOCK: [2026-01-08 Thu 08:40]--[2026-01-08 Thu 09:58] =>  1:18
    CLOCK: [2026-01-07 Wed 23:21]--[2026-01-08 Thu 00:49] =>  1:28
    CLOCK: [2026-01-07 Wed 23:07]--[2026-01-07 Wed 23:20] =>  0:13
    CLOCK: [2026-01-07 Wed 16:29]--[2026-01-07 Wed 18:06] =>  1:37
    :END:

- updating flag does not seem to update after reload. Done.
- can't see flag changes in history. Done.
- cannot revert to version in history. Get an error saying incorrect version.
  Done.

*** STARTED Assorted fixes to accounts dialog                          :code:
    :LOGBOOK:
    CLOCK: [2026-01-09 Fri 10:16]--[2026-01-09 Fri 11:26] =>  1:10
    :END:

- on my account, email saved successfully is not very visible. Instead, make
  save button enabled after changes, once saved disable it. My account should be
  a regular dialog, allowing you to keep it open and interact with rest of the app.
- session history should not be maximisable.
- sessions still have 0 bytes sent and received.
- add any details such as instance id to session.
- last login field does not fit the screen.
- cannot reload account in account details. Need reload button.
- remove "grant administrative privileges" from details screen.
- old users remain online. Server should check sessions on start and update
  table.
- cannot tell who unlocked an account and when.
- do not use "old" for accounts who never logged in. Maybe "unused"?
- at present you can't tell if you asked for a password reset. We probably
  should use Status to mean: locked, unlocked, reset. And maybe "Age" or "Last
  Login" to mean: online, never, recent, old.
- add right-click menu with the context options from the toolbar.
- after reload, lock etc remember which line we were on and return to it.
- email updated message is truncated.
- user cannot lock it's own account.

*** STARTED Review comms analyser work                                 :code:
    :LOGBOOK:
    CLOCK: [2026-01-06 Tue 11:48]--[2026-01-06 Tue 12:15] =>  0:27
    :END:

Need to check this works and add UI for it.

*** STARTED Review telemetry work                                      :code:
    :LOGBOOK:
    CLOCK: [2026-01-07 Wed 12:19]--[2026-01-07 Wed 13:40] =>  1:21
    CLOCK: [2026-01-07 Wed 10:45]--[2026-01-07 Wed 12:18] =>  1:33
    CLOCK: [2026-01-07 Wed 10:14]--[2026-01-07 Wed 10:44] =>  0:30
    CLOCK: [2026-01-07 Wed 09:11]--[2026-01-07 Wed 10:13] =>  1:02
    CLOCK: [2026-01-06 Tue 22:45]--[2026-01-06 Tue 23:40] =>  0:55
    CLOCK: [2026-01-06 Tue 19:10]--[2026-01-06 Tue 20:00] =>  0:50
    CLOCK: [2026-01-06 Tue 14:45]--[2026-01-06 Tue 18:45] =>  4:00
    :END:

It seems we did not add database support for telemetry.

Ores.QT:

- logging about telemetry generates telemetry events. Done.
- unknown in telemetry. Done.

#+begin_src logviewer
2026-01-07 12:03:24.195664 [INFO] [ores.telemetry.messaging.telemetry_message_handler] Persisted 29 telemetry log entries from unknown
#+end_src

- event viewer is always on top
- can't see timestamps properly in event viewer. can't see event type.
- make accounts dialog bigger. do not allow resizing.
- update flag does not update cache in currency dialog.

*** STARTED Event viewer review                                        :code:

- new events raise the dialog.
- cannot see account created events but can see currencies created.
- when a user logs in or out it does not generate an event, should it?
- saving new flag does not save it in server side.
- non admin users can see roles, update feature flags.
- account is locked due to many failed attempts: just say account is locked.
- remove check box in main feature flags table.
- replace the blurb in feature flags with a simple combo for enabled/disabled.
- enabling feature flag does not show events in event viewer on any ores.qt,
  reload does not go yellow.
- can't add, delete etc for roles. Make dialog bigger, do not allow maximising.
  Probably has no eventing.
- cannot add or remove permissions for a role, cannot add new permissions (which
  probably makes sense?)
- cannot distinguish accounts created by user or by sign-up.
- event viewer should have a ring buffer with the last N events. always captures
  even when dialog is not switched on. We don't know when we want to see events
  up front.
- error events should be marked with an error so we can see them quickly.

*** Add support for staging                                            :code:

- on import, are we importing one currency at a time? should import the entire
  file.

*** Non-classified observations                                    :analysis:

Observations, snags and so forth that have not been analysed to form a proper
story.

- should be possible to click on user and see user profile details. If the user
  is admin, show all details; if not, show only key ones like email, etc.
- remove maximise button.
- test suites need to log version at the start. info script needs to grep log
  for version for all suites.
- no generators for roles and permissions it seems.
- we still have the legacy password salt field.
- should role permission tables have change reasons?
- missing ores.analyser from system model.
- add flag "is iso compliant" or some such for currencies and countries which
  are in the standard.
- allow users displaying password in password boxes.
- send and receive are empty in sessions.
- next, can you explain the difference in window types between the main currency
  dialog and say currency history and currency details. we switched of minimise
  button on the currency history and currency details and that worked fine. we
  tried switching it off on the main currency window twice and that never seems
  to work. can we make all windows the same type? same as currency history /
  currency details.
- merge common functionality between entities in ores.qt.
- updating email from my account does not raise an event.
- fictional countries should also have X prefixes
- generate button should only exist in new, not edit.
- no save button in currency list, need for generation
- would be nice to be able to "locally modify" entity and then press save for
  the batch. in git we call this staging, what name should we use? and what
  icon?
- server should peridically house keep sessions. if not connected, just mark it
  as orphan. also when connection is dropped mark session as finished.
- shouldn't revert to version be a server side operation? e.g. current version,
  target version.
- in the history diff, add a "from version" combo which shows either latest or
  previous.

*** Accounts need to have a human or robot field                       :code:

Look for correct terminology (actor type?).

*** Add a flag for human readable time                                 :code:

We should be able to use regular timestamps or human readable time.

*** Currencies should have tags                                        :code:

Examples:

- metals, emerging markets
- continent as a tag
- crypto

*** Retrieve NAT'ed IP address from local IP                           :code:

It would be nice to be able to resolve to the NAT'ed IP address. Gemini:

#+begin_src cpp
#include <iostream>
#include <string>
#include <boost/asio.hpp>

using boost::asio::ip::tcp;

std::string get_public_ip() { try { boost::asio::io_context io_context;

    // 1. Resolve the address for api.ipify.org
    tcp::resolver resolver(io_context);
    tcp::resolver::results_type endpoints = resolver.resolve("api.ipify.org", "http");

    // 2. Connect to the server
    tcp::socket socket(io_context);
    boost::asio::connect(socket, endpoints);

    // 3. Formulate the HTTP GET request
    std::string request =
        "GET / HTTP/1.1\r\n"
        "Host: api.ipify.org\r\n"
        "Connection: close\r\n\r\n";

    // 4. Send the request
    boost::asio::write(socket, boost::asio::buffer(request));

    // 5. Read the response
    boost::asio::streambuf response;
    boost::asio::read_until(socket, response, "\r\n");

    // Check the status line (optional but recommended)
    std::istream response_stream(&response);
    std::string http_version;
    unsigned int status_code;
    response_stream >> http_version >> status_code;

    if (status_code != 200) {
        return "Error: HTTP Status " + std::to_string(status_code);
    }

    // Skip the HTTP headers
    boost::asio::read_until(socket, response, "\r\n\r\n");

    // The remaining data in the buffer (and what's left to read) is the IP
    std::string public_ip;
    while (boost::asio::read(socket, response, boost::asio::transfer_at_least(1), boost::system::error_code())) {
        // Keep reading until EOF
    }

    // Convert the body content to a string
    std::stringstream ss;
    ss << &response;
    public_ip = ss.str();

    // api.ipify.org returns only the IP as plain text in the body
    return public_ip;

} catch (std::exception& e) {
    return std::string("Exception: ") + e.what();
}
}

int main() {
        stdout::cout << "Fetching public IP..." << std::endl;
        std::string ip = get_public_ip();
        std::cout << "Your Public IP is: " << ip << std::endl;
        return 0;
}
#+end_src


*** Users should be able to add picture to profile                     :code:

It would be useful to have avatars. We can then display those in other places.

*** Add support for protocol debugging in Qt                           :code:

We should add a view of all messages sent and received like the comms champ
tools. It should be possible to record a session to file (maybe all the
requests?) and then replay that session. You should be able to do it from the
UI.

Links:

- [[https://github.com/commschamp/cc_tools_qt][GH: cc_tools_qt]]: "This project contains tool application(s), which can be used
  to develop, monitor and debug custom binary communication protocols, that were
  developed using the COMMS Library. All the applications are plug-in based,
  i.e. plug-ins are used to define I/O socket, data filters, and the custom
  protocol itself. The tools use Qt framework for GUI interfaces as well as
  loading and managing plug-ins."
- [[https://github.com/commschamp/cc_tools_qt/wiki/How-to-Use-CommsChampion-Tools][How to Use CommsChampion Tools]]: screenshots of the UI to explore the protocol.

*** History should have a revert button                                :code:

It should be possible to choose a given version and ask the system to revert the
currency to that version. It just makes an update with a new version to look
like that version. It should also be possible to open at version. It shows the
edit dialog in "read only mode" with the entity at that version. The tool bar
should indicate this. It should also have a revert in that dialog.

*** Assorted UI polish work                                            :code:

Break these down into their own stories:

- icons for CRUD are not enabling when on detached mode.
- no status bar in dettached mode.
- should we just have toolbars at the detached window level?
- application should exit when main window is closed.
- is it possible to dock windows like visual studio?
- add a detach current window that just detaches that window.
- disabled menu options are not properly greyed out. Done.

*** Instrument components with telemetry context                       :code:

Now that logging has been integrated with telemetry, the next step is to
instrument key components with the =TLOG_SEV= macro to enable trace correlation.

Tasks:

- Instrument =server_session= with root span on connection, child spans per
  request.
- Instrument =client_session= with spans for outgoing requests.
- Pass =telemetry_context= through message handlers in ores.iam, ores.risk, etc.
- Add spans for database operations in ores.database.

*** Add widget to manage assets                                        :code:

We can't upload flags etc.

*** Add UI for log viewing                                             :code:

We should be able to see the log from qt.

Notes:

- it should be possible to change the log level from the UI for both the Qt app
  and the service.

Links:

- [[https://github.com/Dingola/Qt-LogViewer/tree/main][GH: Qt-LogViewer]]



*** Update currency details to use tabs                                :code:

We need a main tab with the currency related properties, then a "system" tab
with temporal data which is read-only even on edit and a "image" tab with the
image used to represent the currency. It could also contain some description or
notes.


*** Locking an account should log user out                             :code:

At present if you lock an account the user will remain logged in.

*** Review of Wt                                                       :code:

Problems:

- no icons in website for the tab.
- no flags in currencies in wt.
- no way of knowing about reload (eventing) in wt. we should make the reload
  button change colour?
- currency edit window in wt is too large, can't see bottom of screen.
- cannot edit account in wt.
- iso code field too small, numeric code field too small
- adding new account crashes wt. saving new currency crashes wt.

#+begin_src
[2026-Jan-07 12:16:08.080] 1050920 - [access] "wthttp: 127.0.0.1   POST /?wtd=kh0IzYWIDev5vqgQ HTTP/1.1 200 271"
[2026-Jan-07 12:16:08.080] 1050920 - [info] "WebRequest: took 0.969 ms"
#+end_src

#+begin_src logviewer
2026-01-07 12:16:15.578713 [TRACE] [ores.iam.repository.account_mapper] Mapping db entity: {"id":"019b9856-215c-7fd4-b139-11821e39d80a","version":1,"username":"newuser3","password_hash":"$scrypt$ln=14,r=8,p=1$wcZS3a7UEPEz8RBhIuOWIA==$vFYxagrQLQ1FXzMhP1u1D4xMJF2G4HMMsmoOxpRsdwYjSChBIsGiuA92cD8dPODlSYoG9uiX6SohLcUaZNUUUg==","password_salt":"","totp_secret":"","email":"newuser3@example.com","modified_by":"bootstrap","valid_from":"2026-01-07 12:02:20","valid_to":"9999-12-31 23:59:59"}
2026-01-07 12:16:15.578787 [TRACE] [ores.iam.repository.account_mapper] Mapped db entity. Result: {"version":1,"id":"019b9856-215c-7fd4-b139-11821e39d80a","recorded_by":"bootstrap","username":"newuser3","password_hash":"$scrypt$ln=14,r=8,p=1$wcZS3a7UEPEz8RBhIuOWIA==$vFYxagrQLQ1FXzMhP1u1D4xMJF2G4HMMsmoOxpRsdwYjSChBIsGiuA92cD8dPODlSYoG9uiX6SohLcUaZNUUUg==","password_salt":"","totp_secret":"","email":"newuser3@example.com","recorded_at":"2026-01-07 12:02:20.000000000Z"}
2026-01-07 12:16:15.578866 [DEBUG] [ores.iam.repository.account_mapper] Mapped db entities.
2026-01-07 12:16:15.578895 [DEBUG] [ores.iam.repository.login_info_repository] Reading all login_info.
2026-01-07 12:16:15.579395 [DEBUG] [ores.iam.repository.login_info_repository] Read all login_info. Total: 1
2026-01-07 12:16:15.579436 [DEBUG] [ores.iam.repository.login_info_mapper] Mapping db entities. Total: 1
2026-01-07 12:16:15.579465 [TRACE] [ores.iam.repository.login_info_mapper] Mapping db entity: {"account_id":"019b9856-215c-7fd4-b139-11821e39d80a","last_ip":"127.0.0.1","last_attempt_ip":"127.0.0.1","failed_logins":0,"locked":0,"last_login":"2026-01-07 12:14:01","online":1,"password_reset_required":0}
2026-01-07 12:16:15.579519 [TRACE] [ores.iam.repository.login_info_mapper] Mapped db entity. Result: {"last_login":"2026-01-07 12:14:01.000000000Z","account_id":"019b9856-215c-7fd4-b139-11821e39d80a","failed_logins":0,"locked":false,"online":true,"password_reset_required":false,"last_ip":"127.0.0.1","last_attempt_ip":"127.0.0.1"}
2026-01-07 12:16:15.579585 [DEBUG] [ores.iam.repository.login_info_mapper] Mapped db entities.
#+end_src

*** Disconnect shows reconnect message                                 :code:

When you click disconnect the status bar says "Reconnecting to server".

We can see but not edit. Also, test permissions to make sure they are being
enforced.

*** Add a dashboard for users                                          :code:

As per screenshots:

[[./user_dashboard_core_ui.png]]

[[./dashboard_ideas.png]]

[[./dashboard_ideas_II.png]]

Notes:

- add command to shell to list sessions.

*** Add sign-up approval workflow                                      :code:

Should also handle invite codes, etc.

We did most of the work except invite codes.

*** Listen for events in details dialog                                :code:

At present we are only listening for details in the main dialogs (accounts,
currencies). It would be nice to be able to listen to events in the details
dialogs. however, it needs to listen to events only for that specific entity
(e.g. currency pair, account etc). Not sure we are setup for this.

*** Implement entity history in shell                                  :code:

We need to add a command in shell to show entity history.

Notes:

- for the history diff we could use a simple unified diff format.

*** Consider adding an "entity waterfall"                              :code:

It would be nice to be able to see what entities have been added, deleted,
modified, etc. This would work as a running commentary.

*** Notification of deletes                                            :code:

At present it is easy to see new rows or modified rows in an entity dialog. It
is not possible to see deleted rows. One way to do this is to preserve state
from before reload by key. Any entities which are not present after reload can
be shown as red. History then allows users to re-instate deleted entities.

*** Add REPL to Qt                                                     :code:

Users should be able to interact with the system directly via the REPL. Add a
simple widget for this.

*** Add entity messages should not set modified by                     :code:

At present you can supply any modified by you want in the protocol messages. It
makes more sense to say the message must have the modified by as the user logged
in from the session.

*** Add heat map of user sessions                                      :code:

Things to measure:

- duration of sessions (once we have session table).
- bytes sent/received per session (possibly 3-D plot?). Also good for anomaly
  detection.
- mine github for ideas.

*** Add currencies update command to shell                             :code:

At present we can only add new currencies. We also need to be able to update.
Also, adding currencies requires supplying all parameters.

*** Subscribe on reconnect fails                                       :code:

Logs:

#+begin_src logview
2025-12-13 01:14:35.108648 [DEBUG] [ores.comms.messaging.frame] Successfully deserialized frame subscribe_request (0x10)
2025-12-13 01:14:35.108680 [DEBUG] [ores.comms.net.connection] Successfully deserialized frame, type: subscribe_request (0x10) total size: 60
2025-12-13 01:14:35.108708 [DEBUG] [ores.comms.net.server_session] Received message type subscribe_request (0x10)
2025-12-13 01:14:35.108750 [DEBUG] [ores.comms.messaging.message_dispatcher] Dispatching message type subscribe_request (0x10)
2025-12-13 01:14:35.108811 [WARN] [ores.comms.service.auth_session_service] Authorization failed for subscribe_request (0x10) from 127.0.0.1:45498: not authenticated
2025-12-13 01:14:35.108842 [WARN] [ores.comms.messaging.message_dispatcher] Authorization denied for subscribe_request (0x10) from 127.0.0.1:45498
2025-12-13 01:14:35.108875 [ERROR] [ores.comms.net.server_session] Message dispatch failed: 10
#+end_src

*** Unsubscribe before logout                                          :code:

On logout we see the following:

#+begin_src logview
2025-12-11 22:45:54.559906 [INFO] [ores.accounts.messaging.accounts_message_handler] Successfully logged out account: 019a5e49-476c-70ce-9909-3887cae700e9
2025-12-11 22:45:54.559940 [DEBUG] [ores.comms.messaging.message_dispatcher] Successfully dispatched message, response type logout_response (0x200e) correlation_id=763
2025-12-11 22:45:54.559978 [DEBUG] [ores.comms.messaging.frame] Serialised frame logout_response (0x200e), size: 58
2025-12-11 22:45:54.560005 [DEBUG] [ores.comms.net.connection] Writing frame of size 58 type: logout_response (0x200e) sequence: 767
2025-12-11 22:45:54.560083 [DEBUG] [ores.comms.net.connection] Successfully wrote frame
2025-12-11 22:45:54.560113 [DEBUG] [ores.comms.net.session] Sent response for message type logout_request (0x200d)
2025-12-11 22:45:54.560137 [INFO] [ores.comms.net.session] Logout completed, closing connection
2025-12-11 22:45:54.560200 [ERROR] [ores.comms.net.session] Exception in notification writer: co_await: Operation canceled [system:125]
2025-12-11 22:45:54.560233 [DEBUG] [ores.comms.net.session] Notification writer coroutine ended
2025-12-11 22:45:54.560281 [INFO] [ores.comms.net.session] Unregistering session '127.0.0.1:38366' from subscription manager
#+end_src

We should probably unsubscribe before we logout.

*** Use events in comms and accounts                                   :code:

Now we have an event bus, we should create events for:

- connect, disconnect, retry
- login, logout

*** Data in login info looks spurious                                  :code:

We see stuff like this:

#+begin_src
oresdb=> select * from login_info;
              account_id              |     last_ip     | last_attempt_ip | failed_logins | locked |       last_login       | online
--------------------------------------+-----------------+-----------------+---------------+--------+------------------------+--------
 019a4439-be9e-798e-bf2f-927ca236f84c | 0.0.0.0         | 0.0.0.0         |             0 |      0 | 1969-12-31 23:00:00+01 |      0
 019a3ba6-bd11-709b-b93d-fea9403d3d39 | 127.0.0.1       | 127.0.0.1       |             0 |      0 | 2025-10-31 19:03:48+00 |      1
 019a4431-98f8-79ae-9fc8-f6a6e77a0490 | 192.168.1.100   | 192.168.1.100   |             0 |      0 | 2025-11-02 10:51:32+00 |      1
 019a4431-9a7d-7b3d-a1cb-b9e02d44c804 | 0.0.0.0         | 192.168.1.100   |             1 |      0 | 1969-12-31 23:00:00+01 |      0

#+end_src

Also, we need a login timestamp and a logout timestamp so we can measure session
duration.

*** Currencies displays when not connected                             :code:

At present we can display currencies even before we connect. This is probably ok
but we should at least state we are not connected. Alternatively it should be
disabled.

*** Add a delete all button which deletes all currencies               :code:

It is useful especially in test environments to be able to delete all entities
before a re-import.

Notes:

- purge button.


*** Add screen in qt to exit bootstrap mode                            :code:

As per claude:

The create_initial_admin_request message type serves several important purposes
that differentiate it from the CLI and REPL approaches:

Why We Need create_initial_admin_request

  1. Network-accessible bootstrap flow
  - Allows remote initial setup from localhost without requiring shell/CLI access
  to the server
  - Enables a web-based "first-run" setup experience (like many web applications)
  - The Qt client can provide a proper UI for initial admin account creation

  2. Localhost-only security enforcement
  - The endpoint enforces that it can only be called from localhost (127.0.0.1 or
  ::1) at line
  projects/ores.accounts/src/messaging/accounts_message_handler.cpp:320
  - Provides network-accessible bootstrap with security guarantees
  - Prevents remote bootstrap attacks

  3. Atomic mode transition
  - The endpoint both creates the admin AND exits bootstrap mode in a single atomic
   operation (lines 362-367 in accounts_message_handler.cpp)
  - Guarantees consistency - can't create admin without exiting bootstrap mode

  4. Service-layer validation
  - Goes through full service layer with password validation and business logic
  - The CLI is essentially an "administrative backdoor" that bypasses the service
  layer and writes directly to the database

  5. Protocol-compliant workflow
  - Clients speaking the binary protocol need a proper bootstrap endpoint
  - REPL create_account_request is blocked in bootstrap mode (by enforcement logic)
  - create_initial_admin_request is the only endpoint that works in bootstrap mode

  The Distinction

  - CLI approach: Administrative backdoor, direct database access, bypasses all
  service logic
  - create_initial_admin_request: Proper network-accessible bootstrap flow with
  localhost restriction and atomic mode transition
  - REPL create_account_request: Normal account creation, blocked in bootstrap mode

  The create_initial_admin_request enables a proper "first-run experience" for
  clients connecting via the network protocol, while maintaining security through
  localhost-only access.

* Footer

| Previous: [[id:154212FF-BB02-8D84-1E33-9338B458380A][Version Zero]] |
