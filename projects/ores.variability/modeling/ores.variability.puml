' -*- mode: plantuml; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*'
'
' Copyright (C) 2025 Marco Craveiro <marco.craveiro@gmail.com>'
'
' This program is free software; you can redistribute it and/or modify it under
' the terms of the GNU General Public License as published by the Free Software
' Foundation; either version 3 of the License, or (at your option) any later
' version.
'
' This program is distributed in the hope that it will be useful, but WITHOUT
'  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
' FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
'
' You should have received a copy of the GNU General Public License along with
' GNU Emacs; see the file COPYING. If not, write to the Free Software
' Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
@startuml

title ores.variability Component

set namespaceSeparator ::

namespace ores #F2F2F2 {
    note "System variability and configuration management module for ORE Studio.\n\nThis module provides infrastructure for managing system configurability and\nruntime behavior variation. It serves as the foundation for all aspects of\nsystem adaptability." as ores_variability_note
    variability --- ores_variability_note
    namespace variability #F2F2F2 {
        namespace domain #F2F2F2 {
            '
            ' Layout groupings
            '

            ' Group: Feature flags
            together {
                class feature_flags
            }

            ' Group: System flags
            together {
                enum system_flag
                class system_flag_definition
                class system_flags
                class system_flags_cache
            }

            ' Stack system flag types vertically
            system_flag -[hidden]down- system_flag_definition
            system_flag_definition -[hidden]down- system_flags
            system_flags -[hidden]down- system_flags_cache

            '
            ' Class definitions
            '

            class feature_flags #F7E5FF {
                +{field} name std::string
                +{field} enabled bool
                +{field} description std::string
                +{field} modified_by std::string
            }

            note top of feature_flags
            Represents a feature flag in the domain layer.

            Fields:

            - name: Name of the feature flag, serves as the unique identifier.
            - enabled: Flag indicating whether the feature is enabled or disabled.
            - description: Description of what the feature flag controls.
            - modified_by: Username of the user who last modified this feature flag.
            end note

            enum system_flag <<enum>> #F7E5FF {
                bootstrap_mode
                user_signups
            }

            note top of system_flag
            Enumeration of well-known system flags.

            System flags are compile-time known feature flags that control
            core system behavior. Flag names use "system." prefix followed
            by enum name (e.g., system.bootstrap_mode).

            Values:

            - bootstrap_mode: System waiting for initial admin (default: enabled)
            - user_signups: User self-registration allowed (default: disabled)
            end note

            class system_flag_definition #F7E5FF {
                +{field} flag system_flag
                +{field} default_enabled bool
                +{field} description std::string_view
            }

            note top of system_flag_definition
            Metadata for a system flag including default state and description.
            end note

            system_flag_definition o-- system_flag

            class system_flags <<utility>> #F7E5FF {
                +{static} system_flag_definitions std::array<system_flag_definition>
                +{static} to_flag_name(system_flag) std::string
                +{static} from_flag_name(std::string_view) std::optional<system_flag>
                +{static} get_definition(system_flag) system_flag_definition
            }

            note top of system_flags
            Utility functions for system flag conversion and lookup.

            - system_flag_definitions: Compile-time manifest of all system flags
            - to_flag_name: Converts enum to database name (e.g., "system.bootstrap_mode")
            - from_flag_name: Parses database name to enum
            - get_definition: Gets flag metadata including defaults
            end note

            system_flags ..> system_flag : uses
            system_flags ..> system_flag_definition : uses

            class system_flags_cache <<pod>> #F7E5FF {
                +{field} bootstrap_mode bool
                +{field} user_signups bool
            }

            note top of system_flags_cache
            POD struct for caching system flag values.

            Stores the current state of all system flags for
            fast, lockless access without database queries.
            Updated via system_flags_service::refresh().

            Default values match system_flag_definitions:
            - bootstrap_mode: true (enabled)
            - user_signups: false (disabled)
            end note
        }

        namespace repository #F2F2F2 {
            '
            ' Layout groupings
            '

            together {
                class feature_flags_entity
                class feature_flags_mapper
                class feature_flags_repository
            }

            feature_flags_entity -[hidden]down- feature_flags_mapper
            feature_flags_mapper -[hidden]down- feature_flags_repository

            '
            ' Class definitions
            '

            class feature_flags_entity <<orm>> #99CB99 {
                +{field} name sqlgen::PrimaryKey<std::string>
                +{field} enabled int
                +{field} description std::string
                +{field} modified_by std::string
                +{field} valid_from sqlgen::Timestamp<"%Y-%m-%d %H:%M:%S">
                +{field} valid_to sqlgen::Timestamp<"%Y-%m-%d %H:%M:%S">
            }

            note top of feature_flags_entity
            Represents a feature flag in the database.

            ORM Settings:

            - Schema: oresdb
            - Table: feature_flags

            Fields:

            - name: Primary key and feature flag name.
            - enabled: Enabled flag.
            - description: Feature description.
            - modified_by: Username who modified.
            - valid_from: Temporal validity start.
            - valid_to: Temporal validity end.
            end note

            class feature_flags_mapper <<orm>> #99CB99 {
                +{static} map(feature_flags_entity) domain::feature_flags
                +{static} map(domain::feature_flags) feature_flags_entity
                +{static} map(std::vector<feature_flags_entity>) std::vector<domain::feature_flags>
                +{static} map(std::vector<domain::feature_flags>) std::vector<feature_flags_entity>
            }

            note top of feature_flags_mapper
            Maps feature flags domain model entities to data storage layer and vice-versa.
            end note

            feature_flags_mapper ..> ores::variability::domain::feature_flags : uses
            feature_flags_mapper ..> ores::variability::repository::feature_flags_entity : uses

            class feature_flags_repository <<orm>> #99CB99 {
                +feature_flags_repository(context)
                +sql() std::string
                +write(domain::feature_flags) void
                +write(std::vector<domain::feature_flags>) void
                +read_latest() std::vector<domain::feature_flags>
                +read_latest(std::string) std::vector<domain::feature_flags>
                +read_all() std::vector<domain::feature_flags>
                +read_all(std::string) std::vector<domain::feature_flags>
                +remove(std::string) void
                -{field} ctx_ context
            }

            note top of feature_flags_repository
            Reads and writes feature flags from data storage.

            Provides methods to:
            - Write feature flags to database
            - Read latest feature flags (current values)
            - Read all feature flags (full history)
            - Remove feature flags (closes temporal validity)

            Uses bitemporal versioning to track changes over time.
            end note

            feature_flags_repository ..> ores::variability::domain::feature_flags : uses
        }

        namespace service #F2F2F2 {
            '
            ' Layout groupings
            '

            together {
                class feature_flags_service
                class system_flags_service
                class flag_initializer
            }

            feature_flags_service -[hidden]down- system_flags_service
            system_flags_service -[hidden]down- flag_initializer

            '
            ' Class definitions
            '

            class feature_flags_service #ECECEC {
                +feature_flags_service(context)
                +get_feature_flag(std::string) std::optional<domain::feature_flags>
                +get_all_feature_flags() std::vector<domain::feature_flags>
                +save_feature_flag(domain::feature_flags) void
                +delete_feature_flag(std::string) void
                -{field} repo_ repository::feature_flags_repository
            }

            note top of feature_flags_service
            Service for managing feature flags.

            Provides high-level operations for retrieving and modifying feature flags.
            Encapsulates the underlying repository and handles the bitemporal update logic.
            end note

            feature_flags_service o-- ores::variability::repository::feature_flags_repository
            feature_flags_service ..> ores::variability::domain::feature_flags : uses

            class system_flags_service #ECECEC {
                +system_flags_service(context)
                +refresh() void
                +cache() const domain::system_flags_cache&
                +is_enabled(domain::system_flag) bool
                +set_enabled(domain::system_flag, bool, std::string_view) void
                +is_bootstrap_mode_enabled() bool
                +set_bootstrap_mode(bool, std::string_view) void
                +is_user_signups_enabled() bool
                +set_user_signups(bool, std::string_view) void
                -update_cache(domain::system_flag, bool) void
                -{field} feature_flags_service_ feature_flags_service
                -{field} cache_ domain::system_flags_cache
            }

            note top of system_flags_service
            Service for accessing well-known system flags with type-safe methods.

            Provides typed interface for querying and modifying system flags.
            Maintains an in-memory cache for fast access. Cache must be
            refreshed explicitly via refresh() after external changes.

            Methods:

            - refresh(): Reload all flags from database into cache
            - cache(): Get const reference to cached flag values
            - is_enabled/set_enabled: Generic flag access by enum
            - Convenience methods: is_bootstrap_mode_enabled, set_bootstrap_mode, etc.

            Cache is updated on set operations and must be shared via
            std::shared_ptr for multi-component access.
            end note

            system_flags_service o-- feature_flags_service
            system_flags_service o-- ores::variability::domain::system_flags_cache
            system_flags_service ..> ores::variability::domain::system_flag : uses

            class flag_initializer #ECECEC {
                +flag_initializer(context)
                +ensure_system_flags_exist() std::size_t
                -{field} feature_flags_service_ feature_flags_service
            }

            note top of flag_initializer
            Initializes system flags in the database at startup.

            Ensures all well-known system flags exist with default values.
            Called early during service startup, before any component queries
            system flags. Only creates missing flags - does not overwrite
            existing values.

            Returns the number of flags created (0 if all existed).
            end note

            flag_initializer o-- feature_flags_service
            flag_initializer ..> ores::variability::domain::system_flag_definition : uses
        }

        namespace messaging #F2F2F2 {
            '
            ' Layout groupings
            '

            ' Group: Request/response pair
            together {
                class list_feature_flags_request
                class list_feature_flags_response
            }

            ' Group: Handler infrastructure
            together {
                class variability_message_handler
                class registrar
            }

            ' Stack vertically
            list_feature_flags_request -[hidden]down- list_feature_flags_response
            list_feature_flags_response -[hidden]down- variability_message_handler
            variability_message_handler -[hidden]down- registrar

            '
            ' Class definitions
            '

            class list_feature_flags_request <<message>> #E1F5FF {
                +serialize() std::vector<std::byte>
                +{static} deserialize(std::span<const std::byte>) std::expected<list_feature_flags_request, comms::messaging::error_code>
            }

            note top of list_feature_flags_request
            Request to retrieve all feature flags.

            This request has no parameters - it retrieves all feature flags in the system.
            end note

            class list_feature_flags_response <<message>> #E1F5FF {
                +{field} feature_flags std::vector<domain::feature_flags>
                +serialize() std::vector<std::byte>
                +{static} deserialize(std::span<const std::byte>) std::expected<list_feature_flags_response, comms::messaging::error_code>
            }

            note top of list_feature_flags_response
            Response containing all feature flags.

            Fields:

            - feature_flags: Vector of all feature flags with current values.
            end note

            list_feature_flags_response o-- ores::variability::domain::feature_flags

            class variability_message_handler #ECECEC {
                +variability_message_handler(utility::repository::context)
                +handle_message(comms::messaging::message_type, std::span<const std::byte>, std::string) boost::asio::awaitable<std::expected<std::vector<std::byte>, comms::messaging::error_code>>
                -handle_list_feature_flags_request(std::span<const std::byte>) boost::asio::awaitable<std::expected<std::vector<std::byte>, comms::messaging::error_code>>
                -{field} feature_flags_repo_ repository::feature_flags_repository
            }

            note top of variability_message_handler
            Message handler for variability subsystem messages.

            Processes messages in the variability subsystem range (0x3000-0x3FFF).
            Currently handles:
            - list_feature_flags_request: Retrieves all feature flags from the repository
            end note

            variability_message_handler o-- ores::variability::repository::feature_flags_repository
            variability_message_handler ..> ores::variability::messaging::list_feature_flags_request : uses
            variability_message_handler ..> ores::variability::messaging::list_feature_flags_response : uses

            class registrar #ECECEC {
                +{static} register_handlers(comms::net::server&, utility::repository::context) void
            }

            note top of registrar
            Register variability subsystem message handlers with the server.

            Registers handlers for all variability subsystem messages (0x3000-0x3FFF).
            Must be called before server.run().
            end note

            registrar ..> ores::variability::messaging::variability_message_handler : creates
        }

        namespace tests #F2F2F2 {
            '
            ' Layout groupings
            '

            ' Group: Domain tests
            together {
                class domain_feature_flags_tests
                class domain_system_flags_tests
            }

            ' Group: Service tests
            together {
                class service_system_flags_service_tests
                class service_flag_initializer_tests
            }

            ' Stack vertically
            domain_feature_flags_tests -[hidden]down- domain_system_flags_tests
            service_system_flags_service_tests -[hidden]down- service_flag_initializer_tests

            '
            ' Class definitions
            '

            class domain_feature_flags_tests <<test suite>> #C5E1A5 {
                +create_feature_flag_with_valid_fields() void
                +create_disabled_feature_flag() void
                +feature_flag_serialization_to_json() void
                +create_feature_flag_with_faker() void
                +create_multiple_random_feature_flags() void
                +create_system_feature_flags() void
                +feature_flags_convert_single_to_table() void
                +feature_flags_convert_multiple_to_table() void
                +feature_flags_table_with_faker_data() void
            }

            note top of domain_feature_flags_tests
            Test suite for feature_flags domain model.

            Tests cover:
            - Feature flag creation with valid/invalid data
            - Enabled and disabled feature flags
            - JSON serialization
            - Faker-generated test data
            - Table conversion and formatting
            - Multiple feature flags handling
            end note

            domain_feature_flags_tests ..> ores::variability::domain::feature_flags : tests

            class domain_system_flags_tests <<test suite>> #C5E1A5 {
                +to_flag_name_converts_bootstrap_mode() void
                +to_flag_name_converts_user_signups() void
                +from_flag_name_parses_valid_flags() void
                +from_flag_name_returns_nullopt_for_invalid() void
                +roundtrip_conversion_for_all_system_flags() void
                +get_definition_returns_correct_defaults() void
                +system_flag_definitions_contains_all_enum_values() void
            }

            note top of domain_system_flags_tests
            Test suite for system_flag domain types.

            Tests cover:
            - Flag name conversion (to_flag_name, from_flag_name)
            - Roundtrip conversion for all enum values
            - Default value verification
            - Manifest completeness
            end note

            domain_system_flags_tests ..> ores::variability::domain::system_flag : tests
            domain_system_flags_tests ..> ores::variability::domain::system_flags : tests

            class service_system_flags_service_tests <<test suite>> #C5E1A5 {
                +default_values_when_flag_not_in_database() void
                +set_and_get_operations() void
                +update_existing_flags() void
                +multiple_flags_independent() void
            }

            note top of service_system_flags_service_tests
            Test suite for system_flags_service.

            Tests cover:
            - Default value behavior when flags don't exist
            - Set and get operations
            - Update/toggle operations
            - Independence between flags
            end note

            service_system_flags_service_tests ..> ores::variability::service::system_flags_service : tests

            class service_flag_initializer_tests <<test suite>> #C5E1A5 {
                +creates_all_system_flags() void
                +preserves_existing_flags() void
                +idempotent_initialization() void
            }

            note top of service_flag_initializer_tests
            Test suite for flag_initializer.

            Tests cover:
            - Creates all flags when database is empty
            - Preserves existing flag values
            - Idempotent behavior (multiple runs safe)
            end note

            service_flag_initializer_tests ..> ores::variability::service::flag_initializer : tests
        }
    }
}

' Local Variables:
' compile-command: "java -Djava.awt.headless=true -DPLANTUML_SECURITY_PROFILE=UNSECURE -DPLANTUML_LIMIT_SIZE=65535 -jar /usr/share/plantuml/plantuml.jar ores.variability.puml"
' End:
@enduml
