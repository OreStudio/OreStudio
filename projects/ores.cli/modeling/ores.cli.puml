' -*- mode: plantuml; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-
'
' Copyright (C) 2025 Marco Craveiro <marco.craveiro@gmail.com>
'
' This program is free software; you can redistribute it and/or modify it under
' the terms of the GNU General Public License as published by the Free Software
' Foundation; either version 3 of the License, or (at your option) any later
' version.
'
' This program is distributed in the hope that it will be useful, but WITHOUT
'  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
' FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
'
' You should have received a copy of the GNU General Public License along with
' GNU Emacs; see the file COPYING. If not, write to the Free Software
' Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
@startuml
set namespaceSeparator ::

namespace ores #F2F2F2 {
    note "Console tool for ORE Studio." as ores_cli_note
    cli --- ores_cli_note
    namespace cli #F2F2F2 {
        note "Configuration related classes and structures." as ores_cli_config_note
        config --- ores_cli_config_note
        namespace config #F2F2F2 {
            class entity <<enumeration>> #FFFACD {
                currencies
            }

            note top of entity
            List of available entities to target.
            end note

            class format <<enumeration>> #FFFACD {
                json
                xml
                csv
            }

            note top of format
            List of available formats.
            end note

            class import_options #F7E5FF {
                +{field} target_entity entity
                +{field} targets std::vector<std::filesystem::path>
            }

            note top of import_options
            Configuration related to importing data into the system.

            Fields:

            - target_entity: Which entity to target.
            - targets: Target files containing import data. Format is inferred from extension.
            end note

            import_options o-- ores::cli::config::entity

            class export_options #F7E5FF {
                +{field} target_entity entity
                +{field} as_of std::string
                +{field} key std::string
                +{field} all_versions bool
                +{field} target_format format
            }

            note top of export_options
            Configuration related to exporting data into a supported export format.

            Fields:

            - target_entity: Which entity to export.
            - as_of: Timepoint to use for the reading. If empty, use latest.
            - key: Key to filter by, if any.
            - all_versions: If true, output all versions of this entity.
            - target_format: Format to use for the export.
            end note

            export_options o-- ores::cli::config::entity
            export_options o-- ores::cli::config::format

            class options #F7E5FF {
                +{field} logging std::optional<ores::utility::log::logging_options>
                +{field} importing std::optional<import_options>
                +{field} exporting std::optional<export_options>
                +{field} database ores::utility::database::database_options
            }

            note top of options
            All of the configuration options required by the command line application.

            Fields:

            - logging: Configuration options related to logging, if any.
            - importing: Configuration related to importing of data, if any.
            - exporting: Configuration related to exporting of data, if any.
            - database: Database connection configuration.
            end note

            options o-- ores::cli::config::import_options
            options o-- ores::cli::config::export_options

            class parser #FFFACD {
                +parse(arguments: const std::vector<std::string>&, info: std::ostream&, error: std::ostream&) const: std::optional<options>
            }

            note top of parser
            Command-line parser implementation using boost program options.

            Note on logging: we are NOT logging any of the exceptions to the log in this
            class. This is by design. The logger is only initialised after the options
            have been parsed; were we to log prior to this, we would dump all the
            messages into the cli. The output is very confusing users that are accustomed
            to normal cli applications.
            end note

            parser ..> ores::cli::config::options : returns

            class parser_exception #FFFACD {
                +parser_exception(message: std::string_view)
                +what() const noexcept: const char*
                -{field} message_ std::string
            }

            note top of parser_exception
            A fatal error has occurred during option parsing.
            end note
        }

        note "Application hosting and execution classes." as ores_cli_app_note
        app --- ores_cli_app_note
        namespace app #F2F2F2 {
            class application #FFFACD {
                +application(output_stream: std::ostream&, db_opts: const std::optional<utility::database::database_options>&)
                +run(cfg: const config::options&) const: void
                -{static} lg(): auto&
                -{static} make_context(db_opts: const std::optional<utility::database::database_options>&): utility::repository::context
                -import_currencies(files: const std::vector<std::filesystem::path>) const: void
                -import_data(ocfg: const std::optional<config::import_options>&) const: void
                -export_currencies(cfg: const config::export_options&) const: void
                -export_data(ocfg: const std::optional<config::export_options>&) const: void
                -{field} context_ utility::repository::context
                -{field} output_stream_ std::ostream&
            }

            note top of application
            Entry point for the ores command line application.
            end note

            application ..> ores::cli::config::options : uses

            class host #FFFACD {
                +{static} execute(args: const std::vector<std::string>&, std_output: std::ostream&, error_output: std::ostream&): int
                -{static} lg(): auto&
            }

            note top of host
            Provides hosting services to the application.
            end note

            host ..> ores::cli::app::application : creates

            class application_exception #FFFACD {
                +application_exception(message: std::string_view)
                +what() const noexcept: const char*
                -{field} message_ std::string
            }

            note top of application_exception
            A fatal error has occurred whilst the application was running.
            end note
        }
    }
}

' Local Variables:
' compile-command: "java -Djava.awt.headless=true -DPLANTUML_SECURITY_PROFILE=UNSECURE -DPLANTUML_LIMIT_SIZE=65535 -jar /usr/share/plantuml/plantuml.jar ores.cli.puml"
' End:
@enduml
