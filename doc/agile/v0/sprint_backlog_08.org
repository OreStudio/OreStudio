:PROPERTIES:
:ID: A9FB22A0-E067-46D4-A217-AF10C20DFB90
:END:
#+title: Sprint Backlog 08
#+options: <:nil c:nil ^:nil d:nil date:nil author:nil toc:nil html-postamble:nil
#+todo: STARTED | COMPLETED CANCELLED POSTPONED BLOCKED
#+tags: { code(c) infra(i) analysis(n) agile(a) }
#+startup: inlineimages

* Sprint Mission

- implement reference data.

* Stories

** Active

#+begin: clocktable :maxlevel 3 :scope subtree :tags t :indent nil :emphasize nil :scope file :narrow 75 :formula % :block today
#+TBLNAME: today_summary
#+CAPTION: Clock summary at [2026-01-02 Fri 02:15], for Friday, January 02, 2026.
|       | <75>                                        |        |      |      |       |
| Tags  | Headline                                    | Time   |      |      |     % |
|-------+---------------------------------------------+--------+------+------+-------|
|       | *Total time*                                | *2:12* |      |      | 100.0 |
|-------+---------------------------------------------+--------+------+------+-------|
|       | Stories                                     | 2:12   |      |      | 100.0 |
|       | Active                                      |        | 2:12 |      | 100.0 |
| agile | Sprint and product backlog refinement       |        |      | 0:12 |   9.1 |
| code  | Run qt client and validate all new features |        |      | 1:19 |  59.8 |
| code  | Refactor options and parser                 |        |      | 0:27 |  20.5 |
| code  | Check functionality in =ores.wt=            |        |      | 0:14 |  10.6 |
#+end:

#+begin: clocktable :maxlevel 3 :scope subtree :tags t :indent nil :emphasize nil :scope file :narrow 75 :formula %
#+TBLNAME: sprint_summary
#+CAPTION: Clock summary at [2026-01-02 Fri 02:15]
|       | <75>                                        |         |       |      |       |
| Tags  | Headline                                    | Time    |       |      |     % |
|-------+---------------------------------------------+---------+-------+------+-------|
|       | *Total time*                                | *11:09* |       |      | 100.0 |
|-------+---------------------------------------------+---------+-------+------+-------|
|       | Stories                                     | 11:09   |       |      | 100.0 |
|       | Active                                      |         | 11:09 |      | 100.0 |
| agile | Sprint and product backlog refinement       |         |       | 1:17 |  11.5 |
| code  | Rerun SQL scripts from scratch              |         |       | 7:52 |  70.6 |
| code  | Run qt client and validate all new features |         |       | 1:19 |  11.8 |
| code  | Refactor options and parser                 |         |       | 0:27 |   4.0 |
| code  | Check functionality in =ores.wt=            |         |       | 0:14 |   2.1 |
#+end:

*** STARTED Sprint and product backlog refinement                     :agile:
    :LOGBOOK:
    CLOCK: [2026-01-02 Fri 01:20]--[2026-01-02 Fri 01:32] =>  0:12
    CLOCK: [2025-12-31 Wed 10:21]--[2025-12-31 Wed 11:26] =>  1:05
    :END:

Updates to sprint and product backlog.

#+begin_src emacs-lisp :exports none
;; agenda
(org-agenda-file-to-front)
#+end_src

#+name: pie-stories-chart
#+begin_src R :var sprint_summary=sprint_summary :results file graphics :exports results :file sprint_backlog_08_stories_pie_sorted.png :width 1920 :height 1080
library(conflicted)
library(ggplot2)
library(tidyverse)
library(tibble)

# Filter to only rows with actual story data (non-empty Tags column)
clean_sprint_summary <- sprint_summary %>% dplyr::filter(Tags != "")
stories <- unlist(clean_sprint_summary[2])
percent_values <- as.numeric(unlist(clean_sprint_summary[6]))

# Create a data frame and explicitly sort the stories by defining factor levels
df <- data.frame(
  stories = stories,
  percent = percent_values
) %>%
  # 1. Sort the data frame by percentage in descending order
  arrange(desc(percent)) %>%
  # 2. Convert 'stories' to a factor, setting the levels based on the sorted order.
  # This makes the order of the slices explicit for ggplot.
  mutate(
    stories = factor(stories, levels = stories),
    lab.pos = cumsum(percent) - 0.5 * percent
  )

# Manually selected colors to resemble the screenshot
custom_palette <- c(
  "#21518f", "#f37735", "#ffc425", "#81b214", "#d7385e",
  "#662e91", "#00a9ae", "#5c5c5c", "#a0c6e0", "#f8b195",
  "#ffe385", "#bde0fe", "#c5e0d4", "#e0b8a0", "#a56f8f",
  "#7a448a", "#4a9a9b", "#9b9b9b", "#6fa8dc", "#f7a072",
  "#ffd166", "#99d98c", "#ef5d60", "#9d529f", "#3a86ff",
  "#c1d6e1", "#f9e0ac", "#c2d6a4", "#e69a8d", "#a07d9f"
)

# Ensure the palette has enough colors for all stories.
if (length(custom_palette) < length(df$stories)) {
  warning("Not enough custom colors for all stories. Colors will repeat.")
  custom_palette <- rep(custom_palette, length.out = length(df$stories))
}


p <- ggplot(df, aes(x = "", y = percent, fill = stories)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start = 0) +
  scale_fill_manual(values = custom_palette) +
  ggtitle("Sprint 8: Resourcing per Story")  +
  labs(x = NULL, y = NULL, fill = "Stories") +
  theme_minimal() +
  theme(
    axis.text.x = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 18),
    legend.position = "right",
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  )

print(p)
#+end_src

#+RESULTS: pie-stories-chart
[[file:sprint_backlog_08_stories_pie_sorted.png]]

#+name: stories-chart
#+begin_src R :var sprint_summary=sprint_summary :results file graphics :exports results :file sprint_backlog_08_stories.png :width 1200 :height 650
library(conflicted)
library(grid)
library(tidyverse)
library(tibble)

# Filter to only rows with actual story data (non-empty Tags column)
clean_sprint_summary <- sprint_summary %>% dplyr::filter(Tags != "")
names <- unlist(clean_sprint_summary[2])
values <- as.numeric(unlist(clean_sprint_summary[6]))

# Create a data frame.
df <- data.frame(
  cost = values,
  stories = factor(names, levels = names[order(values, decreasing = FALSE)]),
  y = seq(length(names)) * 0.9
)

# Setup the colors
blue <- "#076fa2"

p <- ggplot(df) +
  aes(x = cost, y = stories) +
  geom_col(fill = blue, width = 0.6) +
  ggtitle("Sprint 8: Resourcing per Story") +
  xlab("Resourcing (%)") + ylab("Stories") +
  theme(text = element_text(size = 15))

print(p)
#+end_src

#+RESULTS: stories-chart
[[file:sprint_backlog_08_stories.png]]

#+name: tags-chart
#+begin_src R :var sprint_summary=sprint_summary :results file graphics :exports results :file sprint_backlog_08_tags.png :width 600 :height 400
library(conflicted)
library(grid)
library(tidyverse)
library(tibble)

# Filter to only rows with actual story data (non-empty Tags column)
clean_sprint_summary <- sprint_summary %>% dplyr::filter(Tags != "")
names <- unlist(clean_sprint_summary[1])
values <- as.numeric(unlist(clean_sprint_summary[6]))

# Create a data frame.
df <- data.frame(
  cost = values,
  tags = names,
  y = seq(length(names)) * 0.9
)
# factor(names, levels = names[order(values, decreasing = FALSE)])

df2 <- setNames(aggregate(df$cost, by = list(df$tags), FUN = sum),  c("cost", "tags"))
# Setup the colors
blue <- "#076fa2"

p <- ggplot(df2) +
  aes(x = cost, y = tags) +
  geom_col(fill = blue, width = 0.6) +
  ggtitle("Sprint 8: Resourcing per Tag") +
  xlab("Resourcing (%)") + ylab("Story types") +
  theme(text = element_text(size = 15))

print(p)
#+end_src

#+RESULTS: tags-chart
[[file:sprint_backlog_08_tags.png]]

*** OCR scan notebooks for this sprint                                :infra:

We need to scan all of our finance notebooks so we can use them with AI. Each
sprint will have a story similar to this until we scan and process them all.

*** Add AI generated sprint summary                                   :infra:

At the end of the sprint, generate the sprint summary using the prompt.

*** Sprint Demo                                                       :infra:

Time spent doing the demo. This is the first one so it will be very basic.

**** Presentation

***** ORE Studio v0.0.4, "Fazenda Camilunga"

    Marco Craveiro
    Moimba Software Engineering
    Released on 16th November 2025



*** COMPLETED Rerun SQL scripts from scratch                           :code:
    :LOGBOOK:
    CLOCK: [2026-01-01 Thu 22:30]--[2026-01-01 Thu 23:59] =>  1:29
    CLOCK: [2026-01-01 Thu 20:15]--[2026-01-01 Thu 21:10] =>  0:55
    CLOCK: [2026-01-01 Thu 19:08]--[2026-01-01 Thu 19:35] =>  0:27
    CLOCK: [2026-01-01 Thu 17:29]--[2026-01-01 Thu 19:05] =>  1:36
    CLOCK: [2026-01-01 Thu 16:30]--[2026-01-01 Thu 17:28] =>  0:58
    CLOCK: [2025-12-31 Wed 11:27]--[2025-12-31 Wed 13:54] =>  2:27
    :END:

We need to validate the scripts and fix all issues we find.

#+begin_quote
This pull request significantly refines the integration of TimescaleDB within
the ORES SQL schema, making it more adaptable to different TimescaleDB license
tiers and ensuring robust functionality. It introduces runtime license detection
to intelligently enable or disable advanced TimescaleDB features, alongside
implementing per-database extension installation for PostgreSQL. Furthermore,
this PR substantially expands the project's documentation by adding detailed
architectural overviews for the ores.assets and ores.comms.analyser components,
and a comprehensive guide to the overall SQL schema, enhancing clarity and
maintainability for developers and users alike.

Highlights:

- Enhanced TimescaleDB Integration: The system now correctly integrates with
  both Apache and Timescale license editions of TimescaleDB, dynamically
  adjusting features based on the detected license.
- Per-Database Extension Installation: PostgreSQL extensions are now installed
  on a per-database basis, ensuring proper functionality within each ORES
  database instance, including the template.
- Runtime License Detection: SQL scripts now include runtime checks for the
  TimescaleDB license, gracefully skipping advanced features like compression,
  retention policies, and continuous aggregates if only the Apache license is
  present.
- New Component Documentation: Detailed Org-mode documentation has been added
  for the ores.assets and ores.comms.analyser components, outlining their
  architecture, domain types, and usage.
- Comprehensive SQL Schema Documentation: The ores.sql.org file has been added,
  providing extensive documentation on the ORES SQL schema, including
  architecture, design patterns, PostgreSQL extensions (especially TimescaleDB),
  and database creation processes. Schema Prefix for TimescaleDB Functions:
  TimescaleDB function calls in sessions_create.sql and session_stats_create.sql
  now explicitly use the public. schema prefix to avoid issues when search_path
  is set to 'ores'.
#+end_quote

*** COMPLETED =ores.qt= is not using client session                    :code:

*Rationale*: implemented in previous sprint.

Refactor client manager to use it.

*** COMPLETED Remove seeders in code                                   :code:

Since we have to seed from SQL scripts, having code seeding as well is just
confusing.

#+begin_quote
This pull request fundamentally shifts the database seeding mechanism from C++
application code to SQL population scripts. This change centralizes the initial
setup of permissions, roles, and system flags directly within the database
template, simplifying application startup logic and ensuring consistent data
across new instances. Consequently, the test suites have been refactored to
accommodate this pre-seeded state, improving test reliability and reflecting the
new database initialization flow.

Highlights:

- Migration to SQL for Database Seeding: The C++ rbac_seeder and
  system_flags_seeder have been replaced with dedicated SQL population scripts
  for permissions, roles, and system flags, centralizing initial data setup
  within the database template.
- Directory Renaming for Clarity: The sql/data/ directory, containing various
  population scripts and assets, has been renamed to sql/populate/ to better
  reflect its purpose.
- Test Suite Adaptation: Numerous test cases across ores.iam, ores.risk, and
  ores.variability have been updated to correctly handle pre-seeded database
  data, moving away from assumptions of empty databases and instead accounting
  for existing entries.
- Streamlined Instance Initialization: The init_instance.sql script has been
  simplified, removing direct seeding calls as the population is now handled
  during the database template creation process.
- Documentation Refinements: A modeling link in
  projects/modeling/system_model.org was corrected, and
  doc/recipes/sql_recipes.org was updated with new SQL commands and output
  examples.
#+end_quote

*** COMPLETED Run qt client and validate all new features              :code:
    :LOGBOOK:
    CLOCK: [2026-01-02 Fri 00:44]--[2026-01-02 Fri 01:20] =>  0:36
    CLOCK: [2026-01-02 Fri 00:00]--[2026-01-02 Fri 00:43] =>  0:43
    :END:

We added quite a few new features during the holidays but due to the laptop
constraints we could not validate them properly. Check they all work correctly
and fix what needs fixing. Features:

- session monitoring. Looks good for tracking, cannot view in app.
- flags display. Looks good.
- Roles and permissions: cannot edit, display should use a table.

*** STARTED Refactor options and parser                                :code:
    :LOGBOOK:
    CLOCK: [2026-01-02 Fri 01:33]--[2026-01-02 Fri 02:00] =>  0:27
    :END:

We have a lot of boost program options parsers and options. We need to do an
inventory of all of the implementations and figure out if we can have common
code under utility.

*** STARTED Check functionality in =ores.wt=                           :code:
    :LOGBOOK:
    CLOCK: [2026-01-02 Fri 02:01]--[2026-01-02 Fri 02:15] =>  0:14
    :END:

We created the application but did not validate it.

*** Rename =ores.shell= to =ores.comms.shell=                          :code:

The shell is specific to the binary protocol.

*** Allow editing of permissions in ores.qt                            :code:

We can see but not edit. Also, test permissions to make sure they are being
enforced.

*** Add a dashboard for users                                          :code:

As per screenshots:

[[./user_dashboard_core_ui.png]]

[[./dashboard_ideas.png]]

[[./dashboard_ideas_II.png]]

Notes:

- add command to shell to list sessions.

*** Add sign-up approval workflow                                      :code:

Should also handle invite codes, etc.

We did most of the work except invite codes.

*** Listen for events in details dialog                                :code:

At present we are only listening for details in the main dialogs (accounts,
currencies). It would be nice to be able to listen to events in the details
dialogs. however, it needs to listen to events only for that specific entity
(e.g. currency pair, account etc). Not sure we are setup for this.

*** Assorted fixes to currency dialog                                  :code:

At present the following is not working or is a snag:

- can we make the details windows unmaximisable.
- We need to either make the columns configurable, or remove some less useful
  columns such as symbol, fraction etc. These are still visible in details.
- can we refactor reload logic into common entity code?
- wrong icon in revert for currency history. no option to reload history
- when creating a new currency we cannot attach a flag to it.

*** Assorted fixes to accounts dialog                                  :code:

- last login field does not fit the screen.
- cannot reload account in account details. Need reload button.
- remove "grant administrative privileges" from details screen.
- old users remain online. Server should check sessions on start and update
  table.
- cannot tell who unlocked an account and when.
- do not use "old" for accounts who never logged in. Maybe "unused"?
- at present you can't tell if you asked for a password reset. We probably
  should use Status to mean: locked, unlocked, reset. And maybe "Age" or "Last
  Login" to mean: online, never, recent, old.
- add right-click menu with the context options from the toolbar.
- after reload, lock etc remember which line we were on and return to it.
- email updated message is truncated.
- user cannot lock it's own account.

*** Implement entity history in shell                                  :code:

We need to add a command in shell to show entity history.

Notes:

- for the history diff we could use a simple unified diff format.

*** Consider adding an "entity waterfall"                              :code:

It would be nice to be able to see what entities have been added, deleted,
modified, etc. This would work as a running commentary.

*** Notification of deletes                                            :code:

At present it is easy to see new rows or modified rows in an entity dialog. It
is not possible to see deleted rows. One way to do this is to preserve state
from before reload by key. Any entities which are not present after reload can
be shown as red. History then allows users to re-instate deleted entities.

*** Add REPL to Qt                                                     :code:

Users should be able to interact with the system directly via the REPL. Add a
simple widget for this.

*** Add entity messages should not set modified by                     :code:

At present you can supply any modified by you want in the protocol messages. It
makes more sense to say the message must have the modified by as the user logged
in from the session.

*** Add heat map of user sessions                                      :code:

Things to measure:

- duration of sessions (once we have session table).
- bytes sent/received per session (possibly 3-D plot?). Also good for anomaly
  detection.
- mine github for ideas.

*** Add currencies update command to shell                             :code:

At present we can only add new currencies. We also need to be able to update.
Also, adding currencies requires supplying all parameters.

*** Subscribe on reconnect fails                                       :code:

Logs:

#+begin_src logview
2025-12-13 01:14:35.108648 [DEBUG] [ores.comms.messaging.frame] Successfully deserialized frame subscribe_request (0x10)
2025-12-13 01:14:35.108680 [DEBUG] [ores.comms.net.connection] Successfully deserialized frame, type: subscribe_request (0x10) total size: 60
2025-12-13 01:14:35.108708 [DEBUG] [ores.comms.net.server_session] Received message type subscribe_request (0x10)
2025-12-13 01:14:35.108750 [DEBUG] [ores.comms.messaging.message_dispatcher] Dispatching message type subscribe_request (0x10)
2025-12-13 01:14:35.108811 [WARN] [ores.comms.service.auth_session_service] Authorization failed for subscribe_request (0x10) from 127.0.0.1:45498: not authenticated
2025-12-13 01:14:35.108842 [WARN] [ores.comms.messaging.message_dispatcher] Authorization denied for subscribe_request (0x10) from 127.0.0.1:45498
2025-12-13 01:14:35.108875 [ERROR] [ores.comms.net.server_session] Message dispatch failed: 10
#+end_src

*** Unsubscribe before logout                                          :code:

On logout we see the following:

#+begin_src logview
2025-12-11 22:45:54.559906 [INFO] [ores.accounts.messaging.accounts_message_handler] Successfully logged out account: 019a5e49-476c-70ce-9909-3887cae700e9
2025-12-11 22:45:54.559940 [DEBUG] [ores.comms.messaging.message_dispatcher] Successfully dispatched message, response type logout_response (0x200e) correlation_id=763
2025-12-11 22:45:54.559978 [DEBUG] [ores.comms.messaging.frame] Serialised frame logout_response (0x200e), size: 58
2025-12-11 22:45:54.560005 [DEBUG] [ores.comms.net.connection] Writing frame of size 58 type: logout_response (0x200e) sequence: 767
2025-12-11 22:45:54.560083 [DEBUG] [ores.comms.net.connection] Successfully wrote frame
2025-12-11 22:45:54.560113 [DEBUG] [ores.comms.net.session] Sent response for message type logout_request (0x200d)
2025-12-11 22:45:54.560137 [INFO] [ores.comms.net.session] Logout completed, closing connection
2025-12-11 22:45:54.560200 [ERROR] [ores.comms.net.session] Exception in notification writer: co_await: Operation canceled [system:125]
2025-12-11 22:45:54.560233 [DEBUG] [ores.comms.net.session] Notification writer coroutine ended
2025-12-11 22:45:54.560281 [INFO] [ores.comms.net.session] Unregistering session '127.0.0.1:38366' from subscription manager
#+end_src

We should probably unsubscribe before we logout.

*** Use events in comms and accounts                                   :code:

Now we have an event bus, we should create events for:

- connect, disconnect, retry
- login, logout

*** Data in login info looks spurious                                  :code:

We see stuff like this:

#+begin_src
oresdb=> select * from login_info;
              account_id              |     last_ip     | last_attempt_ip | failed_logins | locked |       last_login       | online
--------------------------------------+-----------------+-----------------+---------------+--------+------------------------+--------
 019a4439-be9e-798e-bf2f-927ca236f84c | 0.0.0.0         | 0.0.0.0         |             0 |      0 | 1969-12-31 23:00:00+01 |      0
 019a3ba6-bd11-709b-b93d-fea9403d3d39 | 127.0.0.1       | 127.0.0.1       |             0 |      0 | 2025-10-31 19:03:48+00 |      1
 019a4431-98f8-79ae-9fc8-f6a6e77a0490 | 192.168.1.100   | 192.168.1.100   |             0 |      0 | 2025-11-02 10:51:32+00 |      1
 019a4431-9a7d-7b3d-a1cb-b9e02d44c804 | 0.0.0.0         | 192.168.1.100   |             1 |      0 | 1969-12-31 23:00:00+01 |      0

#+end_src

Also, we need a login timestamp and a logout timestamp so we can measure session
duration.

*** Currencies displays when not connected                             :code:

At present we can display currencies even before we connect. This is probably ok
but we should at least state we are not connected. Alternatively it should be
disabled.

*** Add a delete all button which deletes all currencies               :code:

It is useful especially in test environments to be able to delete all entities
before a re-import.

Notes:

- purge button.


*** Add screen in qt to exit bootstrap mode                            :code:

As per claude:

The create_initial_admin_request message type serves several important purposes
that differentiate it from the CLI and REPL approaches:

Why We Need create_initial_admin_request

  1. Network-accessible bootstrap flow
  - Allows remote initial setup from localhost without requiring shell/CLI access
  to the server
  - Enables a web-based "first-run" setup experience (like many web applications)
  - The Qt client can provide a proper UI for initial admin account creation

  2. Localhost-only security enforcement
  - The endpoint enforces that it can only be called from localhost (127.0.0.1 or
  ::1) at line
  projects/ores.accounts/src/messaging/accounts_message_handler.cpp:320
  - Provides network-accessible bootstrap with security guarantees
  - Prevents remote bootstrap attacks

  3. Atomic mode transition
  - The endpoint both creates the admin AND exits bootstrap mode in a single atomic
   operation (lines 362-367 in accounts_message_handler.cpp)
  - Guarantees consistency - can't create admin without exiting bootstrap mode

  4. Service-layer validation
  - Goes through full service layer with password validation and business logic
  - The CLI is essentially an "administrative backdoor" that bypasses the service
  layer and writes directly to the database

  5. Protocol-compliant workflow
  - Clients speaking the binary protocol need a proper bootstrap endpoint
  - REPL create_account_request is blocked in bootstrap mode (by enforcement logic)
  - create_initial_admin_request is the only endpoint that works in bootstrap mode

  The Distinction

  - CLI approach: Administrative backdoor, direct database access, bypasses all
  service logic
  - create_initial_admin_request: Proper network-accessible bootstrap flow with
  localhost restriction and atomic mode transition
  - REPL create_account_request: Normal account creation, blocked in bootstrap mode

  The create_initial_admin_request enables a proper "first-run experience" for
  clients connecting via the network protocol, while maintaining security through
  localhost-only access.

* Footer

| Previous: [[id:154212FF-BB02-8D84-1E33-9338B458380A][Version Zero]] |
